
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Subduction Zone Benchmark &#8212; FEniCSx Subduction</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/SubductionBenchmark';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Poisson Example 2D" href="Poisson2D.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="May 30, 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">FEniCSx Subduction</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    FEniCSx Subduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../readme.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Background</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Poisson1D.html">Poisson Example 1D</a></li>
<li class="toctree-l1"><a class="reference internal" href="Poisson2D.html">Poisson Example 2D</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Subduction</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Subduction Zone Benchmark</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/cianwilson/fenicsx_subduction/main?urlpath=lab/tree/./notebooks/SubductionBenchmark.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/cianwilson/fenicsx_subduction" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cianwilson/fenicsx_subduction/edit/main/./notebooks/SubductionBenchmark.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cianwilson/fenicsx_subduction/issues/new?title=Issue%20on%20page%20%2Fnotebooks/SubductionBenchmark.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/SubductionBenchmark.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Subduction Zone Benchmark</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble">Preamble</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#describing-the-geometry">Describing the geometry</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#slab-geometry">Slab geometry</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#subduction-zone-geometry">Subduction zone geometry</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kinematic-slab-model">Kinematic slab model</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="subduction-zone-benchmark">
<h1>Subduction Zone Benchmark<a class="headerlink" href="#subduction-zone-benchmark" title="Link to this heading">#</a></h1>
<p>Intro to benchmark…</p>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h2>
<section id="preamble">
<h3>Preamble<a class="headerlink" href="#preamble" title="Link to this heading">#</a></h3>
<p>Let’s start by adding the path to the modules in the <code class="docutils literal notranslate"><span class="pre">python</span></code> folder to the system path.  Also set the filename for the default parameters in the <code class="docutils literal notranslate"><span class="pre">data</span></code> directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">))</span>
<span class="n">params_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;default_params.json&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then let’s load all the required modules at the beginning.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geometry</span> <span class="k">as</span> <span class="nn">geo</span>
<span class="kn">import</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">import</span> <span class="nn">dolfinx</span> <span class="k">as</span> <span class="nn">df</span>
<span class="kn">import</span> <span class="nn">dolfinx.fem.petsc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">import</span> <span class="nn">basix.ufl</span> <span class="k">as</span> <span class="nn">bu</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">copy</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can load the <code class="docutils literal notranslate"><span class="pre">default_params</span></code> dictionary from file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">params_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">default_params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This contains default parameters required to define the geometry.  Keys ending in <code class="docutils literal notranslate"><span class="pre">_sid</span></code> and <code class="docutils literal notranslate"><span class="pre">_rid</span></code> are surface and region IDs respectively that we use to identify boundaries and regions of the mesh (these are unlikely to need to be changed).  <code class="docutils literal notranslate"><span class="pre">*_res_fact</span></code> are resolution factors scaled by a factor to set the resolution at various points in the mesh.  Finally, those ending in <code class="docutils literal notranslate"><span class="pre">_depth</span></code> are depths (in km) of various important points along the slab surface or boundaries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;35}</span><span class="s2"> </span><span class="si">{:&lt;10}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Key&#39;</span><span class="p">,</span><span class="s1">&#39;Value&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">45</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">default_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;35}</span><span class="s2"> </span><span class="si">{:&lt;10}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Key                                 Value     
---------------------------------------------
slab_sid                            1         
slab_side_sid                       2         
wedge_side_sid                      3         
upper_wedge_side_sid                4         
lc_side_sid                         5         
uc_side_sid                         6         
slab_base_sid                       7         
wedge_base_sid                      8         
lc_base_sid                         9         
uc_base_sid                         10        
coast_sid                           11        
top_sid                             12        
fault_sid                           13        
slab_diag_sid                       14        
slab_rid                            1         
wedge_rid                           2         
lc_rid                              3         
uc_rid                              4         
wedge_diag_rid                      5         
slab_det_depth                      100.0     
partial_coupling_depth              80.0      
full_coupling_depth                 82.5      
slab_diag1_depth                    70.0      
slab_diag2_depth                    120.0     
partial_coupling_depth_res_fact     1.0       
full_coupling_depth_res_fact        1.0       
io_depth_res_fact                   4.0       
coast_res_fact                      1.0       
lc_side_res_fact                    2.0       
lc_slab_res_fact                    1.0       
slab_side_base_res_fact             8.0       
uc_side_res_fact                    2.0       
uc_slab_res_fact                    1.0       
wedge_side_top_res_fact             4.0       
wedge_side_base_res_fact            4.0       
slab_diag1_res_fact                 1.0       
slab_diag2_res_fact                 1.0       
</pre></div>
</div>
</div>
</div>
</section>
<section id="describing-the-geometry">
<h3>Describing the geometry<a class="headerlink" href="#describing-the-geometry" title="Link to this heading">#</a></h3>
<p>Even in the simplified benchmark case, the geometry of a subduction zone is more complicated than any of the inbuilt meshes provided to us by dolfinx.  In kinematic slab models we need to describe the slab and the surrounding domain around it, including crustal layers and surface features.  We are particularly interested in the dynamics near the mantle wedge corner in the sub-arc region so will likely want to employ variable resolutions, with refined cells in this area.  Luckily, finite elements excel at describing these more complicated, variable resolution geometries using unstructured meshes.  We will start by describing the slab geometry.</p>
<section id="slab-geometry">
<h4>Slab geometry<a class="headerlink" href="#slab-geometry" title="Link to this heading">#</a></h4>
<p>In kinematic slab models the slab is typically described using a small number of points derived from seismic data which are then fitted with a spline to interpolate and extrapolate the geometry to other depths.  We will use a cubic spline provided by the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.CubicSpline.html">scipy</a> module and wrapped for convenience in our own <code class="docutils literal notranslate"><span class="pre">geometry.py</span></code> python module.  We need to provide the points describing the spline, some information about the resolution we desire in the mesh at various points along the spline, and information about some points that we require to be included in the spline.  The most important of these are the partial and full coupling depths (<code class="docutils literal notranslate"><span class="pre">partial_coupling_depth</span></code> and <code class="docutils literal notranslate"><span class="pre">full_coupling_depth</span></code> in <code class="docutils literal notranslate"><span class="pre">default_params</span></code> respectively), which will later be used as the locations where the slab becomes fully coupled to the mantle wedge.  These parameters are key in determining the subduction zone thermal structure.  We also include a point at <code class="docutils literal notranslate"><span class="pre">slab_det_depth</span></code> that we use to extract diagnostic information.</p>
<p>We set up the slab using the function <code class="docutils literal notranslate"><span class="pre">create_slab</span></code> below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_slab</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">resscale</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">,</span> 
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to construct and return a spline object that is used to describe a subducting slab</span>
<span class="sd">    in a kinematic-slab model of a subduction zone.  Optional keyword arguments default to parameters </span>
<span class="sd">    in the global default_params dictionary if not specified.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">      * xs             - list of x points in slab spline</span>
<span class="sd">      * ys             - list of y points in slab spline (must be the same length as xs)</span>
<span class="sd">      * resscale       - resolution scale factor that multiplies all _res_fact parameters</span>
<span class="sd">      * lc_depth       - depth of lower crustal boundary (&quot;Moho&quot;)</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">     distances:</span>
<span class="sd">      * slab_diag1_depth - starting depth of slab diagnostic region</span>
<span class="sd">      * slab_diag2_depth - end depth of slab diagnostic region</span>
<span class="sd">      * partial_coupling_depth - partial coupling depth on slab</span>
<span class="sd">      * full_coupling_depth    - full coupling depth on slab</span>
<span class="sd">      * slab_det_depth         - detector depth on slab</span>

<span class="sd">     resolutions factors (that get multiplied by the resscale to get the resolutions):</span>
<span class="sd">      * slab_diag1_res_fact             - start of slab diagnostic region</span>
<span class="sd">      * slab_diag2_res_fact             - end of slab diagnostic region</span>
<span class="sd">      * partial_coupling_depth_res_fact - partial coupling depth on slab</span>
<span class="sd">      * full_coupling_depth_res_fact    - full coupling depth on slab</span>

<span class="sd">     surface ids:</span>
<span class="sd">      * fault_sid            - fault</span>
<span class="sd">      * slab_sid             - default slab surface id</span>
<span class="sd">      * slab_diag_sid        - diagnostic region of slab</span>

<span class="sd">    Returns:</span>
<span class="sd">      * slab - subduction zone slab spline instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># get input parameters</span>
    <span class="c1"># depths</span>
    <span class="n">slab_diag1_depth</span>       <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag1_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag1_depth&#39;</span><span class="p">])</span>
    <span class="n">slab_diag2_depth</span>       <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag2_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag2_depth&#39;</span><span class="p">])</span>
    <span class="n">partial_coupling_depth</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;partial_coupling_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;partial_coupling_depth&#39;</span><span class="p">])</span>
    <span class="n">full_coupling_depth</span>    <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full_coupling_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;full_coupling_depth&#39;</span><span class="p">])</span>
    <span class="n">slab_det_depth</span>         <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_det_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_det_depth&#39;</span><span class="p">])</span>
    
    <span class="c1"># resolutions</span>
    <span class="n">slab_diag1_res</span>             <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag1_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag1_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">slab_diag2_res</span>             <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag2_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag2_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">partial_coupling_depth_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;partial_coupling_depth_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;partial_coupling_depth_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">full_coupling_depth_res</span>    <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full_coupling_depth_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;full_coupling_depth_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>

    <span class="c1"># surface ids</span>
    <span class="n">fault_sid</span>      <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fault_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;fault_sid&#39;</span><span class="p">])</span>
    <span class="n">slab_sid</span>       <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_sid&#39;</span><span class="p">])</span>
    <span class="n">slab_diag_sid</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag_sid&#39;</span><span class="p">])</span>
       
    <span class="c1"># set up resolutions along the slab depending on depth</span>
    <span class="c1"># high resolution at shallow depths, lower resolution below the &quot;diagnostic&quot;</span>
    <span class="c1"># region required in the benchmark case</span>
    <span class="c1"># FIXME: these are currently hard-coded relative to the resolutions specified at the partial and full coupling</span>
    <span class="c1"># depths for simplicity but could be separate parameters</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">partial_coupling_depth_res</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">slab_diag2_depth</span> <span class="k">else</span> <span class="mi">3</span><span class="o">*</span><span class="n">full_coupling_depth_res</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">]</span>
    
    <span class="c1"># set up the surface ids for the slab depending on depth</span>
    <span class="c1"># above the &quot;Moho&quot; use fault_sid</span>
    <span class="c1"># in the diagnostic region use the slab_diag_sid</span>
    <span class="c1"># everywhere else use the default slab_sid</span>
    <span class="n">sids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">lc_depth</span><span class="p">:</span> 
            <span class="n">sid</span> <span class="o">=</span> <span class="n">fault_sid</span>
        <span class="k">elif</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">slab_diag1_depth</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">slab_sid</span>
        <span class="k">elif</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">slab_diag2_depth</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">slab_diag_sid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">slab_sid</span>
        <span class="n">sids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
    
    <span class="c1"># set up the slab spline object</span>
    <span class="n">slab</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">SlabSpline</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="n">sids</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Slab&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">full_coupling_depth</span> <span class="o">&gt;</span> <span class="n">partial_coupling_depth</span>
    <span class="c1"># adding the coupling depths may or may not be necessary</span>
    <span class="c1"># depending on if they were included in the slab spline data already or not</span>
    <span class="c1"># the slab class should ignore them if they aren&#39;t necessary</span>
    <span class="n">slab</span><span class="o">.</span><span class="n">addpoint</span><span class="p">(</span><span class="n">partial_coupling_depth</span><span class="p">,</span> <span class="s2">&quot;Slab::PartialCouplingDepth&quot;</span><span class="p">,</span> 
                  <span class="n">res</span><span class="o">=</span><span class="n">partial_coupling_depth_res</span><span class="p">,</span> 
                  <span class="n">sid</span><span class="o">=</span><span class="n">slab_diag_sid</span><span class="p">)</span>
    <span class="n">slab</span><span class="o">.</span><span class="n">addpoint</span><span class="p">(</span><span class="n">full_coupling_depth</span><span class="p">,</span> <span class="s2">&quot;Slab::FullCouplingDepth&quot;</span><span class="p">,</span> 
                  <span class="n">res</span><span class="o">=</span><span class="n">full_coupling_depth_res</span><span class="p">,</span> 
                  <span class="n">sid</span><span class="o">=</span><span class="n">slab_diag_sid</span><span class="p">)</span>
    <span class="c1"># add the slab detector point</span>
    <span class="n">slab</span><span class="o">.</span><span class="n">addpoint</span><span class="p">(</span><span class="n">slab_det_depth</span><span class="p">,</span> <span class="s2">&quot;Slab::DetectorPoint&quot;</span><span class="p">,</span> 
                  <span class="n">res</span><span class="o">=</span><span class="n">full_coupling_depth_res</span><span class="p">,</span>
                  <span class="n">sid</span><span class="o">=</span><span class="n">slab_diag_sid</span><span class="p">)</span>

    <span class="c1"># and return it</span>
    <span class="k">return</span> <span class="n">slab</span>
</pre></div>
</div>
</div>
</div>
<p>Describing the slab geometry only takes a few non-default parameters, which are relatively simple in the benchmark geometry.</p>
<p>Although the resolution of our mesh is going to vary across the domain we will use a resolution scale factor <code class="docutils literal notranslate"><span class="pre">resscale</span></code> to scale the resolution globally, while different points in the domain retain the same default relative resolutions.  So a large <code class="docutils literal notranslate"><span class="pre">resscale</span></code> means low resolution and a small <code class="docutils literal notranslate"><span class="pre">resscale</span></code> means high resolution.</p>
<div class="admonition-computational-cost admonition">
<p class="admonition-title">Computational cost</p>
<p>Setting the <code class="docutils literal notranslate"><span class="pre">resscale</span></code> too low will result in a computationally expensive simulation, especially in the non-linear case, that may need to be run locally rather than remotely.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resscale</span> <span class="o">=</span> <span class="mf">5.0</span>
</pre></div>
</div>
</div>
</div>
<p>The benchmark slab geometry is rather simple, just consisting of a straight line with 2:1 horizontal distance to depth ratio, extending to 200km depth.  We can therefore just provide the spline with a series of linearly related points <code class="docutils literal notranslate"><span class="pre">xs</span></code> and <code class="docutils literal notranslate"><span class="pre">ys</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># points in slab (just linear)</span>
<span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">140.0</span><span class="p">,</span> <span class="mf">240.0</span><span class="p">,</span> <span class="mf">400.0</span><span class="p">]</span>
<span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">70.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">120.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">200.0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>To get the surface ids on the slab correct we also have to provide the lower crustal depth <code class="docutils literal notranslate"><span class="pre">lc_depth</span></code>.  As this is a case dependent parameter it is not provided in <code class="docutils literal notranslate"><span class="pre">default_params</span></code>.  For the benchmark cases it is at 40km depth.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lc_depth</span> <span class="o">=</span> <span class="mi">40</span>
</pre></div>
</div>
</div>
</div>
<p>Providing these parameters we can create our slab geometry.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slab</span> <span class="o">=</span> <span class="n">create_slab</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">resscale</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can double check that it looks as expected by plotting the slab, though in the benchmark case this is not very interesting!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interpx</span> <span class="o">=</span> <span class="p">[</span><span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">curve</span> <span class="ow">in</span> <span class="n">slab</span><span class="o">.</span><span class="n">interpcurves</span><span class="p">]</span>
<span class="n">interpy</span> <span class="o">=</span> <span class="p">[</span><span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">curve</span> <span class="ow">in</span> <span class="n">slab</span><span class="o">.</span><span class="n">interpcurves</span><span class="p">]</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interpx</span><span class="p">,</span> <span class="n">interpy</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (km)&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y (km)&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Slab Geometry&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/540416a037d489917cc98573a12f5c04d5dbfe4eb057ea58bd7784a359b292f5.png" src="../_images/540416a037d489917cc98573a12f5c04d5dbfe4eb057ea58bd7784a359b292f5.png" />
</div>
</div>
<p>With the slab geometry in hand we can move onto defining the rest of the geometry.</p>
</section>
<section id="subduction-zone-geometry">
<h4>Subduction zone geometry<a class="headerlink" href="#subduction-zone-geometry" title="Link to this heading">#</a></h4>
<p>To describe the subduction zone geometry we need to build a two-dimensional domain around the slab spline.  In the simplest case this is simply a rectangle around the spline but more generally will include a sloping coastline, a crust and potentially an upper crust if the slab is subducting beneath a continent.  As with the spline we will also include certain important points in the domain and extra boundaries (lines) demarking special diagnostic regions of interest in the model.  Also as with the spline we use a python class implemented in our own <code class="docutils literal notranslate"><span class="pre">geometry.py</span></code> module to do most of the work.</p>
<p>In the following function we use the <code class="docutils literal notranslate"><span class="pre">slab</span></code> object we instantiated above to provide the bounds and set up a base <code class="docutils literal notranslate"><span class="pre">SubductionGeometry</span></code> object, which will essentially describe the bounding domain with a sloping coastline if <code class="docutils literal notranslate"><span class="pre">coast_distance</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>.  The domain can also be set up to overshoot the lowermost end of the slab spline using the <code class="docutils literal notranslate"><span class="pre">extra_width</span></code> parameter.  Crustal layers will then be added to the domain, controlled by the <code class="docutils literal notranslate"><span class="pre">lc_depth</span></code>, <code class="docutils literal notranslate"><span class="pre">uc_depth</span></code> and <code class="docutils literal notranslate"><span class="pre">sztype</span></code> parameters (with the latter controlling how many layers are added).  The approximate point where the flow into and out of the wedge changes direction is included in the domain as specified by <code class="docutils literal notranslate"><span class="pre">io_depth</span></code>.  Finally, we subdivide the wedge into a “diagnostic” region where certain benchmark values can be easily calculated.  And, once again we use the same <code class="docutils literal notranslate"><span class="pre">resscale</span></code> parameter to scale the global resolution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_sz_geometry</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> <span class="n">resscale</span><span class="p">,</span> <span class="n">sztype</span><span class="p">,</span> <span class="n">io_depth</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">,</span> 
                       <span class="n">coast_distance</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">,</span> <span class="n">uc_depth</span><span class="p">,</span> 
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to construct and return a subduction zone geometry object that is used to generate</span>
<span class="sd">    a mesh of a subduction zone.  Optional keyword arguments default to parameters in the global </span>
<span class="sd">    default_params dictionary if not specified.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">      * slab           - an instance of a slab spline object</span>
<span class="sd">      * resscale       - resolution scale factor that multiplies all _res_fact parameters</span>
<span class="sd">      * sztype         - either &#39;continental&#39; or &#39;oceanic&#39;, which determines if an upper crust is included</span>
<span class="sd">      * io_depth       - prescribed input/output depth on wedge side</span>
<span class="sd">      * extra_width    - extra width at the base of the domain</span>
<span class="sd">      * coast_distance - distance from trench to coast</span>
<span class="sd">      * lc_depth       - depth of lower crustal boundary (&quot;Moho&quot;)</span>
<span class="sd">      * uc_depth       - depth of upper crustal boundary</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">     distances:</span>
<span class="sd">      * slab_diag1_depth - starting depth along slab of slab diagnostic region</span>
<span class="sd">      * slab_diag2_depth - end depth along slab of slab diagnostic region</span>

<span class="sd">     resolutions factors (that get multiplied by the resscale to get the resolutions):</span>
<span class="sd">      * io_depth_res_fact        - input/output depth</span>
<span class="sd">      * coast_res_fact           - coastal point on top</span>
<span class="sd">      * lc_slab_res_fact         - lower crust slab intersection</span>
<span class="sd">      * lc_side_res_fact         - lower crust side intersection</span>
<span class="sd">      * uc_slab_res_fact         - upper crust slab intersection</span>
<span class="sd">      * uc_side_res_fact         - upper crust side intersection</span>
<span class="sd">      * slab_diag1_res_fact      - start of slab diagnostic region</span>
<span class="sd">      * slab_diag2_res_fact      - end of slab diagnostic region</span>
<span class="sd">      * wedge_side_top_res_fact  - top of the wedge side</span>
<span class="sd">      * wedge_side_base_res_fact - base of the wedge side</span>
<span class="sd">      * slab_side_base_res_fact  - base of the slab side</span>

<span class="sd">     surface ids:</span>
<span class="sd">      * coast_sid            - coastal slope</span>
<span class="sd">      * top_sid              - top of domain</span>
<span class="sd">      * fault_sid            - fault</span>
<span class="sd">      * lc_side_sid          - side of lower crust</span>
<span class="sd">      * lc_base_sid          - base of lower crust</span>
<span class="sd">      * uc_side_sid          - side of upper crust</span>
<span class="sd">      * uc_base_sid          - base of upper crust</span>
<span class="sd">      * slab_sid             - default slab surface id</span>
<span class="sd">      * slab_diag_sid        - diagnostic region of slab</span>
<span class="sd">      * slab_side_sid        - side of slab</span>
<span class="sd">      * wedge_side_sid       - side of wedge</span>
<span class="sd">      * upper_wedge_side_sid - side of upper wedge</span>
<span class="sd">      * slab_base_sid        - base of slab</span>
<span class="sd">      * wedge_base_sid       - base of wedge</span>

<span class="sd">     region ids:</span>
<span class="sd">      * slab_rid       - slab</span>
<span class="sd">      * wedge_rid      - wedge</span>
<span class="sd">      * lc_rid         - lower crust</span>
<span class="sd">      * uc_rid         - upper crust</span>
<span class="sd">      * wedge_diag_rid - wedge diagnostic region</span>

<span class="sd">    Returns:</span>
<span class="sd">      * geom - subduction zone geometry class instance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get input parameters</span>
    <span class="c1"># depths</span>
    <span class="n">slab_diag1_depth</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag1_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag1_depth&#39;</span><span class="p">])</span>
    <span class="n">slab_diag2_depth</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag2_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag2_depth&#39;</span><span class="p">])</span>
    
    <span class="c1"># resolutions</span>
    <span class="n">io_depth_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;io_depth_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;io_depth_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">coast_res</span>   <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coast_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;coast_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">lc_slab_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lc_slab_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;lc_slab_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">lc_side_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lc_side_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;lc_side_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">uc_slab_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uc_slab_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;uc_slab_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">uc_side_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uc_side_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;uc_side_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">slab_diag1_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag1_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag1_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">slab_diag2_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag2_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag2_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">wedge_side_top_res</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wedge_side_top_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;wedge_side_top_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">wedge_side_base_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wedge_side_base_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;wedge_side_base_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">slab_side_base_res</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_side_base_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_side_base_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>

    <span class="c1"># surface ids</span>
    <span class="n">coast_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coast_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;coast_sid&#39;</span><span class="p">])</span>
    <span class="n">top_sid</span>   <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;top_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;top_sid&#39;</span><span class="p">])</span>
    <span class="n">fault_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fault_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;fault_sid&#39;</span><span class="p">])</span>
    <span class="n">lc_side_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lc_side_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;lc_side_sid&#39;</span><span class="p">])</span>
    <span class="n">lc_base_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lc_base_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;lc_base_sid&#39;</span><span class="p">])</span>
    <span class="n">uc_side_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uc_side_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;uc_side_sid&#39;</span><span class="p">])</span>
    <span class="n">uc_base_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uc_base_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;uc_base_sid&#39;</span><span class="p">])</span>
    <span class="n">slab_sid</span>    <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_sid&#39;</span><span class="p">])</span>
    <span class="n">slab_diag_sid</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag_sid&#39;</span><span class="p">])</span>
    <span class="n">slab_side_sid</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_side_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_side_sid&#39;</span><span class="p">])</span>
    <span class="n">wedge_side_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wedge_side_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;wedge_side_sid&#39;</span><span class="p">])</span>
    <span class="n">slab_base_sid</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_base_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_base_sid&#39;</span><span class="p">])</span>
    <span class="n">wedge_base_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wedge_base_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;wedge_base_sid&#39;</span><span class="p">])</span>
    <span class="n">upper_wedge_side_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upper_wedge_side_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;upper_wedge_side_sid&#39;</span><span class="p">])</span>
    
    <span class="c1"># region ids</span>
    <span class="n">slab_rid</span>       <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_rid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_rid&#39;</span><span class="p">])</span>
    <span class="n">wedge_rid</span>      <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wedge_rid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;wedge_rid&#39;</span><span class="p">])</span>
    <span class="n">lc_rid</span>         <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lc_rid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;lc_rid&#39;</span><span class="p">])</span>
    <span class="n">uc_rid</span>         <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uc_rid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;uc_rid&#39;</span><span class="p">])</span>
    <span class="n">wedge_diag_rid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wedge_diag_rid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;wedge_diag_rid&#39;</span><span class="p">])</span>
    
    <span class="k">assert</span> <span class="n">sztype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;continental&#39;</span><span class="p">,</span> <span class="s1">&#39;oceanic&#39;</span><span class="p">]</span>
    

    <span class="c1"># pass the slab object into the SubductionGeometry class to construct the geometry</span>
    <span class="c1"># around it</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">SubductionGeometry</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> 
                                  <span class="n">coast_distance</span><span class="o">=</span><span class="n">coast_distance</span><span class="p">,</span> 
                                  <span class="n">extra_width</span><span class="o">=</span><span class="n">extra_width</span><span class="p">,</span> 
                                  <span class="n">slab_side_sid</span><span class="o">=</span><span class="n">slab_side_sid</span><span class="p">,</span> 
                                  <span class="n">wedge_side_sid</span><span class="o">=</span><span class="n">wedge_side_sid</span><span class="p">,</span> 
                                  <span class="n">slab_base_sid</span><span class="o">=</span><span class="n">slab_base_sid</span><span class="p">,</span> 
                                  <span class="n">wedge_base_sid</span><span class="o">=</span><span class="n">wedge_base_sid</span><span class="p">,</span> 
                                  <span class="n">coast_sid</span><span class="o">=</span><span class="n">coast_sid</span><span class="p">,</span> 
                                  <span class="n">top_sid</span><span class="o">=</span><span class="n">top_sid</span><span class="p">,</span> 
                                  <span class="n">slab_rid</span><span class="o">=</span><span class="n">slab_rid</span><span class="p">,</span> 
                                  <span class="n">wedge_rid</span><span class="o">=</span><span class="n">wedge_rid</span><span class="p">,</span> 
                                  <span class="n">coast_res</span><span class="o">=</span><span class="n">coast_res</span><span class="p">,</span> 
                                  <span class="n">slab_side_base_res</span><span class="o">=</span><span class="n">slab_side_base_res</span><span class="p">,</span> 
                                  <span class="n">wedge_side_top_res</span><span class="o">=</span><span class="n">wedge_side_top_res</span><span class="p">,</span> 
                                  <span class="n">wedge_side_base_res</span><span class="o">=</span><span class="n">wedge_side_base_res</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sztype</span><span class="o">==</span><span class="s1">&#39;oceanic&#39;</span><span class="p">:</span>
        <span class="c1"># add a single crust layer</span>
        <span class="c1"># (using the lc parameters &amp; ignoring the uc ones)</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">addcrustlayer</span><span class="p">(</span><span class="n">lc_depth</span><span class="p">,</span> <span class="s2">&quot;Crust&quot;</span><span class="p">,</span>
                           <span class="n">sid</span><span class="o">=</span><span class="n">lc_base_sid</span><span class="p">,</span> <span class="n">rid</span><span class="o">=</span><span class="n">lc_ris</span><span class="p">,</span>
                           <span class="n">slab_res</span><span class="o">=</span><span class="n">lc_slab_res</span><span class="p">,</span>
                           <span class="n">side_res</span><span class="o">=</span><span class="n">lc_side_res</span><span class="p">,</span>
                           <span class="n">slab_sid</span><span class="o">=</span><span class="n">fault_sid</span><span class="p">,</span>
                           <span class="n">side_sid</span><span class="o">=</span><span class="n">lc_side_sid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># add a lower crust</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">addcrustlayer</span><span class="p">(</span><span class="n">lc_depth</span><span class="p">,</span> <span class="s2">&quot;Crust&quot;</span><span class="p">,</span> 
                           <span class="n">sid</span><span class="o">=</span><span class="n">lc_base_sid</span><span class="p">,</span> <span class="n">rid</span><span class="o">=</span><span class="n">lc_rid</span><span class="p">,</span>
                           <span class="n">slab_res</span><span class="o">=</span><span class="n">lc_slab_res</span><span class="p">,</span>
                           <span class="n">side_res</span><span class="o">=</span><span class="n">lc_side_res</span><span class="p">,</span>
                           <span class="n">slab_sid</span><span class="o">=</span><span class="n">fault_sid</span><span class="p">,</span>
                           <span class="n">side_sid</span><span class="o">=</span><span class="n">lc_side_sid</span><span class="p">)</span>
        
        <span class="c1"># add an upper crust</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">addcrustlayer</span><span class="p">(</span><span class="n">uc_depth</span><span class="p">,</span> <span class="s2">&quot;UpperCrust&quot;</span><span class="p">,</span> 
                           <span class="n">sid</span><span class="o">=</span><span class="n">uc_base_sid</span><span class="p">,</span> <span class="n">rid</span><span class="o">=</span><span class="n">uc_rid</span><span class="p">,</span>
                           <span class="n">slab_res</span><span class="o">=</span><span class="n">uc_slab_res</span><span class="p">,</span>
                           <span class="n">side_res</span><span class="o">=</span><span class="n">uc_side_res</span><span class="p">,</span>
                           <span class="n">slab_sid</span><span class="o">=</span><span class="n">fault_sid</span><span class="p">,</span>
                           <span class="n">side_sid</span><span class="o">=</span><span class="n">uc_side_sid</span><span class="p">)</span>
    
    <span class="c1"># add the pre-defined in-out point on the wedge side</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">addwedgesidepoint</span><span class="p">(</span><span class="n">io_depth</span><span class="p">,</span> <span class="s2">&quot;WedgeSide::InOut&quot;</span><span class="p">,</span> <span class="n">line_name</span><span class="o">=</span><span class="s2">&quot;UpperWedgeSide&quot;</span><span class="p">,</span> 
                           <span class="n">res</span><span class="o">=</span><span class="n">io_depth_res</span><span class="p">,</span> 
                           <span class="n">sid</span><span class="o">=</span><span class="n">upper_wedge_side_sid</span><span class="p">)</span>
    
    <span class="c1"># add wedge dividers for the diagnostics</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">addwedgedivider</span><span class="p">(</span><span class="n">slab_diag1_depth</span><span class="p">,</span> <span class="s2">&quot;ColdCorner&quot;</span><span class="p">,</span> 
                         <span class="n">slab_res</span><span class="o">=</span><span class="n">slab_diag2_res</span><span class="p">,</span> 
                         <span class="n">top_res</span><span class="o">=</span><span class="n">slab_diag2_res</span><span class="p">,</span>
                         <span class="n">rid</span><span class="o">=</span><span class="n">wedge_rid</span><span class="p">,</span> 
                         <span class="n">slab_sid</span><span class="o">=</span><span class="n">slab_sid</span><span class="p">)</span>
    
    <span class="c1"># add wedge dividers for the diagnostics</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">addwedgedivider</span><span class="p">(</span><span class="n">slab_diag2_depth</span><span class="p">,</span> <span class="s2">&quot;WedgeFocused&quot;</span><span class="p">,</span> 
                         <span class="n">slab_res</span><span class="o">=</span><span class="n">slab_diag1_res</span><span class="p">,</span> 
                         <span class="n">top_res</span><span class="o">=</span><span class="n">slab_diag1_res</span><span class="p">,</span>
                         <span class="n">rid</span><span class="o">=</span><span class="n">wedge_diag_rid</span><span class="p">,</span> 
                         <span class="n">slab_sid</span><span class="o">=</span><span class="n">slab_diag_sid</span><span class="p">)</span>

    <span class="c1"># return the geometry object</span>
    <span class="k">return</span> <span class="n">geom</span>
</pre></div>
</div>
</div>
</div>
<p>For the benchmark cases we do not include a coastline or any extra width beyond the slab so <code class="docutils literal notranslate"><span class="pre">coast_distance</span> <span class="pre">=</span> <span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">extra_width</span> <span class="pre">=</span> <span class="pre">0</span></code>.  The subduction zone “type” is continental (<code class="docutils literal notranslate"><span class="pre">sztype</span> <span class="pre">=</span> <span class="pre">&quot;continental&quot;</span></code>), which means we need to set an upper crustal depth, which in the benchmark is 40km, <code class="docutils literal notranslate"><span class="pre">uc_depth</span> <span class="pre">=</span> <span class="pre">40</span></code>.  <code class="docutils literal notranslate"><span class="pre">lc_depth</span></code> was already set when describing the slab.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coast_distance</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">extra_width</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">uc_depth</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">sztype</span> <span class="o">=</span> <span class="s1">&#39;continental&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>The input/output depth varies between the isoviscous (case 1) and nonlinear (case 2) benchmarks. We choose the value from case 1 here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">io_depth_1</span> <span class="o">=</span> <span class="mi">139</span>
</pre></div>
</div>
</div>
</div>
<p>Leaving all other parameters as their default values we can now instantiate a subduction zone geometry object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">geom</span> <span class="o">=</span> <span class="n">create_sz_geometry</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> <span class="n">resscale</span><span class="p">,</span> <span class="n">sztype</span><span class="p">,</span> <span class="n">io_depth_1</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">,</span> 
                          <span class="n">coast_distance</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">,</span> <span class="n">uc_depth</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And examine it to see if it looks correct.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">geom</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label_sids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_rids</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/63c495a3d3e8f1c04d44b053d66104161e4d448e36131681748ed5c5bb40592d.png" src="../_images/63c495a3d3e8f1c04d44b053d66104161e4d448e36131681748ed5c5bb40592d.png" />
</div>
</div>
<p>The finished geometry object can now be used to generate the mesh we will use to solve our numerical problem.  To do this we are using <a class="reference external" href="https://gmsh.info/">GMsh</a> in the background, which can generate a lot of output.</p>
<p>Once the mesh (<code class="docutils literal notranslate"><span class="pre">mesh</span></code>) and mesh tag objects (<code class="docutils literal notranslate"><span class="pre">cell_tags</span></code> and <code class="docutils literal notranslate"><span class="pre">facet_tags</span></code>) are generated we can visualize the resulting unstructured triangular mesh.</p>
<p>It’s also possible to output the geometry to file using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">geom</span><span class="o">.</span><span class="n">writegeofile</span><span class="p">(</span><span class="s1">&#39;&lt;file base name&gt;.geo_unrolled&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>With the geometry (and mesh!) in hand it’s possible to move onto describing the physical problem we want to solve.</p>
</section>
</section>
<section id="kinematic-slab-model">
<h3>Kinematic slab model<a class="headerlink" href="#kinematic-slab-model" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class describing a kinematic slab subduction zone thermal problem.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># geometry object</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># case specific</span>
    <span class="n">A</span>      <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># age of subducting slab (Myr)</span>
    <span class="n">Vs</span>     <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># slab speed (mm/yr)</span>
    <span class="n">sztype</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># type of sz (&#39;continental&#39; or &#39;oceanic&#39;)</span>
    <span class="n">Ac</span>     <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># age of over-riding plate (Myr) - oceanic only</span>
    <span class="n">As</span>     <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># age of subduction (Myr) - oceanic only</span>
    <span class="n">qs</span>     <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># surface heat flux (W/m^2) - continental only</span>
    
    <span class="c1"># non-dim parameters</span>
    <span class="n">Ts</span>      <span class="o">=</span> <span class="mf">0.0</span>       <span class="c1"># surface temperature (non-dim, also deg C)</span>
    <span class="n">Tm</span>      <span class="o">=</span> <span class="mf">1350.0</span>    <span class="c1"># mantle temperature (non-dim, also deg C)</span>
    <span class="n">kc</span>      <span class="o">=</span> <span class="mf">0.8064516</span> <span class="c1"># crustal thermal conductivity (non-dim)</span>
    <span class="n">km</span>      <span class="o">=</span> <span class="mf">1.0</span>       <span class="c1"># mantle thermal conductivity (non-dim)</span>
    <span class="n">rhoc</span>    <span class="o">=</span> <span class="mf">0.8333333</span> <span class="c1"># crustal density (non-dim)</span>
    <span class="n">rhom</span>    <span class="o">=</span> <span class="mf">1.0</span>       <span class="c1"># mantle density (non-dim)</span>
    <span class="n">cp</span>      <span class="o">=</span> <span class="mf">1.0</span>       <span class="c1"># heat capacity (non-dim)</span>
    <span class="n">H1</span>      <span class="o">=</span> <span class="mf">0.419354</span>  <span class="c1"># upper crustal volumetric heat production (non-dim) </span>
    <span class="n">H2</span>      <span class="o">=</span> <span class="mf">0.087097</span>  <span class="c1"># lower crustal volumetric heat production (non-dim)</span>

    <span class="c1"># dislocation creep parameters</span>
    <span class="n">etamax</span> <span class="o">=</span> <span class="mf">1.0e25</span>    <span class="c1"># maximum viscosity (Pa s)</span>
    <span class="n">nsigma</span> <span class="o">=</span> <span class="mf">3.5</span>       <span class="c1"># stress viscosity power law exponent (non-dim)</span>
    <span class="n">Aeta</span>   <span class="o">=</span> <span class="mf">28968.6</span>   <span class="c1"># pre-exponential viscosity constant (Pa s^(1/n))</span>
    <span class="n">E</span>      <span class="o">=</span> <span class="mf">540.0e3</span>   <span class="c1"># viscosity activation energy (J/mol)</span>
    
    <span class="c1"># finite element degrees</span>
    <span class="n">p_p</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">p_T</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># only allow these options to be set from the update and __init__ functions</span>
    <span class="n">allowed_input_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;Vs&#39;</span><span class="p">,</span> <span class="s1">&#39;sztype&#39;</span><span class="p">,</span> <span class="s1">&#39;Ac&#39;</span><span class="p">,</span> <span class="s1">&#39;As&#39;</span><span class="p">,</span> <span class="s1">&#39;qs&#39;</span><span class="p">,</span> \
                                <span class="s1">&#39;Ts&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm&#39;</span><span class="p">,</span> <span class="s1">&#39;kc&#39;</span><span class="p">,</span> <span class="s1">&#39;km&#39;</span><span class="p">,</span> <span class="s1">&#39;rhoc&#39;</span><span class="p">,</span> <span class="s1">&#39;rhom&#39;</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span><span class="p">,</span> \
                                <span class="s1">&#39;etamax&#39;</span><span class="p">,</span> <span class="s1">&#39;nsigma&#39;</span><span class="p">,</span> <span class="s1">&#39;Aeta&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> \
                                <span class="s1">&#39;p_p&#39;</span><span class="p">,</span> <span class="s1">&#39;p_T&#39;</span><span class="p">]</span>

    <span class="n">required_parameters</span>     <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;Vs&#39;</span><span class="p">,</span> <span class="s1">&#39;sztype&#39;</span><span class="p">]</span>
    <span class="n">required_if_continental</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;qs&#39;</span><span class="p">]</span>
    <span class="n">required_if_oceanic</span>     <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ac&#39;</span><span class="p">,</span> <span class="s1">&#39;As&#39;</span><span class="p">]</span>

    <span class="c1"># reference values</span>
    <span class="n">k0</span>     <span class="o">=</span> <span class="mf">3.1</span>       <span class="c1"># reference thermal conductivity (W/m/K)</span>
    <span class="n">rho0</span>   <span class="o">=</span> <span class="mf">3300.0</span>    <span class="c1"># reference density (kg/m^3)</span>
    <span class="n">cp0</span>    <span class="o">=</span> <span class="mf">1250.0</span>    <span class="c1"># reference heat capacity (J/kg/K)</span>
    <span class="n">h0</span>     <span class="o">=</span> <span class="mf">1000.0</span>    <span class="c1"># reference length scale (m)</span>
    <span class="n">eta0</span>   <span class="o">=</span> <span class="mf">1.0e21</span>    <span class="c1"># reference viscosity (Pa s)</span>
    <span class="n">T0</span>     <span class="o">=</span> <span class="mf">1.0</span>       <span class="c1"># reference temperature (K)</span>
    <span class="n">R</span>      <span class="o">=</span> <span class="mf">8.3145</span>    <span class="c1"># gas constant (J/mol/K)</span>

    <span class="c1"># derived reference values</span>
    <span class="n">kappa0</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference thermal diffusivity (m^2/s)</span>
    <span class="n">v0</span>     <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference velocity (m/s)</span>
    <span class="n">e0</span>     <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference strain rate (/s)</span>
    <span class="n">p0</span>     <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference pressure (Pa)</span>
    <span class="n">H0</span>     <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference heat source (W/m^3)</span>
    <span class="n">q0</span>     <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference heat flux (W/m^2)</span>
    
    <span class="c1"># derived parameters</span>
    <span class="n">A_si</span>   <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># age of subducting slab (s)</span>
    <span class="n">Vs_nd</span>  <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># slab speed (non-dim)</span>
    <span class="n">Ac_si</span>  <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># age of over-riding plate (s) - oceanic only</span>
    <span class="n">As_si</span>  <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># age of subduction (s) - oceanic only</span>
    <span class="n">qs_nd</span>  <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># surface heat flux (non-dim) - continental only</span>

    <span class="c1"># from geometry</span>
    <span class="n">deltaztrench</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">deltaxcoast</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">deltazuc</span>     <span class="o">=</span> <span class="kc">None</span>
    <span class="n">deltazc</span>      <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># mesh related</span>
    <span class="n">mesh</span>       <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cell_tags</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">facet_tags</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">gdim</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tdim</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fdim</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">num_cells</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># integral measures</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dS</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># region ids</span>
    <span class="n">wedge_rids</span>       <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_rids</span>        <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crust_rids</span>       <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># wedge submesh</span>
    <span class="n">wedge_submesh</span>    <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_cell_tags</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_facet_tags</span> <span class="o">=</span> <span class="kc">None</span> 
    <span class="n">wedge_cell_map</span>   <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_reverse_cell_map</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># slab submesh</span>
    <span class="n">slab_submesh</span>    <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_cell_tags</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_facet_tags</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_cell_map</span>   <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_reverse_cell_map</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># functionspaces</span>
    <span class="n">Vslab_vp</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Vslab_v</span>   <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Vwedge_vp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Vwedge_v</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">V_T</span>       <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># functions</span>
    <span class="n">slab_vps_i</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_vpw_i</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">T_i</span>         <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># functions that need interpolation</span>
    <span class="n">vs_i</span>      <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ps_i</span>      <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vw_i</span>      <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pw_i</span>      <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_T_i</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_T_i</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># sub (split) functions</span>
    <span class="n">slab_vs_i</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_ps_i</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_vw_i</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_pw_i</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># test functions</span>
    <span class="n">slab_vps_t</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_vw_i</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">T_t</span>        <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># trial functions</span>
    <span class="n">slab_vps_a</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_vpw_a</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">T_a</span>         <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># boundary conditions</span>
    <span class="n">bcs_T</span>   <span class="o">=</span> <span class="kc">None</span> <span class="c1"># temperature</span>
    <span class="n">bcs_vpw</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># wedge velocity/pressure</span>
    <span class="n">bcs_vps</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># slab velocity/pressure</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setup_meshes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the mesh from the supplied geometry then extract submeshes representing</span>
<span class="sd">        the wedge and slab for the Stokes problems in these regions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check we have a geometry object attached</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># generate the mesh using gmsh</span>
        <span class="c1"># this command also returns cell and facets tags identifying regions and boundaries in the mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">generatemesh</span><span class="p">()</span>

        <span class="c1"># record the dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdim</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dS</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;dS&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="p">)</span>

        <span class="c1"># get the number of cells</span>
        <span class="n">cell_imap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">index_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells</span> <span class="o">=</span> <span class="n">cell_imap</span><span class="o">.</span><span class="n">size_local</span> <span class="o">+</span> <span class="n">cell_imap</span><span class="o">.</span><span class="n">num_ghosts</span>

        <span class="c1"># record the region ids for the wedge, slab and crust based on the geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_rids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;rid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wedge_dividers</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wedge_rid</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_rids</span>  <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_rid</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crust_rids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;rid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">geom</span><span class="o">.</span><span class="n">crustal_layers</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span>

        <span class="c1"># generate the wedge submesh</span>
        <span class="c1"># this command also returns cell and facet tags mapped from the parent mesh to the submesh</span>
        <span class="c1"># additionally a cell map maps cells in the submesh to the parent mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_submesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_facet_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span> <span class="o">=</span> \
                            <span class="n">utils</span><span class="o">.</span><span class="n">create_submesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_rids</span><span class="p">]),</span> \
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="p">)</span>
        <span class="c1"># create a reverse cell map from the parent mesh to the submesh</span>
        <span class="c1"># (entering -1s in the map where no cell exists in the submesh)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_reverse_cell_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_reverse_cell_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span><span class="p">))</span>

        
        <span class="c1"># generate the slab submesh</span>
        <span class="c1"># this command also returns cell and facet tags mapped from the parent mesh to the submesh</span>
        <span class="c1"># additionally a cell map maps cells in the submesh to the parent mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_submesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_facet_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span>  <span class="o">=</span> \
                            <span class="n">utils</span><span class="o">.</span><span class="n">create_submesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_rids</span><span class="p">]),</span> \
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="p">)</span>
        <span class="c1"># create a reverse cell map from the parent mesh to the submesh</span>
        <span class="c1"># (entering -1s in the map where no cell exists in the submesh)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_reverse_cell_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_reverse_cell_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setup_functionspaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the functionspaces for the problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create finite elements for velocity and pressure</span>
        <span class="c1"># use a P2P1 (Taylor-Hood) element pair where the velocity</span>
        <span class="c1"># degree is one higher than the pressure (so only the pressure</span>
        <span class="c1"># degree can be set)</span>
        <span class="n">v_e</span> <span class="o">=</span> <span class="n">bu</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">basix_cell</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_p</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gdim</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">default_real_type</span><span class="p">)</span>
        <span class="n">p_e</span> <span class="o">=</span> <span class="n">bu</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">basix_cell</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_p</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">default_real_type</span><span class="p">)</span>
        <span class="c1"># combine them into a mixed finite element</span>
        <span class="n">vp_e</span> <span class="o">=</span> <span class="n">bu</span><span class="o">.</span><span class="n">mixed_element</span><span class="p">([</span><span class="n">v_e</span><span class="p">,</span> <span class="n">p_e</span><span class="p">])</span>
        
        <span class="k">def</span> <span class="nf">create_vp_functions</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">name_prefix</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create velocity and pressure functions</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># set up the mixed velocity, pressure functionspace</span>
            <span class="n">V_vp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">vp_e</span><span class="p">)</span>
            <span class="c1"># set up a collapsed velocity functionspace</span>
            <span class="n">V_v</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">V_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">()</span>

            <span class="c1"># set up a mixed velocity, pressure function</span>
            <span class="n">vp_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_vp</span><span class="p">)</span>
            <span class="n">vp_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name_prefix</span><span class="o">+</span><span class="s2">&quot;vp&quot;</span>
            <span class="c1"># split the velocity and pressure subfunctions</span>
            <span class="p">(</span><span class="n">v_i</span><span class="p">,</span> <span class="n">p_i</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp_i</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">v_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name_prefix</span><span class="o">+</span><span class="s2">&quot;v&quot;</span>
            <span class="n">p_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name_prefix</span><span class="o">+</span><span class="s2">&quot;p&quot;</span>
            <span class="c1"># set up the mixed velocity, pressure test function</span>
            <span class="n">vp_t</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V_vp</span><span class="p">)</span>
            <span class="c1"># set up the mixed velocity, pressure trial function</span>
            <span class="n">vp_a</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V_vp</span><span class="p">)</span>

            <span class="c1"># return everything</span>
            <span class="k">return</span> <span class="n">V_vp</span><span class="p">,</span> <span class="n">V_v</span><span class="p">,</span> <span class="n">vp_i</span><span class="p">,</span> <span class="n">v_i</span><span class="p">,</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">vp_t</span><span class="p">,</span> <span class="n">vp_a</span>
        
        <span class="c1"># set up slab functionspace, collapsed velocity sub-functionspace, </span>
        <span class="c1"># combined velocity-pressure Function, split velocity and pressure Functions,</span>
        <span class="c1"># and trial and test functions for</span>
        <span class="c1"># 1. the slab submesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vslab_vp</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">Vslab_v</span><span class="p">,</span>  \
                        <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">slab_vs_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_ps_i</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_a</span> <span class="o">=</span> <span class="n">create_vp_functions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_submesh</span><span class="p">,</span> <span class="s2">&quot;slab_&quot;</span><span class="p">)</span>
        <span class="c1"># 2. the wedge submesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_v</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vw_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_pw_i</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_a</span> <span class="o">=</span> <span class="n">create_vp_functions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_submesh</span><span class="p">,</span> <span class="s2">&quot;slab_&quot;</span><span class="p">)</span>

        <span class="c1"># set up the mixed velocity, pressure functionspace (not stored)</span>
        <span class="n">V_vp</span>   <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">vp_e</span><span class="p">)</span>
        <span class="n">V_v</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">V_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">()</span>
        <span class="n">V_p</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">V_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">()</span>

        <span class="c1"># set up functions defined on the whole mesh</span>
        <span class="c1"># to interpolate the wedge and slab velocities</span>
        <span class="c1"># and pressures to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vs_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vs_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;vs&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ps_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ps_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ps&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vw_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vw_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;vw&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pw_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pw_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;pw&quot;</span>
        
        <span class="c1"># temperature element</span>
        <span class="c1"># the degree of the element can be set independently through p_T</span>
        <span class="n">T_e</span> <span class="o">=</span> <span class="n">bu</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">basix_cell</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">default_real_type</span><span class="p">)</span>
        <span class="c1"># and functionspace on the overall mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_T</span>  <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">T_e</span><span class="p">)</span>

        <span class="c1"># create a dolfinx Function for the temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;T&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_t</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_a</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">)</span>
        
        <span class="c1"># on the slab submesh</span>
        <span class="n">Vslab_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_submesh</span><span class="p">,</span> <span class="n">T_e</span><span class="p">)</span>
        <span class="c1"># and on the wedge submesh</span>
        <span class="n">Vwedge_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_submesh</span><span class="p">,</span> <span class="n">T_e</span><span class="p">)</span>
        <span class="c1"># set up Functions so the solution can be interpolated to these subdomains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_T_i</span>  <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Vslab_T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_T_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;slab_T&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_T_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Vwedge_T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_T_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;wedge_T&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">update_T_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the temperature functions defined on the submeshes, given a solution on the full mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_T_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_T_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_v_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the velocity functions defined on the full mesh, given solutions on the sub meshes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vs_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vs_i</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_reverse_cell_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vw_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vw_i</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_reverse_cell_map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_p_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the pressure functions defined on the full mesh, given solutions on the sub meshes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ps_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_ps_i</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_reverse_cell_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pw_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_pw_i</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_reverse_cell_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">T_trench</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return temperature at the trench</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zd</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">A_si</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span>  <span class="c1"># incoming slab scale depth (non-dim)</span>
        <span class="n">deltazsurface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaxcoast</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)),</span> <span class="mf">0.0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ts</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tm</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Ts</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">+</span><span class="n">deltazsurface</span><span class="p">)</span><span class="o">/</span><span class="n">zd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">T_backarc_o</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return temperature at the trench</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zc</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa0</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ac_si</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">As_si</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span> <span class="c1"># overriding plate scale depth (non-dim)</span>
        <span class="n">deltazsurface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaxcoast</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)),</span> <span class="mf">0.0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ts</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tm</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Ts</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">+</span><span class="n">deltazsurface</span><span class="p">)</span><span class="o">/</span><span class="n">zc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">T_backarc_c</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return continental backarc temperature</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">deltazsurface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaxcoast</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)),</span> <span class="mf">0.0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">deltazsurface</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazuc</span><span class="p">:</span>
                <span class="c1"># if in the upper crust</span>
                <span class="n">deltaz</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">deltazsurface</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="o">*</span><span class="p">(</span><span class="n">deltaz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qs_nd</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span><span class="o">*</span><span class="n">deltaz</span>
            <span class="k">elif</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">deltazsurface</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazc</span><span class="p">:</span>
                <span class="c1"># if in the lower crust</span>
                <span class="n">deltaz1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazuc</span> <span class="c1">#- deltazsurface[i]</span>
                <span class="n">T1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="o">*</span><span class="p">(</span><span class="n">deltaz1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qs_nd</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span><span class="o">*</span><span class="n">deltaz1</span>
                <span class="n">q1</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="o">*</span><span class="n">deltaz1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs_nd</span>
                <span class="n">deltaz</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">deltazsurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazuc</span><span class="p">)</span>
                <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">T1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H2</span><span class="o">*</span><span class="p">(</span><span class="n">deltaz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span><span class="o">*</span><span class="n">deltaz</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># otherwise, we&#39;re in the mantle</span>
                <span class="n">deltaz1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazuc</span> <span class="c1"># - deltazsurface[i]</span>
                <span class="n">T1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="o">*</span><span class="p">(</span><span class="n">deltaz1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qs_nd</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span><span class="o">*</span><span class="n">deltaz1</span>
                <span class="n">q1</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="o">*</span><span class="n">deltaz1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs_nd</span>
                <span class="n">deltaz2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazc</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazuc</span> <span class="c1">#- deltazsurface[i]</span>
                <span class="n">T2</span> <span class="o">=</span> <span class="n">T1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H2</span><span class="o">*</span><span class="p">(</span><span class="n">deltaz2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span><span class="o">*</span><span class="n">deltaz2</span>
                <span class="n">q2</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H2</span><span class="o">*</span><span class="n">deltaz2</span> <span class="o">+</span> <span class="n">q1</span>
                <span class="n">deltaz</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">deltazsurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazc</span><span class="p">)</span>
                <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tm</span><span class="p">,</span> <span class="n">T2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">deltaz</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">T</span>
        
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">vw_slabtop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the wedge velocity on the slab surface</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># grab the partial and full coupling depths so we can set up a linear ramp in velocity between them</span>
        <span class="n">pcd</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">findpoint</span><span class="p">(</span><span class="s2">&quot;Slab::PartialCouplingDepth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">y</span>
        <span class="n">fcd</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">findpoint</span><span class="p">(</span><span class="s2">&quot;Slab::FullCouplingDepth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">y</span>
        <span class="n">dcd</span> <span class="o">=</span> <span class="n">fcd</span><span class="o">-</span><span class="n">pcd</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gdim</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">v</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">pcd</span><span class="p">)</span><span class="o">/</span><span class="n">dcd</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Vs_nd</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">unittangentx</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">v</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">vs_slabtop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the slab velocity on the slab surface</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gdim</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">v</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vs_nd</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">unittangentx</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">v</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setup_boundaryconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the boundary conditions and apply them to the functions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># locate the degrees of freedom (dofs) where various boundary conditions will be applied</span>
        <span class="c1"># on the top of the wedge for the wedge velocity</span>
        <span class="n">wedgetop_dofs_Vwedge_v</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_v</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span><span class="p">,</span>
                                                                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">pid</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">crustal_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]])]))</span>
        <span class="c1"># on the slab surface for the slab velocity</span>
        <span class="n">slab_dofs_Vslab_v</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Vslab_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vslab_v</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span><span class="p">,</span> 
                                                           <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">pids</span><span class="p">)]))</span>
        <span class="c1"># on the slab surface for the wedge velocity</span>
        <span class="n">slab_dofs_Vwedge_v</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_v</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span><span class="p">,</span> 
                                                            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">pids</span><span class="p">)]))</span>
        <span class="c1"># on the top of the domain for the temperature</span>
        <span class="n">top_dofs_V_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span><span class="p">,</span> 
                                                      <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">coast_sid</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">top_sid</span><span class="p">)]))</span>
        <span class="c1"># on the side of the slab side of the domain for the temperature</span>
        <span class="n">slabside_dofs_V_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span><span class="p">,</span> 
                                                           <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">pid</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_side_lines</span><span class="p">])]))</span>
        <span class="c1"># on the side of the wedge side of the domain for the temperature</span>
        <span class="n">wedgeside_dofs_V_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span><span class="p">,</span> 
                                                            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">pid</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wedge_side_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])]))</span>
        
        <span class="c1"># temperature boundary conditions        </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># zero on the top of the domain</span>
        <span class="n">zero_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">zero_c</span><span class="p">,</span> <span class="n">top_dofs_V_T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">))</span>
        <span class="c1"># an incoming slab thermal profile on the lhs of the domain</span>
        <span class="n">T_trench_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">)</span>
        <span class="n">T_trench_f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_trench</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">T_trench_f</span><span class="p">,</span> <span class="n">slabside_dofs_V_T</span><span class="p">))</span>
        <span class="c1"># on the top (above iodepth) of the incoming wedge side of the domain</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sztype</span><span class="o">==</span><span class="s1">&#39;continental&#39;</span><span class="p">:</span>
            <span class="n">T_backarc_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">)</span>
            <span class="n">T_backarc_f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_backarc_c</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">T_backarc_f</span><span class="p">,</span> <span class="n">wedgeside_dofs_V_T</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">T_backarc_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">)</span>
            <span class="n">T_backarc_f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_backarc_o</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">T_backarc_f</span><span class="p">,</span> <span class="n">wedgeside_dofs_V_T</span><span class="p">))</span>
            
        <span class="c1"># wedge velocity (and pressure) boundary conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># zero velocity on the top of the wedge</span>
        <span class="n">zero_vw_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_v</span><span class="p">)</span>
        <span class="n">zero_vw_f</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">zero_vw_f</span><span class="p">,</span> <span class="n">wedgetop_dofs_Vwedge_v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
        <span class="c1"># kinematic slab on the slab surface of the wedge</span>
        <span class="n">vw_slabtop_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_v</span><span class="p">)</span>
        <span class="n">vw_slabtop_f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vw_slabtop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">vw_slabtop_f</span><span class="p">,</span> <span class="n">slab_dofs_Vwedge_v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

        <span class="c1"># slab velocity (and pressure) boundary conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># kinematic slab on the slab surface of the slab</span>
        <span class="n">vs_slabtop_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vslab_v</span><span class="p">)</span>
        <span class="n">vs_slabtop_f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs_slabtop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">vs_slabtop_f</span><span class="p">,</span> <span class="n">slab_dofs_Vslab_v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vslab_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

        <span class="c1"># interpolate the temperature boundary conditions as initial conditions/guesses</span>
        <span class="c1"># to the whole domain (not just the boundaries)</span>
        <span class="c1"># on the wedge and crust side of the domain apply the wedge condition</span>
        <span class="n">nonslab_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">crust_rids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_rids</span><span class="p">]</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">domain</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">T_backarc_f</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="n">nonslab_cells</span><span class="p">)</span>
        <span class="c1"># on the slab side of the domain apply the slab condition</span>
        <span class="n">slab_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_rids</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">T_trench_f</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="n">slab_cells</span><span class="p">)</span>
        <span class="c1"># update the interpolated T functions for consistency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_T_functions</span><span class="p">()</span>

        <span class="c1"># just set the boundary conditions on the boundaries for the velocities</span>
        <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">set_bc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">set_bc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vps</span><span class="p">)</span>
        <span class="c1"># and update the interpolated v functions for consistency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_v_functions</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the subduction problem with the allowed input parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># loop over the keyword arguments and apply any that are allowed as input parameters</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_input_parameters</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="c1"># check required parameters are set</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_parameters</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; must be set but isn&#39;t.  Please supply a value.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">,))</span>

        <span class="c1"># check sztype dependent required parameters are set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sztype</span> <span class="o">==</span> <span class="s2">&quot;continental&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_if_continental</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; must be set if the sztype is continental.  Please supply a value.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">,))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sztype</span> <span class="o">==</span> <span class="s2">&quot;oceanic&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_if_oceanic</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; must be set if the sztype is oceanic.  Please supply a value.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown sztype (</span><span class="si">{}</span><span class="s2">).  Please set a valid sztype (continental or oceanic).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sztype</span><span class="p">))</span>
            
        <span class="c1"># set the geometry and generate the meshes and functionspaces</span>
        <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geom</span> <span class="o">=</span> <span class="n">geom</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_meshes</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_functionspaces</span><span class="p">()</span>

        <span class="c1"># derived reference values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">rho0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">cp0</span>   <span class="c1"># reference thermal diffusivity (m^2/s)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v0</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span>          <span class="c1"># reference velocity (m/s)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e0</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span>              <span class="c1"># reference strain rate (/s)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p0</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">eta0</span>            <span class="c1"># reference pressure (Pa)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H0</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">T0</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># reference heat source (W/m^3)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q0</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span>              <span class="c1"># reference heat flux (W/m^2)</span>

        <span class="c1"># derived parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_si</span>      <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Myr_to_s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>   <span class="c1"># age of subducting slab (s)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vs_nd</span>     <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mmpyr_to_mps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vs</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">v0</span> <span class="c1"># slab speed (non-dim)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sztype</span> <span class="o">==</span> <span class="s1">&#39;oceanic&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ac_si</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Myr_to_s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ac</span><span class="p">)</span>  <span class="c1"># age of over-riding plate (s)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">As_si</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Myr_to_s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">As</span><span class="p">)</span>  <span class="c1"># age of subduction (s)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qs_nd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">q0</span>          <span class="c1"># surface heat flux (non-dim)</span>
        
        <span class="c1"># parameters derived from from the geometry</span>
        <span class="c1"># depth of the trench</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">findpoint</span><span class="p">(</span><span class="s1">&#39;Slab::Trench&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">y</span>
        <span class="c1"># coastline distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltaxcoast</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">coast_distance</span>
        <span class="c1"># crust depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltazc</span>      <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">crustal_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sztype</span> <span class="o">==</span> <span class="s2">&quot;continental&quot;</span><span class="p">:</span>
            <span class="c1"># upper crust depth</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deltazuc</span>     <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">crustal_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_boundaryconditions</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a SubductionProblem.</span>

<span class="sd">        Arguments:</span>
<span class="sd">          * geom  - an instance of a subduction zone geometry</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">         required:</span>
<span class="sd">          * A      - age of subducting slab (in Myr) [required]</span>
<span class="sd">          * Vs     - incoming slab speed (in mm/yr) [required]</span>
<span class="sd">          * sztype - type of subduction zone (either &#39;continental&#39; or &#39;oceanic&#39;) [required]</span>
<span class="sd">          * Ac     - age of the over-riding plate (in Myr) [required if sztype is &#39;oceanic&#39;]</span>
<span class="sd">          * As     - age of subduction (in Myr) [required if sztype is &#39;oceanic&#39;]</span>
<span class="sd">          * qs     - surface heat flux (in W/m^2) [required if sztype is &#39;continental&#39;]</span>

<span class="sd">         optional:</span>
<span class="sd">          * Ts   - surface temperature (deg C, corresponds to non-dim)</span>
<span class="sd">          * Tm   - mantle temperature (deg C, corresponds to non-dim)</span>
<span class="sd">          * kc   - crustal thermal conductivity (non-dim)</span>
<span class="sd">          * km   - mantle thermal conductivity (non-dim)</span>
<span class="sd">          * rhoc - crustal density (non-dim)</span>
<span class="sd">          * rhom - mantle density (non-dim)</span>
<span class="sd">          * cp   - isobaric heat capacity (non-dim)</span>
<span class="sd">          * H1   - upper crustal volumetric heat production (non-dim)</span>
<span class="sd">          * H2   - lower crustal volumetric heat production (non-dim)</span>

<span class="sd">         optional (dislocation creep rheology):</span>
<span class="sd">          * etamax - maximum viscosity (Pas) [only relevant for dislocation creep rheologies]</span>
<span class="sd">          * nsigma - stress viscosity power law exponents (non-dim) [only relevant for dislocation creep rheologies]</span>
<span class="sd">          * Aeta   - pre-exponential viscosity constant (Pa s^(1/n)) [only relevant for dislocation creep rheologies]</span>
<span class="sd">          * E      - viscosity activation energy (J/mol) [only relevant for dislocation creep rheologies]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A</span>      <span class="o">=</span> <span class="mf">100.0</span>      <span class="c1"># age of subducting slab (Myr)</span>
<span class="n">qs</span>     <span class="o">=</span> <span class="mf">0.065</span>      <span class="c1"># surface heat flux (W/m^2)</span>
<span class="n">Vs</span>     <span class="o">=</span> <span class="mf">100.0</span>      <span class="c1"># slab speed (mm/yr)</span>
<span class="n">sztype</span> <span class="o">=</span> <span class="s1">&#39;continental&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sz</span> <span class="o">=</span> <span class="n">SubductionProblem</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">Vs</span><span class="o">=</span><span class="n">Vs</span><span class="p">,</span> <span class="n">sztype</span><span class="o">=</span><span class="n">sztype</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Info    : Meshing 1D...
Info    : [  0%] Meshing curve 1 (Line)
Info    : [ 10%] Meshing curve 2 (Line)
Info    : [ 10%] Meshing curve 3 (Line)
Info    : [ 10%] Meshing curve 4 (Line)
Info    : [ 10%] Meshing curve 5 (Line)
Info    : [ 10%] Meshing curve 6 (Line)
Info    : [ 10%] Meshing curve 7 (Line)
Info    : [ 10%] Meshing curve 8 (Line)
Info    : [ 10%] Meshing curve 9 (Line)
Info    : [ 10%] Meshing curve 10 (Line)
Info    : [ 20%] Meshing curve 11 (Line)
Info    : [ 20%] Meshing curve 12 (Line)
Info    : [ 20%] Meshing curve 13 (Line)
Info    : [ 20%] Meshing curve 14 (Line)
Info    : [ 20%] Meshing curve 15 (Line)
Info    : [ 20%] Meshing curve 16 (Line)
Info    : [ 20%] Meshing curve 17 (Line)
Info    : [ 20%] Meshing curve 18 (Line)
Info    : [ 20%] Meshing curve 19 (Line)
Info    : [ 30%] Meshing curve 20 (Line)
Info    : [ 30%] Meshing curve 21 (Line)
Info    : [ 30%] Meshing curve 22 (Line)
Info    : [ 30%] Meshing curve 23 (Line)
Info    : [ 30%] Meshing curve 24 (Line)
Info    : [ 30%] Meshing curve 25 (Line)
Info    : [ 30%] Meshing curve 27 (Line)
Info    : [ 30%] Meshing curve 28 (Line)
Info    : [ 30%] Meshing curve 29 (Line)
Info    : [ 40%] Meshing curve 30 (Line)
Info    : [ 40%] Meshing curve 31 (Line)
Info    : [ 40%] Meshing curve 32 (Line)
Info    : [ 40%] Meshing curve 33 (Line)
Info    : [ 40%] Meshing curve 34 (Line)
Info    : [ 40%] Meshing curve 35 (Line)
Info    : [ 40%] Meshing curve 36 (Line)
Info    : [ 40%] Meshing curve 37 (Line)
Info    : [ 40%] Meshing curve 38 (Line)
Info    : [ 50%] Meshing curve 39 (Line)
Info    : [ 50%] Meshing curve 40 (Line)
Info    : [ 50%] Meshing curve 41 (Line)
Info    : [ 50%] Meshing curve 42 (Line)
Info    : [ 50%] Meshing curve 43 (Line)
Info    : [ 50%] Meshing curve 44 (Line)
Info    : [ 50%] Meshing curve 45 (Line)
Info    : [ 50%] Meshing curve 46 (Line)
Info    : [ 50%] Meshing curve 47 (Line)
Info    : [ 60%] Meshing curve 48 (Line)
Info    : [ 60%] Meshing curve 49 (Line)
Info    : [ 60%] Meshing curve 50 (Line)
Info    : [ 60%] Meshing curve 51 (Line)
Info    : [ 60%] Meshing curve 52 (Line)
Info    : [ 60%] Meshing curve 54 (Line)
Info    : [ 60%] Meshing curve 55 (Line)
Info    : [ 60%] Meshing curve 56 (Line)
Info    : [ 60%] Meshing curve 57 (Line)
Info    : [ 70%] Meshing curve 58 (Line)
Info    : [ 70%] Meshing curve 59 (Line)
Info    : [ 70%] Meshing curve 60 (Line)
Info    : [ 70%] Meshing curve 61 (Line)
Info    : [ 70%] Meshing curve 62 (Line)
Info    : [ 70%] Meshing curve 63 (Line)
Info    : [ 70%] Meshing curve 64 (Line)
Info    : [ 70%] Meshing curve 65 (Line)
Info    : [ 70%] Meshing curve 66 (Line)
Info    : [ 80%] Meshing curve 67 (Line)
Info    : [ 80%] Meshing curve 68 (Line)
Info    : [ 80%] Meshing curve 70 (Line)
Info    : [ 80%] Meshing curve 71 (Line)
Info    : [ 80%] Meshing curve 72 (Line)
Info    : [ 80%] Meshing curve 73 (Line)
Info    : [ 80%] Meshing curve 74 (Line)
Info    : [ 80%] Meshing curve 75 (Line)
Info    : [ 80%] Meshing curve 76 (Line)
Info    : [ 90%] Meshing curve 77 (Line)
Info    : [ 90%] Meshing curve 78 (Line)
Info    : [ 90%] Meshing curve 79 (Line)
Info    : [ 90%] Meshing curve 80 (Line)
Info    : [ 90%] Meshing curve 81 (Line)
Info    : [ 90%] Meshing curve 82 (Line)
Info    : [ 90%] Meshing curve 83 (Line)
Info    : [ 90%] Meshing curve 85 (Line)
Info    : [ 90%] Meshing curve 86 (Line)
Info    : [100%] Meshing curve 87 (Line)
Info    : [100%] Meshing curve 88 (Line)
Info    : [100%] Meshing curve 89 (Line)
Info    : [100%] Meshing curve 90 (Line)
Info    : [100%] Meshing curve 91 (Line)
Info    : [100%] Meshing curve 92 (Line)
Info    : [100%] Meshing curve 93 (Line)
Info    : [100%] Meshing curve 95 (Line)
Info    : [100%] Meshing curve 96 (Line)
Info    : Done meshing 1D (Wall 0.0154608s, CPU 0.015731s)
Info    : Meshing 2D...
Info    : [  0%] Meshing surface 1 (Plane, Frontal-Delaunay)
Info    : [ 20%] Meshing surface 2 (Plane, Frontal-Delaunay)
Info    : [ 40%] Meshing surface 3 (Plane, Frontal-Delaunay)
Info    : [ 50%] Meshing surface 4 (Plane, Frontal-Delaunay)
Info    : [ 70%] Meshing surface 5 (Plane, Frontal-Delaunay)
Info    : [ 90%] Meshing surface 6 (Plane, Frontal-Delaunay)
Info    : Done meshing 2D (Wall 0.0423814s, CPU 0.043149s)
Info    : 1474 nodes 3239 elements
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utils</span><span class="o">.</span><span class="n">plot_scalar</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sz</span><span class="o">.</span><span class="n">T0</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_vector</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">vw_i</span><span class="p">,</span> <span class="n">glyph_factor</span><span class="o">=</span><span class="mi">4</span><span class="o">/</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">))</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_vector</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">vs_i</span><span class="p">,</span> <span class="n">glyph_factor</span><span class="o">=</span><span class="mi">4</span><span class="o">/</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1266b414ca0c88955eb40818b1b14b7aedb27e40efaeed109395b43b18e7d2c0.png" src="../_images/1266b414ca0c88955eb40818b1b14b7aedb27e40efaeed109395b43b18e7d2c0.png" />
<img alt="../_images/e813bf53a1eab4347f61e13f9de545f55aead85789290b83b4a2a8e2e36b7e03.png" src="../_images/e813bf53a1eab4347f61e13f9de545f55aead85789290b83b4a2a8e2e36b7e03.png" />
<img alt="../_images/21018514d7dfbeda5035be1f78ebb3a14294d7479808570b4f3bbd61cdfa8a74.png" src="../_images/21018514d7dfbeda5035be1f78ebb3a14294d7479808570b4f3bbd61cdfa8a74.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">stokes_forms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vp_t</span><span class="p">,</span> <span class="n">vp_a</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the forms Ss and fs for the matrix problem Ss*us = fs for the Stokes problems</span>
<span class="sd">        given the test and trial functions and the mesh.</span>

<span class="sd">        Arguments:</span>
<span class="sd">          * vp_t - velocity-pressure test function</span>
<span class="sd">          * vp_a - velocity-pressure trial function</span>
<span class="sd">          * mesh - mesh</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">          * eta  - viscosity (defaults to 1 for isoviscous)</span>

<span class="sd">        Returns:</span>
<span class="sd">          * Ss - lhs bilinear form for the Stokes problem</span>
<span class="sd">          * fs - rhs linear form for the Stokes problem</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">v_t</span><span class="p">,</span> <span class="n">p_t</span><span class="p">)</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">vp_t</span><span class="p">)</span>
        <span class="p">(</span><span class="n">v_a</span><span class="p">,</span> <span class="n">p_a</span><span class="p">)</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">vp_a</span><span class="p">)</span>
        <span class="c1"># the stiffness block</span>
        <span class="n">Ks</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_t</span><span class="p">)),</span> <span class="mi">2</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_a</span><span class="p">)))</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="c1"># gradient of pressure</span>
        <span class="n">Gs</span> <span class="o">=</span> <span class="o">-</span><span class="n">ufl</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">v_t</span><span class="p">)</span><span class="o">*</span><span class="n">p_a</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="c1"># divergence of velcoity</span>
        <span class="n">Ds</span> <span class="o">=</span> <span class="o">-</span><span class="n">p_t</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">v_a</span><span class="p">)</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="c1"># combined matrix form</span>
        <span class="n">Ss</span> <span class="o">=</span> <span class="n">Ks</span> <span class="o">+</span> <span class="n">Gs</span> <span class="o">+</span> <span class="n">Ds</span>
        <span class="c1"># this problem has no rhs so create a dummy form by multiplying by a zero constant</span>
        <span class="n">zero_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">zero_c</span><span class="o">*</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">v_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_t</span><span class="p">)</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="c1"># return the forms</span>
        <span class="k">return</span> <span class="n">Ss</span><span class="p">,</span> <span class="n">fs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">temperature_forms_steadystate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the forms ST and fT for the matrix problem ST*T = fT for the steady-state </span>
<span class="sd">        temperature advection-diffusion problem.</span>

<span class="sd">        Returns:</span>
<span class="sd">          * ST - lhs bilinear form for the temperature problem</span>
<span class="sd">          * fT - rhs linear form for the temperature problem</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># integration measures that know about the cell and facet tags</span>

        <span class="c1"># advection diffusion in the slab</span>
        <span class="n">STs</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rhom</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs_i</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_a</span><span class="p">))</span> <span class="o">+</span> \
               <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_a</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">km</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="p">)))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_rids</span><span class="p">)</span>
        <span class="c1"># advection diffusion in the wedge</span>
        <span class="n">STw</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rhom</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vw_i</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_a</span><span class="p">))</span> <span class="o">+</span> \
               <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_a</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">km</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="p">)))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_rids</span><span class="p">)</span>
        <span class="c1"># just diffusion in the crust</span>
        <span class="n">STc</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_a</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crust_rids</span><span class="p">)</span>
        <span class="c1"># the complete bilinear form</span>
        <span class="n">ST</span>  <span class="o">=</span> <span class="n">STs</span> <span class="o">+</span> <span class="n">STw</span> <span class="o">+</span> <span class="n">STc</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sztype</span><span class="o">==</span><span class="s1">&#39;continental&#39;</span><span class="p">:</span>
            <span class="c1"># if the sztype is &#39;continental&#39; then put radiogenic heating in the rhs form</span>
            <span class="n">lc_rids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">geom</span><span class="o">.</span><span class="n">crustal_layers</span><span class="p">[</span><span class="s1">&#39;Crust&#39;</span><span class="p">][</span><span class="s1">&#39;rid&#39;</span><span class="p">]])</span>
            <span class="n">uc_rids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">geom</span><span class="o">.</span><span class="n">crustal_layers</span><span class="p">[</span><span class="s1">&#39;UpperCrust&#39;</span><span class="p">][</span><span class="s1">&#39;rid&#39;</span><span class="p">]])</span>
            <span class="n">fT</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="n">uc_rids</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">H2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="n">lc_rids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if the sztype is &#39;oceanic&#39; then create a zero rhs form</span>
            <span class="n">zero_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
            <span class="n">fT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="o">*</span><span class="n">zero_c</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="c1"># return the forms</span>
        <span class="k">return</span> <span class="n">ST</span><span class="p">,</span> <span class="n">fT</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">solve_stokes_isoviscous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">petsc_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the Stokes problems assuming an isoviscous rheology.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">          * petsc_options - a dictionary of petsc options to pass to the solver (defaults to mumps)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">petsc_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">petsc_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;preonly&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;lu&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_factor_mat_solver_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">}</span>

        <span class="c1"># retrive the Stokes forms for the wedge</span>
        <span class="n">Ssw</span><span class="p">,</span> <span class="n">fsw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_forms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_submesh</span><span class="p">)</span>
        <span class="n">problem_vpw</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">Ssw</span><span class="p">,</span> <span class="n">fsw</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span><span class="p">,</span> 
                                                 <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>
        
        <span class="c1"># retrive the Stokes forms for the slab</span>
        <span class="n">Sss</span><span class="p">,</span> <span class="n">fss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_forms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_submesh</span><span class="p">)</span>
        <span class="n">problem_vps</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">Sss</span><span class="p">,</span> <span class="n">fss</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs_vps</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span><span class="p">,</span>
                                                 <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>

        <span class="c1"># solve the Stokes problems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span> <span class="o">=</span> <span class="n">problem_vpw</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span> <span class="o">=</span> <span class="n">problem_vps</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

        <span class="c1"># interpolate the solutions to the whole mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_v_functions</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">solve_steadystate_isoviscous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">petsc_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the coupled temperature-velocity-pressure problem assuming an isoviscous rheology</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">          * petsc_options - a dictionary of petsc options to pass to the solver (defaults to mumps)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">petsc_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">petsc_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;preonly&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;lu&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_factor_mat_solver_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">}</span>

        <span class="c1"># first solve both Stokes systems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_stokes_isoviscous</span><span class="p">(</span><span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>

        <span class="c1"># retrieve the temperature forms</span>
        <span class="n">ST</span><span class="p">,</span> <span class="n">fT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_forms_steadystate</span><span class="p">()</span>
        <span class="n">problem_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">ST</span><span class="p">,</span> <span class="n">fT</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span>
                                               <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>
        <span class="c1"># and solve the temperature problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span> <span class="o">=</span> <span class="n">problem_T</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

        <span class="c1"># only update the pressure at the end as it is not necessary earlier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_p_functions</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the benchmark diagnostics.</span>

<span class="sd">        Returns:</span>
<span class="sd">          * Tpt       - spot temperature on the slab at 100 km depth</span>
<span class="sd">          * Tslab     - average temperature along the diagnostic region of the slab surface</span>
<span class="sd">          * Twedge    - average temperature in the diagnostic region of the wedge</span>
<span class="sd">          * vrmswedge - average rms velocity in the diagnostic region of the wedge</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># work out location of spot tempeterature on slab and evaluate T</span>
        <span class="n">xpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">intersecty</span><span class="p">(</span><span class="o">-</span><span class="mf">100.0</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="mf">0.0</span><span class="p">])</span>
        <span class="n">Tpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">xpt</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_first_cells</span><span class="p">(</span><span class="n">xpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T_(200,-100) = </span><span class="si">{:.2f}</span><span class="s2"> deg C&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Tpt</span><span class="p">,))</span>

        <span class="c1"># a unit constant to evaluate slab length and wedge area</span>
        <span class="n">one_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>

        <span class="c1"># evaluate average T along diagnostic section of slab</span>
        <span class="n">slab_diag_sids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wedge_dividers</span><span class="p">[</span><span class="s1">&#39;WedgeFocused&#39;</span><span class="p">][</span><span class="s1">&#39;slab_sid&#39;</span><span class="p">]])</span>
        <span class="n">Tslab</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dS</span><span class="p">(</span><span class="n">slab_diag_sids</span><span class="p">)))</span>\
                <span class="o">/</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">one_c</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dS</span><span class="p">(</span><span class="n">slab_diag_sids</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T_slab = </span><span class="si">{:.2f}</span><span class="s2"> deg C&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Tslab</span><span class="p">,))</span>
        
        <span class="n">wedge_diag_rids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wedge_dividers</span><span class="p">[</span><span class="s1">&#39;WedgeFocused&#39;</span><span class="p">][</span><span class="s1">&#39;rid&#39;</span><span class="p">]])</span>
        <span class="n">wedge_diag_area</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">one_c</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="n">wedge_diag_rids</span><span class="p">)))</span>

        <span class="c1"># evaluate average T in wedge diagnostic region</span>
        <span class="n">Twedge</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="n">wedge_diag_rids</span><span class="p">)))</span>\
                 <span class="o">/</span><span class="n">wedge_diag_area</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T_wedge = </span><span class="si">{:.2f}</span><span class="s2"> deg C&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Twedge</span><span class="p">,))</span>

        <span class="c1"># evaluate average vrms in wedge diagnostic region</span>
        <span class="n">vrmswedge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vw_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vw_i</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="n">wedge_diag_rids</span><span class="p">)))</span>\
                            <span class="o">/</span><span class="n">wedge_diag_area</span><span class="p">)</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;V_rms,w = </span><span class="si">{:.2f}</span><span class="s2"> mm/yr&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vrmswedge</span><span class="p">,))</span>

        <span class="c1"># return results</span>
        <span class="k">return</span> <span class="n">Tpt</span><span class="p">,</span> <span class="n">Tslab</span><span class="p">,</span> <span class="n">Twedge</span><span class="p">,</span> <span class="n">vrmswedge</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sz</span> <span class="o">=</span> <span class="n">SubductionProblem</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">Vs</span><span class="o">=</span><span class="n">Vs</span><span class="p">,</span> <span class="n">sztype</span><span class="o">=</span><span class="n">sztype</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning : Gmsh has aleady been initialized
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Info    : Meshing 1D...
Info    : [  0%] Meshing curve 1 (Line)
Info    : [ 10%] Meshing curve 2 (Line)
Info    : [ 10%] Meshing curve 3 (Line)
Info    : [ 10%] Meshing curve 4 (Line)
Info    : [ 10%] Meshing curve 5 (Line)
Info    : [ 10%] Meshing curve 6 (Line)
Info    : [ 10%] Meshing curve 7 (Line)
Info    : [ 10%] Meshing curve 8 (Line)
Info    : [ 10%] Meshing curve 9 (Line)
Info    : [ 10%] Meshing curve 10 (Line)
Info    : [ 20%] Meshing curve 11 (Line)
Info    : [ 20%] Meshing curve 12 (Line)
Info    : [ 20%] Meshing curve 13 (Line)
Info    : [ 20%] Meshing curve 14 (Line)
Info    : [ 20%] Meshing curve 15 (Line)
Info    : [ 20%] Meshing curve 16 (Line)
Info    : [ 20%] Meshing curve 17 (Line)
Info    : [ 20%] Meshing curve 18 (Line)
Info    : [ 20%] Meshing curve 19 (Line)
Info    : [ 30%] Meshing curve 20 (Line)
Info    : [ 30%] Meshing curve 21 (Line)
Info    : [ 30%] Meshing curve 22 (Line)
Info    : [ 30%] Meshing curve 23 (Line)
Info    : [ 30%] Meshing curve 24 (Line)
Info    : [ 30%] Meshing curve 25 (Line)
Info    : [ 30%] Meshing curve 27 (Line)
Info    : [ 30%] Meshing curve 28 (Line)
Info    : [ 30%] Meshing curve 29 (Line)
Info    : [ 40%] Meshing curve 30 (Line)
Info    : [ 40%] Meshing curve 31 (Line)
Info    : [ 40%] Meshing curve 32 (Line)
Info    : [ 40%] Meshing curve 33 (Line)
Info    : [ 40%] Meshing curve 34 (Line)
Info    : [ 40%] Meshing curve 35 (Line)
Info    : [ 40%] Meshing curve 36 (Line)
Info    : [ 40%] Meshing curve 37 (Line)
Info    : [ 40%] Meshing curve 38 (Line)
Info    : [ 50%] Meshing curve 39 (Line)
Info    : [ 50%] Meshing curve 40 (Line)
Info    : [ 50%] Meshing curve 41 (Line)
Info    : [ 50%] Meshing curve 42 (Line)
Info    : [ 50%] Meshing curve 43 (Line)
Info    : [ 50%] Meshing curve 44 (Line)
Info    : [ 50%] Meshing curve 45 (Line)
Info    : [ 50%] Meshing curve 46 (Line)
Info    : [ 50%] Meshing curve 47 (Line)
Info    : [ 60%] Meshing curve 48 (Line)
Info    : [ 60%] Meshing curve 49 (Line)
Info    : [ 60%] Meshing curve 50 (Line)
Info    : [ 60%] Meshing curve 51 (Line)
Info    : [ 60%] Meshing curve 52 (Line)
Info    : [ 60%] Meshing curve 54 (Line)
Info    : [ 60%] Meshing curve 55 (Line)
Info    : [ 60%] Meshing curve 56 (Line)
Info    : [ 60%] Meshing curve 57 (Line)
Info    : [ 70%] Meshing curve 58 (Line)
Info    : [ 70%] Meshing curve 59 (Line)
Info    : [ 70%] Meshing curve 60 (Line)
Info    : [ 70%] Meshing curve 61 (Line)
Info    : [ 70%] Meshing curve 62 (Line)
Info    : [ 70%] Meshing curve 63 (Line)
Info    : [ 70%] Meshing curve 64 (Line)
Info    : [ 70%] Meshing curve 65 (Line)
Info    : [ 70%] Meshing curve 66 (Line)
Info    : [ 80%] Meshing curve 67 (Line)
Info    : [ 80%] Meshing curve 68 (Line)
Info    : [ 80%] Meshing curve 70 (Line)
Info    : [ 80%] Meshing curve 71 (Line)
Info    : [ 80%] Meshing curve 72 (Line)
Info    : [ 80%] Meshing curve 73 (Line)
Info    : [ 80%] Meshing curve 74 (Line)
Info    : [ 80%] Meshing curve 75 (Line)
Info    : [ 80%] Meshing curve 76 (Line)
Info    : [ 90%] Meshing curve 77 (Line)
Info    : [ 90%] Meshing curve 78 (Line)
Info    : [ 90%] Meshing curve 79 (Line)
Info    : [ 90%] Meshing curve 80 (Line)
Info    : [ 90%] Meshing curve 81 (Line)
Info    : [ 90%] Meshing curve 82 (Line)
Info    : [ 90%] Meshing curve 83 (Line)
Info    : [ 90%] Meshing curve 85 (Line)
Info    : [ 90%] Meshing curve 86 (Line)
Info    : [100%] Meshing curve 87 (Line)
Info    : [100%] Meshing curve 88 (Line)
Info    : [100%] Meshing curve 89 (Line)
Info    : [100%] Meshing curve 90 (Line)
Info    : [100%] Meshing curve 91 (Line)
Info    : [100%] Meshing curve 92 (Line)
Info    : [100%] Meshing curve 93 (Line)
Info    : [100%] Meshing curve 95 (Line)
Info    : [100%] Meshing curve 96 (Line)
Info    : Done meshing 1D (Wall 0.013167s, CPU 0.015615s)
Info    : Meshing 2D...
Info    : [  0%] Meshing surface 1 (Plane, Frontal-Delaunay)
Info    : [ 20%] Meshing surface 2 (Plane, Frontal-Delaunay)
Info    : [ 40%] Meshing surface 3 (Plane, Frontal-Delaunay)
Info    : [ 50%] Meshing surface 4 (Plane, Frontal-Delaunay)
Info    : [ 70%] Meshing surface 5 (Plane, Frontal-Delaunay)
Info    : [ 90%] Meshing surface 6 (Plane, Frontal-Delaunay)
Info    : Done meshing 2D (Wall 0.0437275s, CPU 0.044404s)
Info    : 1474 nodes 3239 elements
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sz</span><span class="o">.</span><span class="n">solve_steadystate_isoviscous</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sz</span><span class="o">.</span><span class="n">get_diagnostics</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>T_(200,-100) = 517.17 deg C
T_slab = 451.95 deg C
T_wedge = 927.02 deg C
V_rms,w = 34.64 mm/yr
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(517.1667805112614, 451.94524960727773, 927.0205196392287, 34.63785735800824)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utils</span><span class="o">.</span><span class="n">plot_scalar</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sz</span><span class="o">.</span><span class="n">T0</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_vector</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">vw_i</span><span class="p">,</span> <span class="n">glyph_factor</span><span class="o">=</span><span class="mi">4</span><span class="o">/</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">))</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_vector</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">vs_i</span><span class="p">,</span> <span class="n">glyph_factor</span><span class="o">=</span><span class="mi">4</span><span class="o">/</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7f6070876bd542ef72ce67d49d738591fab84b5c062d3a8784fee5251cd1be03.png" src="../_images/7f6070876bd542ef72ce67d49d738591fab84b5c062d3a8784fee5251cd1be03.png" />
<img alt="../_images/ebae804ee2b144404b6b363850cd1d761faafc3104b007dcede3867e165c8562.png" src="../_images/ebae804ee2b144404b6b363850cd1d761faafc3104b007dcede3867e165c8562.png" />
<img alt="../_images/2dad4f070b738738cbfd1eeaaf254f2e10af3944ad70d07d8957946e4539f4c8.png" src="../_images/2dad4f070b738738cbfd1eeaaf254f2e10af3944ad70d07d8957946e4539f4c8.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_slab_temperatures</span><span class="p">(</span><span class="n">sz</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the slab surface and Moho (7 km slab depth)</span>

<span class="sd">    Arguments:</span>
<span class="sd">      * sz - a solved SubductionProblem instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get some points along the slab</span>
    <span class="n">slabpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span> <span class="k">for</span> <span class="n">curve</span> <span class="ow">in</span> <span class="n">sz</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">interpcurves</span><span class="p">])</span>
    <span class="c1"># do the same along a spline deeper in the slab</span>
    <span class="n">slabmoho</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="p">)</span>
    <span class="n">slabmoho</span><span class="o">.</span><span class="n">translatenormalandcrop</span><span class="p">(</span><span class="o">-</span><span class="mf">7.0</span><span class="p">)</span>
    <span class="n">slabmohopoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span> <span class="k">for</span> <span class="n">curve</span> <span class="ow">in</span> <span class="n">slabmoho</span><span class="o">.</span><span class="n">interpcurves</span><span class="p">])</span>
    <span class="c1"># set up a figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="c1"># plot the slab temperatures</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">T_i</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">slabpoints</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_first_cells</span><span class="p">(</span><span class="n">slabpoints</span><span class="p">,</span> <span class="n">sz</span><span class="o">.</span><span class="n">mesh</span><span class="p">))[:,</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">slabpoints</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;slab surface&#39;</span><span class="p">)</span>
    <span class="c1"># plot the moho temperatures</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">T_i</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">slabmohopoints</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_first_cells</span><span class="p">(</span><span class="n">slabmohopoints</span><span class="p">,</span> <span class="n">sz</span><span class="o">.</span><span class="n">mesh</span><span class="p">))[:,</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">slabmohopoints</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;slab moho&#39;</span><span class="p">)</span>
    <span class="c1"># labels, title etc.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;T ($^\circ$C)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;z (km)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Slab surface and Moho temperatures&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_slab_temperatures</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9ac32bf40fb60250686f5a78c1cfed9288bde641b4fecb9578fa428d54334e53.png" src="../_images/9ac32bf40fb60250686f5a78c1cfed9288bde641b4fecb9578fa428d54334e53.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">etadisl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v_i</span><span class="p">,</span> <span class="n">T_i</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dislocation creep viscosity given a velocity and temperature</span>

<span class="sd">        Arguments:</span>
<span class="sd">          * v_i - velocity Function</span>
<span class="sd">          * T_i - temperature Function</span>

<span class="sd">        Returns:</span>
<span class="sd">          * eta - viscosity ufl description</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># get the mesh</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">v_i</span><span class="o">.</span><span class="n">function_space</span><span class="o">.</span><span class="n">mesh</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">SpatialCoordinate</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">zero_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="n">deltaztrench_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="p">))</span>
        <span class="n">deltazsurface</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">operators</span><span class="o">.</span><span class="n">MinValue</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">operators</span><span class="o">.</span><span class="n">MaxValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaxcoast</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)),</span> <span class="n">zero_c</span><span class="p">),</span> <span class="n">deltaztrench_c</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">deltazsurface</span><span class="p">)</span>
        
        <span class="c1"># dimensional temperature in Kelvin with an adiabat added</span>
        <span class="n">Tdim</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">nondim_to_K</span><span class="p">(</span><span class="n">T_i</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">z</span>
        
        <span class="n">E_c</span>          <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">))</span>
        <span class="n">invetamax_c</span>  <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eta0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">etamax</span><span class="p">))</span>
        <span class="n">neII</span>         <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsigma</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nsigma</span>
        <span class="n">invetafact_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eta0</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e0</span><span class="o">**</span><span class="n">neII</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Aeta</span><span class="p">))</span>
        <span class="n">neII_c</span>       <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="n">neII</span><span class="p">))</span>
    
        <span class="c1"># strain rate</span>
        <span class="n">edot</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_i</span><span class="p">))</span>
        <span class="n">eII</span>  <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">edot</span><span class="p">,</span> <span class="n">edot</span><span class="p">))</span>
        <span class="c1"># inverse dimensionless dislocation creep viscosity</span>
        <span class="n">invetadisl</span> <span class="o">=</span> <span class="n">invetafact_c</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">E_c</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsigma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="n">Tdim</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">eII</span><span class="o">**</span><span class="n">neII_c</span><span class="p">)</span>
        <span class="c1"># inverse dimensionless effective viscosity</span>
        <span class="n">inveta</span> <span class="o">=</span> <span class="n">invetadisl</span> <span class="o">+</span> <span class="n">invetamax_c</span>
        <span class="c1"># &quot;harmonic mean&quot; viscosity (actually twice the harmonic mean)</span>
        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="n">inveta</span>

    <span class="k">def</span> <span class="nf">project_dislocationcreep_viscosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_eta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">petsc_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Project the dislocation creep viscosity to the mesh.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">          * peta          - finite element degree of viscosity Function (defaults to 0)</span>
<span class="sd">          * petsc_options - a dictionary of petsc options to pass to the solver (defaults to mumps)</span>

<span class="sd">        Returns:</span>
<span class="sd">          * eta_i - the viscosity Function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">petsc_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">petsc_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;preonly&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;lu&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_factor_mat_solver_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">}</span>
        <span class="c1"># set up the functionspace</span>
        <span class="n">V_eta</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="n">p_eta</span><span class="p">))</span>
        <span class="c1"># declare the domain wide Function</span>
        <span class="n">eta_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_eta</span><span class="p">)</span>
        <span class="c1"># set it to etamax everywhere (will get overwritten)</span>
        <span class="n">eta_i</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etamax</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">eta0</span>
        
        <span class="k">def</span> <span class="nf">solve_viscosity</span><span class="p">(</span><span class="n">v_i</span><span class="p">,</span> <span class="n">T_i</span><span class="p">,</span> <span class="n">cell_map</span><span class="p">,</span> <span class="n">reverse_cell_map</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Solve for the viscosity in subdomains and interpolate it to the parent Function</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">T_i</span><span class="o">.</span><span class="n">functionspace</span><span class="o">.</span><span class="n">mesh</span>
            <span class="n">Vwedge_eta</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="n">p_eta</span><span class="p">))</span>
            <span class="n">eta_a</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">Vwedge_eta</span><span class="p">)</span>
            <span class="n">eta_t</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">Vwedge_eta</span><span class="p">)</span>
            <span class="n">Seta</span> <span class="o">=</span> <span class="n">eta_t</span><span class="o">*</span><span class="n">eta_a</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
            <span class="n">feta</span> <span class="o">=</span> <span class="n">eta_t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">etadisl</span><span class="p">(</span><span class="n">v_i</span><span class="p">,</span> <span class="n">T_i</span><span class="p">)</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
            <span class="n">problem</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">Seta</span><span class="p">,</span> <span class="n">feta</span><span class="p">,</span> <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>
            <span class="n">leta_i</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="n">eta_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">leta_i</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="n">cell_map</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse_cell_map</span><span class="p">)</span>

        <span class="c1"># solve in the wedge</span>
        <span class="n">solve_viscosity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vw_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_T_i</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_reverse_cell_map</span><span class="p">)</span>
        <span class="c1"># solve in the slab</span>
        <span class="n">solve_viscosity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vw_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_T_i</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_reverse_cell_map</span><span class="p">)</span>

        <span class="c1"># return the viscosity</span>
        <span class="k">return</span> <span class="n">eta_i</span>
    
    <span class="k">def</span> <span class="nf">solve_steadystate_dislocationcreep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">5.e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">5.e-9</span><span class="p">,</span> <span class="n">maxits</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                                           <span class="n">petsc_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the Stokes problems assuming a dislocation creep rheology.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">          * rtol          - nonlinear iteration relative tolerance</span>
<span class="sd">          * atol          - nonlinear iteration absolute tolerance</span>
<span class="sd">          * maxits        - maximum number of nonlinear iterations</span>
<span class="sd">          * petsc_options - a dictionary of petsc options to pass to the solver (defaults to mumps)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">petsc_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">petsc_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;preonly&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;lu&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_factor_mat_solver_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">}</span>
            
        <span class="c1"># first solve the isoviscous problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_stokes_isoviscous</span><span class="p">(</span><span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>

        <span class="c1"># retrieve the temperature forms</span>
        <span class="n">ST</span><span class="p">,</span> <span class="n">fT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_forms_steadystate</span><span class="p">()</span>
        <span class="n">problem_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">ST</span><span class="p">,</span> <span class="n">fT</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span>
                                               <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>
        <span class="c1"># and solve the temperature problem, given the isoviscous Stokes solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span> <span class="o">=</span> <span class="n">problem_T</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_T_functions</span><span class="p">()</span>
        
        <span class="c1"># retrive the non-linear Stokes forms for the wedge</span>
        <span class="n">Ssw</span><span class="p">,</span> <span class="n">fsw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_forms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_a</span><span class="p">,</span> \
                                     <span class="bp">self</span><span class="o">.</span><span class="n">wedge_submesh</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">etadisl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vw_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_T_i</span><span class="p">))</span>
        <span class="n">problem_vpw</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">Ssw</span><span class="p">,</span> <span class="n">fsw</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span><span class="p">,</span> 
                                                 <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>

        <span class="c1"># retrive the non-linear Stokes forms for the slab</span>
        <span class="n">Sss</span><span class="p">,</span> <span class="n">fss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_forms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_a</span><span class="p">,</span> \
                                     <span class="bp">self</span><span class="o">.</span><span class="n">slab_submesh</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">etadisl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vs_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_T_i</span><span class="p">))</span>
        <span class="n">problem_vps</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">Sss</span><span class="p">,</span> <span class="n">fss</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs_vps</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span><span class="p">,</span>
                                                 <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>

        <span class="c1"># define the non-linear residual for the wedge velocity-pressure</span>
        <span class="n">rw</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">Ssw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span><span class="p">)</span> <span class="o">-</span> <span class="n">fsw</span>
        <span class="c1"># define the non-linear residual for the slab velocity-pressure</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">Sss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span><span class="p">)</span> <span class="o">-</span> <span class="n">fss</span>
        <span class="c1"># define the non-linear residual for the temperature</span>
        <span class="n">rT</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">ST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="p">)</span> <span class="o">-</span> <span class="n">fT</span>

        <span class="k">def</span> <span class="nf">calculate_residual</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the total residual of the problem</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">rw_vec</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_vector</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">rw</span><span class="p">))</span>
            <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">set_bc</span><span class="p">(</span><span class="n">rw_vec</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">rs_vec</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_vector</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span>
            <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">set_bc</span><span class="p">(</span><span class="n">rs_vec</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vps</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">rT_vec</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_vector</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">rT</span><span class="p">))</span>
            <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">set_bc</span><span class="p">(</span><span class="n">rT_vec</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rw_vec</span><span class="o">.</span><span class="n">petsc_vec</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
                        <span class="n">rs_vec</span><span class="o">.</span><span class="n">petsc_vec</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
                        <span class="n">rT_vec</span><span class="o">.</span><span class="n">petsc_vec</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="c1"># calculate the initial residual</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">calculate_residual</span><span class="p">()</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">rrel</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">r0</span>  <span class="c1"># 1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;11}</span><span class="s2"> </span><span class="si">{:&lt;12}</span><span class="s2"> </span><span class="si">{:&lt;17}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">,</span><span class="s1">&#39;Residual&#39;</span><span class="p">,</span><span class="s1">&#39;Relative Residual&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>

        <span class="c1"># iterate until the residual converges (hopefully)</span>
        <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;11}</span><span class="s2"> </span><span class="si">{:&lt;12.6g}</span><span class="s2"> </span><span class="si">{:&lt;12.6g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rrel</span><span class="p">,))</span>
        <span class="k">while</span> <span class="n">rrel</span> <span class="o">&gt;</span> <span class="n">rtol</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">atol</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;</span> <span class="n">maxits</span><span class="p">:</span> <span class="k">break</span>
            <span class="c1"># solve for v &amp; p and interpolate it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span> <span class="o">=</span> <span class="n">problem_vpw</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span>  <span class="o">=</span> <span class="n">problem_vps</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_v_functions</span><span class="p">()</span>
            <span class="c1"># solve for T and interpolate it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span> <span class="o">=</span> <span class="n">problem_T</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_T_functions</span><span class="p">()</span>
            <span class="c1"># calculate a new residual</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">calculate_residual</span><span class="p">()</span>
            <span class="n">rrel</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">r0</span>
            <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;11}</span><span class="s2"> </span><span class="si">{:&lt;12.6g}</span><span class="s2"> </span><span class="si">{:&lt;12.6g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rrel</span><span class="p">,))</span>

        <span class="c1"># check for convergence failures</span>
        <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;</span> <span class="n">maxits</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Nonlinear iteration failed to converge after </span><span class="si">{}</span><span class="s2"> iterations (maxits = </span><span class="si">{}</span><span class="s2">), r = </span><span class="si">{}</span><span class="s2"> (atol = </span><span class="si">{}</span><span class="s2">), rrel = </span><span class="si">{}</span><span class="s2"> (rtol = </span><span class="si">{}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> \
                                                                                                                                                          <span class="n">maxits</span><span class="p">,</span> \
                                                                                                                                                          <span class="n">r</span><span class="p">,</span> \
                                                                                                                                                          <span class="n">rtol</span><span class="p">,</span> \
                                                                                                                                                          <span class="n">rrel</span><span class="p">,</span> \
                                                                                                                                                          <span class="n">rtol</span><span class="p">,))</span>

        <span class="c1"># only update the pressure at the end as it is not necessary earlier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_p_functions</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">io_depth_2</span> <span class="o">=</span> <span class="mf">154.0</span>
<span class="n">geom_case2</span> <span class="o">=</span> <span class="n">create_sz_geometry</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> <span class="n">resscale</span><span class="p">,</span> <span class="n">sztype</span><span class="p">,</span> <span class="n">io_depth_2</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">,</span> 
                                <span class="n">coast_distance</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">,</span> <span class="n">uc_depth</span><span class="p">)</span>
<span class="n">sz_case2</span> <span class="o">=</span> <span class="n">SubductionProblem</span><span class="p">(</span><span class="n">geom_case2</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">Vs</span><span class="o">=</span><span class="n">Vs</span><span class="p">,</span> <span class="n">sztype</span><span class="o">=</span><span class="n">sztype</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Solving steady state flow with dislocation creep rheology...&quot;</span><span class="p">)</span>
<span class="n">sz_case2</span><span class="o">.</span><span class="n">solve_steadystate_dislocationcreep</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Getting diagnostics...&quot;</span><span class="p">)</span>
<span class="n">sz_case2</span><span class="o">.</span><span class="n">get_diagnostics</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning : Gmsh has aleady been initialized
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Info    : Meshing 1D...
Info    : [  0%] Meshing curve 1 (Line)
Info    : [ 10%] Meshing curve 2 (Line)
Info    : [ 10%] Meshing curve 3 (Line)
Info    : [ 10%] Meshing curve 4 (Line)
Info    : [ 10%] Meshing curve 5 (Line)
Info    : [ 10%] Meshing curve 6 (Line)
Info    : [ 10%] Meshing curve 7 (Line)
Info    : [ 10%] Meshing curve 8 (Line)
Info    : [ 10%] Meshing curve 9 (Line)
Info    : [ 10%] Meshing curve 10 (Line)
Info    : [ 20%] Meshing curve 11 (Line)
Info    : [ 20%] Meshing curve 12 (Line)
Info    : [ 20%] Meshing curve 13 (Line)
Info    : [ 20%] Meshing curve 14 (Line)
Info    : [ 20%] Meshing curve 15 (Line)
Info    : [ 20%] Meshing curve 16 (Line)
Info    : [ 20%] Meshing curve 17 (Line)
Info    : [ 20%] Meshing curve 18 (Line)
Info    : [ 20%] Meshing curve 19 (Line)
Info    : [ 30%] Meshing curve 20 (Line)
Info    : [ 30%] Meshing curve 21 (Line)
Info    : [ 30%] Meshing curve 22 (Line)
Info    : [ 30%] Meshing curve 23 (Line)
Info    : [ 30%] Meshing curve 24 (Line)
Info    : [ 30%] Meshing curve 25 (Line)
Info    : [ 30%] Meshing curve 27 (Line)
Info    : [ 30%] Meshing curve 28 (Line)
Info    : [ 30%] Meshing curve 29 (Line)
Info    : [ 40%] Meshing curve 30 (Line)
Info    : [ 40%] Meshing curve 31 (Line)
Info    : [ 40%] Meshing curve 32 (Line)
Info    : [ 40%] Meshing curve 33 (Line)
Info    : [ 40%] Meshing curve 34 (Line)
Info    : [ 40%] Meshing curve 35 (Line)
Info    : [ 40%] Meshing curve 36 (Line)
Info    : [ 40%] Meshing curve 37 (Line)
Info    : [ 40%] Meshing curve 38 (Line)
Info    : [ 50%] Meshing curve 39 (Line)
Info    : [ 50%] Meshing curve 40 (Line)
Info    : [ 50%] Meshing curve 41 (Line)
Info    : [ 50%] Meshing curve 42 (Line)
Info    : [ 50%] Meshing curve 43 (Line)
Info    : [ 50%] Meshing curve 44 (Line)
Info    : [ 50%] Meshing curve 45 (Line)
Info    : [ 50%] Meshing curve 46 (Line)
Info    : [ 50%] Meshing curve 47 (Line)
Info    : [ 60%] Meshing curve 48 (Line)
Info    : [ 60%] Meshing curve 49 (Line)
Info    : [ 60%] Meshing curve 50 (Line)
Info    : [ 60%] Meshing curve 51 (Line)
Info    : [ 60%] Meshing curve 52 (Line)
Info    : [ 60%] Meshing curve 54 (Line)
Info    : [ 60%] Meshing curve 55 (Line)
Info    : [ 60%] Meshing curve 56 (Line)
Info    : [ 60%] Meshing curve 57 (Line)
Info    : [ 70%] Meshing curve 58 (Line)
Info    : [ 70%] Meshing curve 59 (Line)
Info    : [ 70%] Meshing curve 60 (Line)
Info    : [ 70%] Meshing curve 61 (Line)
Info    : [ 70%] Meshing curve 62 (Line)
Info    : [ 70%] Meshing curve 63 (Line)
Info    : [ 70%] Meshing curve 64 (Line)
Info    : [ 70%] Meshing curve 65 (Line)
Info    : [ 70%] Meshing curve 66 (Line)
Info    : [ 80%] Meshing curve 67 (Line)
Info    : [ 80%] Meshing curve 68 (Line)
Info    : [ 80%] Meshing curve 70 (Line)
Info    : [ 80%] Meshing curve 71 (Line)
Info    : [ 80%] Meshing curve 72 (Line)
Info    : [ 80%] Meshing curve 73 (Line)
Info    : [ 80%] Meshing curve 74 (Line)
Info    : [ 80%] Meshing curve 75 (Line)
Info    : [ 80%] Meshing curve 76 (Line)
Info    : [ 90%] Meshing curve 77 (Line)
Info    : [ 90%] Meshing curve 78 (Line)
Info    : [ 90%] Meshing curve 79 (Line)
Info    : [ 90%] Meshing curve 80 (Line)
Info    : [ 90%] Meshing curve 81 (Line)
Info    : [ 90%] Meshing curve 82 (Line)
Info    : [ 90%] Meshing curve 83 (Line)
Info    : [ 90%] Meshing curve 85 (Line)
Info    : [ 90%] Meshing curve 86 (Line)
Info    : [100%] Meshing curve 87 (Line)
Info    : [100%] Meshing curve 88 (Line)
Info    : [100%] Meshing curve 89 (Line)
Info    : [100%] Meshing curve 90 (Line)
Info    : [100%] Meshing curve 91 (Line)
Info    : [100%] Meshing curve 92 (Line)
Info    : [100%] Meshing curve 93 (Line)
Info    : [100%] Meshing curve 95 (Line)
Info    : [100%] Meshing curve 96 (Line)
Info    : Done meshing 1D (Wall 0.0233965s, CPU 0.027245s)
Info    : Meshing 2D...
Info    : [  0%] Meshing surface 1 (Plane, Frontal-Delaunay)
Info    : [ 20%] Meshing surface 2 (Plane, Frontal-Delaunay)
Info    : [ 40%] Meshing surface 3 (Plane, Frontal-Delaunay)
Info    : [ 50%] Meshing surface 4 (Plane, Frontal-Delaunay)
Info    : [ 70%] Meshing surface 5 (Plane, Frontal-Delaunay)
Info    : [ 90%] Meshing surface 6 (Plane, Frontal-Delaunay)
Info    : Done meshing 2D (Wall 0.0418399s, CPU 0.042656s)
Info    : 1485 nodes 3261 elements
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Solving steady state flow with dislocation creep rheology...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration   Residual     Relative Residual
------------------------------------------
0           14039.3      1           
1           1161.26      0.0827153   
2           256.735      0.0182869   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3           103.968      0.0074055   
4           48.9798      0.00348877  
5           26.4549      0.00188435  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6           16.1772      0.00115228  
7           10.7653      0.0007668   
8           7.60442      0.000541653 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9           5.59295      0.000398379 
10          4.21471      0.000300209 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>11          3.22359      0.000229612 
12          2.4908       0.000177416 
13          1.93954      0.000138151 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14          1.51997      0.000108266 
15          1.19783      8.53198e-05 
16          0.948679     6.75732e-05 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>17          0.754764     5.37609e-05 
18          0.602991     4.29503e-05 
19          0.483598     3.44461e-05 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>20          0.389239     2.7725e-05  
21          0.314337     2.23898e-05 
22          0.254634     1.81372e-05 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>23          0.206858     1.47342e-05 
24          0.168483     1.20008e-05 
25          0.13755      9.79752e-06 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>26          0.112533     8.01558e-06 
27          0.0922379    6.56999e-06 
28          0.0757272    5.39395e-06 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>29          0.0622606    4.43474e-06 

Getting diagnostics...
T_(200,-100) = 679.02 deg C
T_slab = 568.56 deg C
T_wedge = 941.66 deg C
V_rms,w = 41.96 mm/yr
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(679.0165582974065, 568.5575244828643, 941.6614848649151, 41.95606755393729)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utils</span><span class="o">.</span><span class="n">plot_scalar</span><span class="p">(</span><span class="n">sz_case2</span><span class="o">.</span><span class="n">T_i</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_vector</span><span class="p">(</span><span class="n">sz_case2</span><span class="o">.</span><span class="n">vw_i</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_vector</span><span class="p">(</span><span class="n">sz_case2</span><span class="o">.</span><span class="n">vs_i</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/da079a69fa4579ae474b741876975dc9fefcd0234cd0e18cc13758f999aca56f.png" src="../_images/da079a69fa4579ae474b741876975dc9fefcd0234cd0e18cc13758f999aca56f.png" />
<img alt="../_images/61f6894482f8fa07d40c411e6f0c123034c83906554965e60c75a43f3fe40590.png" src="../_images/61f6894482f8fa07d40c411e6f0c123034c83906554965e60c75a43f3fe40590.png" />
<img alt="../_images/7bd9d0621d2d9f07af6b00b6e1145123493f3b335f7b59c2a6d7efbf8e10d044.png" src="../_images/7bd9d0621d2d9f07af6b00b6e1145123493f3b335f7b59c2a6d7efbf8e10d044.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_slab_temperatures</span><span class="p">(</span><span class="n">sz_case2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/14e2b2b982f647232793a6468f10bfe105cb02ae7b7c442275060ff0b767dbf1.png" src="../_images/14e2b2b982f647232793a6468f10bfe105cb02ae7b7c442275060ff0b767dbf1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resscale2</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">slab_resscale2</span> <span class="o">=</span> <span class="n">create_slab</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">resscale2</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">)</span>
<span class="n">geom_resscale2</span> <span class="o">=</span> <span class="n">create_sz_geometry</span><span class="p">(</span><span class="n">slab_resscale2</span><span class="p">,</span> <span class="n">resscale2</span><span class="p">,</span> <span class="n">sztype</span><span class="p">,</span> <span class="n">io_depth_1</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">,</span> 
                           <span class="n">coast_distance</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">,</span> <span class="n">uc_depth</span><span class="p">)</span>
<span class="n">sz_resscale2</span> <span class="o">=</span> <span class="n">SubductionProblem</span><span class="p">(</span><span class="n">geom_resscale2</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">Vs</span><span class="o">=</span><span class="n">Vs</span><span class="p">,</span> <span class="n">sztype</span><span class="o">=</span><span class="n">sztype</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Solving steady state flow with isoviscous rheology...&quot;</span><span class="p">)</span>
<span class="n">sz_resscale2</span><span class="o">.</span><span class="n">solve_steadystate_isoviscous</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Getting diagnostics...&quot;</span><span class="p">)</span>
<span class="n">sz_resscale2</span><span class="o">.</span><span class="n">get_diagnostics</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning : Gmsh has aleady been initialized
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Info    : Meshing 1D...
Info    : [  0%] Meshing curve 1 (Line)
Info    : [ 10%] Meshing curve 2 (Line)
Info    : [ 10%] Meshing curve 3 (Line)
Info    : [ 10%] Meshing curve 4 (Line)
Info    : [ 10%] Meshing curve 5 (Line)
Info    : [ 10%] Meshing curve 6 (Line)
Info    : [ 10%] Meshing curve 7 (Line)
Info    : [ 10%] Meshing curve 8 (Line)
Info    : [ 10%] Meshing curve 9 (Line)
Info    : [ 10%] Meshing curve 10 (Line)
Info    : [ 10%] Meshing curve 11 (Line)
Info    : [ 10%] Meshing curve 12 (Line)
Info    : [ 10%] Meshing curve 13 (Line)
Info    : [ 10%] Meshing curve 14 (Line)
Info    : [ 10%] Meshing curve 15 (Line)
Info    : [ 10%] Meshing curve 16 (Line)
Info    : [ 10%] Meshing curve 17 (Line)
Info    : [ 10%] Meshing curve 18 (Line)
Info    : [ 10%] Meshing curve 19 (Line)
Info    : [ 10%] Meshing curve 20 (Line)
Info    : [ 10%] Meshing curve 21 (Line)
Info    : [ 20%] Meshing curve 22 (Line)
Info    : [ 20%] Meshing curve 23 (Line)
Info    : [ 20%] Meshing curve 24 (Line)
Info    : [ 20%] Meshing curve 25 (Line)
Info    : [ 20%] Meshing curve 26 (Line)
Info    : [ 20%] Meshing curve 27 (Line)
Info    : [ 20%] Meshing curve 28 (Line)
Info    : [ 20%] Meshing curve 29 (Line)
Info    : [ 20%] Meshing curve 30 (Line)
Info    : [ 20%] Meshing curve 31 (Line)
Info    : [ 20%] Meshing curve 32 (Line)
Info    : [ 20%] Meshing curve 33 (Line)
Info    : [ 20%] Meshing curve 34 (Line)
Info    : [ 20%] Meshing curve 35 (Line)
Info    : [ 20%] Meshing curve 36 (Line)
Info    : [ 20%] Meshing curve 37 (Line)
Info    : [ 20%] Meshing curve 38 (Line)
Info    : [ 20%] Meshing curve 39 (Line)
Info    : [ 20%] Meshing curve 40 (Line)
Info    : [ 20%] Meshing curve 41 (Line)
Info    : [ 30%] Meshing curve 42 (Line)
Info    : [ 30%] Meshing curve 43 (Line)
Info    : [ 30%] Meshing curve 44 (Line)
Info    : [ 30%] Meshing curve 45 (Line)
Info    : [ 30%] Meshing curve 46 (Line)
Info    : [ 30%] Meshing curve 47 (Line)
Info    : [ 30%] Meshing curve 48 (Line)
Info    : [ 30%] Meshing curve 49 (Line)
Info    : [ 30%] Meshing curve 50 (Line)
Info    : [ 30%] Meshing curve 51 (Line)
Info    : [ 30%] Meshing curve 52 (Line)
Info    : [ 30%] Meshing curve 53 (Line)
Info    : [ 30%] Meshing curve 54 (Line)
Info    : [ 30%] Meshing curve 56 (Line)
Info    : [ 30%] Meshing curve 57 (Line)
Info    : [ 30%] Meshing curve 58 (Line)
Info    : [ 30%] Meshing curve 59 (Line)
Info    : [ 30%] Meshing curve 60 (Line)
Info    : [ 30%] Meshing curve 61 (Line)
Info    : [ 30%] Meshing curve 62 (Line)
Info    : [ 40%] Meshing curve 63 (Line)
Info    : [ 40%] Meshing curve 64 (Line)
Info    : [ 40%] Meshing curve 65 (Line)
Info    : [ 40%] Meshing curve 66 (Line)
Info    : [ 40%] Meshing curve 67 (Line)
Info    : [ 40%] Meshing curve 68 (Line)
Info    : [ 40%] Meshing curve 69 (Line)
Info    : [ 40%] Meshing curve 70 (Line)
Info    : [ 40%] Meshing curve 71 (Line)
Info    : [ 40%] Meshing curve 72 (Line)
Info    : [ 40%] Meshing curve 73 (Line)
Info    : [ 40%] Meshing curve 74 (Line)
Info    : [ 40%] Meshing curve 75 (Line)
Info    : [ 40%] Meshing curve 76 (Line)
Info    : [ 40%] Meshing curve 77 (Line)
Info    : [ 40%] Meshing curve 78 (Line)
Info    : [ 40%] Meshing curve 79 (Line)
Info    : [ 40%] Meshing curve 80 (Line)
Info    : [ 40%] Meshing curve 81 (Line)
Info    : [ 40%] Meshing curve 82 (Line)
Info    : [ 50%] Meshing curve 83 (Line)
Info    : [ 50%] Meshing curve 84 (Line)
Info    : [ 50%] Meshing curve 85 (Line)
Info    : [ 50%] Meshing curve 86 (Line)
Info    : [ 50%] Meshing curve 87 (Line)
Info    : [ 50%] Meshing curve 88 (Line)
Info    : [ 50%] Meshing curve 89 (Line)
Info    : [ 50%] Meshing curve 90 (Line)
Info    : [ 50%] Meshing curve 91 (Line)
Info    : [ 50%] Meshing curve 92 (Line)
Info    : [ 50%] Meshing curve 93 (Line)
Info    : [ 50%] Meshing curve 94 (Line)
Info    : [ 50%] Meshing curve 95 (Line)
Info    : [ 50%] Meshing curve 96 (Line)
Info    : [ 50%] Meshing curve 97 (Line)
Info    : [ 50%] Meshing curve 98 (Line)
Info    : [ 50%] Meshing curve 99 (Line)
Info    : [ 50%] Meshing curve 100 (Line)
Info    : [ 50%] Meshing curve 101 (Line)
Info    : [ 50%] Meshing curve 102 (Line)
Info    : [ 60%] Meshing curve 103 (Line)
Info    : [ 60%] Meshing curve 104 (Line)
Info    : [ 60%] Meshing curve 105 (Line)
Info    : [ 60%] Meshing curve 106 (Line)
Info    : [ 60%] Meshing curve 107 (Line)
Info    : [ 60%] Meshing curve 108 (Line)
Info    : [ 60%] Meshing curve 109 (Line)
Info    : [ 60%] Meshing curve 110 (Line)
Info    : [ 60%] Meshing curve 111 (Line)
Info    : [ 60%] Meshing curve 112 (Line)
Info    : [ 60%] Meshing curve 113 (Line)
Info    : [ 60%] Meshing curve 114 (Line)
Info    : [ 60%] Meshing curve 115 (Line)
Info    : [ 60%] Meshing curve 117 (Line)
Info    : [ 60%] Meshing curve 118 (Line)
Info    : [ 60%] Meshing curve 119 (Line)
Info    : [ 60%] Meshing curve 120 (Line)
Info    : [ 60%] Meshing curve 121 (Line)
Info    : [ 60%] Meshing curve 122 (Line)
Info    : [ 60%] Meshing curve 123 (Line)
Info    : [ 70%] Meshing curve 124 (Line)
Info    : [ 70%] Meshing curve 125 (Line)
Info    : [ 70%] Meshing curve 126 (Line)
Info    : [ 70%] Meshing curve 127 (Line)
Info    : [ 70%] Meshing curve 128 (Line)
Info    : [ 70%] Meshing curve 129 (Line)
Info    : [ 70%] Meshing curve 130 (Line)
Info    : [ 70%] Meshing curve 131 (Line)
Info    : [ 70%] Meshing curve 132 (Line)
Info    : [ 70%] Meshing curve 133 (Line)
Info    : [ 70%] Meshing curve 134 (Line)
Info    : [ 70%] Meshing curve 135 (Line)
Info    : [ 70%] Meshing curve 136 (Line)
Info    : [ 70%] Meshing curve 137 (Line)
Info    : [ 70%] Meshing curve 138 (Line)
Info    : [ 70%] Meshing curve 139 (Line)
Info    : [ 70%] Meshing curve 140 (Line)
Info    : [ 70%] Meshing curve 141 (Line)
Info    : [ 70%] Meshing curve 142 (Line)
Info    : [ 70%] Meshing curve 143 (Line)
Info    : [ 80%] Meshing curve 144 (Line)
Info    : [ 80%] Meshing curve 145 (Line)
Info    : [ 80%] Meshing curve 146 (Line)
Info    : [ 80%] Meshing curve 147 (Line)
Info    : [ 80%] Meshing curve 148 (Line)
Info    : [ 80%] Meshing curve 149 (Line)
Info    : [ 80%] Meshing curve 150 (Line)
Info    : [ 80%] Meshing curve 151 (Line)
Info    : [ 80%] Meshing curve 153 (Line)
Info    : [ 80%] Meshing curve 154 (Line)
Info    : [ 80%] Meshing curve 155 (Line)
Info    : [ 80%] Meshing curve 156 (Line)
Info    : [ 80%] Meshing curve 157 (Line)
Info    : [ 80%] Meshing curve 158 (Line)
Info    : [ 80%] Meshing curve 159 (Line)
Info    : [ 80%] Meshing curve 160 (Line)
Info    : [ 80%] Meshing curve 161 (Line)
Info    : [ 80%] Meshing curve 162 (Line)
Info    : [ 80%] Meshing curve 163 (Line)
Info    : [ 80%] Meshing curve 164 (Line)
Info    : [ 90%] Meshing curve 165 (Line)
Info    : [ 90%] Meshing curve 166 (Line)
Info    : [ 90%] Meshing curve 167 (Line)
Info    : [ 90%] Meshing curve 168 (Line)
Info    : [ 90%] Meshing curve 169 (Line)
Info    : [ 90%] Meshing curve 170 (Line)
Info    : [ 90%] Meshing curve 171 (Line)
Info    : [ 90%] Meshing curve 172 (Line)
Info    : [ 90%] Meshing curve 173 (Line)
Info    : [ 90%] Meshing curve 174 (Line)
Info    : [ 90%] Meshing curve 175 (Line)
Info    : [ 90%] Meshing curve 176 (Line)
Info    : [ 90%] Meshing curve 177 (Line)
Info    : [ 90%] Meshing curve 178 (Line)
Info    : [ 90%] Meshing curve 179 (Line)
Info    : [ 90%] Meshing curve 180 (Line)
Info    : [ 90%] Meshing curve 181 (Line)
Info    : [ 90%] Meshing curve 182 (Line)
Info    : [ 90%] Meshing curve 184 (Line)
Info    : [ 90%] Meshing curve 185 (Line)
Info    : [100%] Meshing curve 186 (Line)
Info    : [100%] Meshing curve 187 (Line)
Info    : [100%] Meshing curve 188 (Line)
Info    : [100%] Meshing curve 189 (Line)
Info    : [100%] Meshing curve 190 (Line)
Info    : [100%] Meshing curve 191 (Line)
Info    : [100%] Meshing curve 192 (Line)
Info    : [100%] Meshing curve 193 (Line)
Info    : [100%] Meshing curve 194 (Line)
Info    : [100%] Meshing curve 195 (Line)
Info    : [100%] Meshing curve 196 (Line)
Info    : [100%] Meshing curve 197 (Line)
Info    : [100%] Meshing curve 198 (Line)
Info    : [100%] Meshing curve 199 (Line)
Info    : [100%] Meshing curve 200 (Line)
Info    : [100%] Meshing curve 201 (Line)
Info    : [100%] Meshing curve 202 (Line)
Info    : [100%] Meshing curve 204 (Line)
Info    : [100%] Meshing curve 205 (Line)
Info    : Done meshing 1D (Wall 0.0243638s, CPU 0.030105s)
Info    : Meshing 2D...
Info    : [  0%] Meshing surface 1 (Plane, Frontal-Delaunay)
Info    : [ 20%] Meshing surface 2 (Plane, Frontal-Delaunay)
Info    : [ 40%] Meshing surface 3 (Plane, Frontal-Delaunay)
Info    : [ 50%] Meshing surface 4 (Plane, Frontal-Delaunay)
Info    : [ 70%] Meshing surface 5 (Plane, Frontal-Delaunay)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Info    : [ 90%] Meshing surface 6 (Plane, Frontal-Delaunay)
Info    : Done meshing 2D (Wall 0.271465s, CPU 0.27579s)
Info    : 8238 nodes 17176 elements
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Solving steady state flow with isoviscous rheology...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Getting diagnostics...
T_(200,-100) = 516.93 deg C
T_slab = 451.68 deg C
T_wedge = 926.26 deg C
V_rms,w = 34.64 mm/yr
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(516.9331851351905, 451.6764254758145, 926.2604497169629, 34.63786517428655)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">geom_case2_resscale2</span> <span class="o">=</span> <span class="n">create_sz_geometry</span><span class="p">(</span><span class="n">slab_resscale2</span><span class="p">,</span> <span class="n">resscale2</span><span class="p">,</span> <span class="n">sztype</span><span class="p">,</span> <span class="n">io_depth_2</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">,</span> 
                                          <span class="n">coast_distance</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">,</span> <span class="n">uc_depth</span><span class="p">)</span>
<span class="n">sz_resscale2</span> <span class="o">=</span> <span class="n">SubductionProblem</span><span class="p">(</span><span class="n">geom_case2_resscale2</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">Vs</span><span class="o">=</span><span class="n">Vs</span><span class="p">,</span> <span class="n">sztype</span><span class="o">=</span><span class="n">sztype</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Solving steady state flow with dislocation creep rheology...&quot;</span><span class="p">)</span>
<span class="n">sz_resscale2</span><span class="o">.</span><span class="n">solve_steadystate_dislocationcreep</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Getting diagnostics...&quot;</span><span class="p">)</span>
<span class="n">sz_resscale2</span><span class="o">.</span><span class="n">get_diagnostics</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning : Gmsh has aleady been initialized
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Info    : Meshing 1D...
Info    : [  0%] Meshing curve 1 (Line)
Info    : [ 10%] Meshing curve 2 (Line)
Info    : [ 10%] Meshing curve 3 (Line)
Info    : [ 10%] Meshing curve 4 (Line)
Info    : [ 10%] Meshing curve 5 (Line)
Info    : [ 10%] Meshing curve 6 (Line)
Info    : [ 10%] Meshing curve 7 (Line)
Info    : [ 10%] Meshing curve 8 (Line)
Info    : [ 10%] Meshing curve 9 (Line)
Info    : [ 10%] Meshing curve 10 (Line)
Info    : [ 10%] Meshing curve 11 (Line)
Info    : [ 10%] Meshing curve 12 (Line)
Info    : [ 10%] Meshing curve 13 (Line)
Info    : [ 10%] Meshing curve 14 (Line)
Info    : [ 10%] Meshing curve 15 (Line)
Info    : [ 10%] Meshing curve 16 (Line)
Info    : [ 10%] Meshing curve 17 (Line)
Info    : [ 10%] Meshing curve 18 (Line)
Info    : [ 10%] Meshing curve 19 (Line)
Info    : [ 10%] Meshing curve 20 (Line)
Info    : [ 10%] Meshing curve 21 (Line)
Info    : [ 20%] Meshing curve 22 (Line)
Info    : [ 20%] Meshing curve 23 (Line)
Info    : [ 20%] Meshing curve 24 (Line)
Info    : [ 20%] Meshing curve 25 (Line)
Info    : [ 20%] Meshing curve 26 (Line)
Info    : [ 20%] Meshing curve 27 (Line)
Info    : [ 20%] Meshing curve 28 (Line)
Info    : [ 20%] Meshing curve 29 (Line)
Info    : [ 20%] Meshing curve 30 (Line)
Info    : [ 20%] Meshing curve 31 (Line)
Info    : [ 20%] Meshing curve 32 (Line)
Info    : [ 20%] Meshing curve 33 (Line)
Info    : [ 20%] Meshing curve 34 (Line)
Info    : [ 20%] Meshing curve 35 (Line)
Info    : [ 20%] Meshing curve 36 (Line)
Info    : [ 20%] Meshing curve 37 (Line)
Info    : [ 20%] Meshing curve 38 (Line)
Info    : [ 20%] Meshing curve 39 (Line)
Info    : [ 20%] Meshing curve 40 (Line)
Info    : [ 20%] Meshing curve 41 (Line)
Info    : [ 30%] Meshing curve 42 (Line)
Info    : [ 30%] Meshing curve 43 (Line)
Info    : [ 30%] Meshing curve 44 (Line)
Info    : [ 30%] Meshing curve 45 (Line)
Info    : [ 30%] Meshing curve 46 (Line)
Info    : [ 30%] Meshing curve 47 (Line)
Info    : [ 30%] Meshing curve 48 (Line)
Info    : [ 30%] Meshing curve 49 (Line)
Info    : [ 30%] Meshing curve 50 (Line)
Info    : [ 30%] Meshing curve 51 (Line)
Info    : [ 30%] Meshing curve 52 (Line)
Info    : [ 30%] Meshing curve 53 (Line)
Info    : [ 30%] Meshing curve 54 (Line)
Info    : [ 30%] Meshing curve 56 (Line)
Info    : [ 30%] Meshing curve 57 (Line)
Info    : [ 30%] Meshing curve 58 (Line)
Info    : [ 30%] Meshing curve 59 (Line)
Info    : [ 30%] Meshing curve 60 (Line)
Info    : [ 30%] Meshing curve 61 (Line)
Info    : [ 30%] Meshing curve 62 (Line)
Info    : [ 40%] Meshing curve 63 (Line)
Info    : [ 40%] Meshing curve 64 (Line)
Info    : [ 40%] Meshing curve 65 (Line)
Info    : [ 40%] Meshing curve 66 (Line)
Info    : [ 40%] Meshing curve 67 (Line)
Info    : [ 40%] Meshing curve 68 (Line)
Info    : [ 40%] Meshing curve 69 (Line)
Info    : [ 40%] Meshing curve 70 (Line)
Info    : [ 40%] Meshing curve 71 (Line)
Info    : [ 40%] Meshing curve 72 (Line)
Info    : [ 40%] Meshing curve 73 (Line)
Info    : [ 40%] Meshing curve 74 (Line)
Info    : [ 40%] Meshing curve 75 (Line)
Info    : [ 40%] Meshing curve 76 (Line)
Info    : [ 40%] Meshing curve 77 (Line)
Info    : [ 40%] Meshing curve 78 (Line)
Info    : [ 40%] Meshing curve 79 (Line)
Info    : [ 40%] Meshing curve 80 (Line)
Info    : [ 40%] Meshing curve 81 (Line)
Info    : [ 40%] Meshing curve 82 (Line)
Info    : [ 50%] Meshing curve 83 (Line)
Info    : [ 50%] Meshing curve 84 (Line)
Info    : [ 50%] Meshing curve 85 (Line)
Info    : [ 50%] Meshing curve 86 (Line)
Info    : [ 50%] Meshing curve 87 (Line)
Info    : [ 50%] Meshing curve 88 (Line)
Info    : [ 50%] Meshing curve 89 (Line)
Info    : [ 50%] Meshing curve 90 (Line)
Info    : [ 50%] Meshing curve 91 (Line)
Info    : [ 50%] Meshing curve 92 (Line)
Info    : [ 50%] Meshing curve 93 (Line)
Info    : [ 50%] Meshing curve 94 (Line)
Info    : [ 50%] Meshing curve 95 (Line)
Info    : [ 50%] Meshing curve 96 (Line)
Info    : [ 50%] Meshing curve 97 (Line)
Info    : [ 50%] Meshing curve 98 (Line)
Info    : [ 50%] Meshing curve 99 (Line)
Info    : [ 50%] Meshing curve 100 (Line)
Info    : [ 50%] Meshing curve 101 (Line)
Info    : [ 50%] Meshing curve 102 (Line)
Info    : [ 60%] Meshing curve 103 (Line)
Info    : [ 60%] Meshing curve 104 (Line)
Info    : [ 60%] Meshing curve 105 (Line)
Info    : [ 60%] Meshing curve 106 (Line)
Info    : [ 60%] Meshing curve 107 (Line)
Info    : [ 60%] Meshing curve 108 (Line)
Info    : [ 60%] Meshing curve 109 (Line)
Info    : [ 60%] Meshing curve 110 (Line)
Info    : [ 60%] Meshing curve 111 (Line)
Info    : [ 60%] Meshing curve 112 (Line)
Info    : [ 60%] Meshing curve 113 (Line)
Info    : [ 60%] Meshing curve 114 (Line)
Info    : [ 60%] Meshing curve 115 (Line)
Info    : [ 60%] Meshing curve 117 (Line)
Info    : [ 60%] Meshing curve 118 (Line)
Info    : [ 60%] Meshing curve 119 (Line)
Info    : [ 60%] Meshing curve 120 (Line)
Info    : [ 60%] Meshing curve 121 (Line)
Info    : [ 60%] Meshing curve 122 (Line)
Info    : [ 60%] Meshing curve 123 (Line)
Info    : [ 70%] Meshing curve 124 (Line)
Info    : [ 70%] Meshing curve 125 (Line)
Info    : [ 70%] Meshing curve 126 (Line)
Info    : [ 70%] Meshing curve 127 (Line)
Info    : [ 70%] Meshing curve 128 (Line)
Info    : [ 70%] Meshing curve 129 (Line)
Info    : [ 70%] Meshing curve 130 (Line)
Info    : [ 70%] Meshing curve 131 (Line)
Info    : [ 70%] Meshing curve 132 (Line)
Info    : [ 70%] Meshing curve 133 (Line)
Info    : [ 70%] Meshing curve 134 (Line)
Info    : [ 70%] Meshing curve 135 (Line)
Info    : [ 70%] Meshing curve 136 (Line)
Info    : [ 70%] Meshing curve 137 (Line)
Info    : [ 70%] Meshing curve 138 (Line)
Info    : [ 70%] Meshing curve 139 (Line)
Info    : [ 70%] Meshing curve 140 (Line)
Info    : [ 70%] Meshing curve 141 (Line)
Info    : [ 70%] Meshing curve 142 (Line)
Info    : [ 70%] Meshing curve 143 (Line)
Info    : [ 80%] Meshing curve 144 (Line)
Info    : [ 80%] Meshing curve 145 (Line)
Info    : [ 80%] Meshing curve 146 (Line)
Info    : [ 80%] Meshing curve 147 (Line)
Info    : [ 80%] Meshing curve 148 (Line)
Info    : [ 80%] Meshing curve 149 (Line)
Info    : [ 80%] Meshing curve 150 (Line)
Info    : [ 80%] Meshing curve 151 (Line)
Info    : [ 80%] Meshing curve 153 (Line)
Info    : [ 80%] Meshing curve 154 (Line)
Info    : [ 80%] Meshing curve 155 (Line)
Info    : [ 80%] Meshing curve 156 (Line)
Info    : [ 80%] Meshing curve 157 (Line)
Info    : [ 80%] Meshing curve 158 (Line)
Info    : [ 80%] Meshing curve 159 (Line)
Info    : [ 80%] Meshing curve 160 (Line)
Info    : [ 80%] Meshing curve 161 (Line)
Info    : [ 80%] Meshing curve 162 (Line)
Info    : [ 80%] Meshing curve 163 (Line)
Info    : [ 80%] Meshing curve 164 (Line)
Info    : [ 90%] Meshing curve 165 (Line)
Info    : [ 90%] Meshing curve 166 (Line)
Info    : [ 90%] Meshing curve 167 (Line)
Info    : [ 90%] Meshing curve 168 (Line)
Info    : [ 90%] Meshing curve 169 (Line)
Info    : [ 90%] Meshing curve 170 (Line)
Info    : [ 90%] Meshing curve 171 (Line)
Info    : [ 90%] Meshing curve 172 (Line)
Info    : [ 90%] Meshing curve 173 (Line)
Info    : [ 90%] Meshing curve 174 (Line)
Info    : [ 90%] Meshing curve 175 (Line)
Info    : [ 90%] Meshing curve 176 (Line)
Info    : [ 90%] Meshing curve 177 (Line)
Info    : [ 90%] Meshing curve 178 (Line)
Info    : [ 90%] Meshing curve 179 (Line)
Info    : [ 90%] Meshing curve 180 (Line)
Info    : [ 90%] Meshing curve 181 (Line)
Info    : [ 90%] Meshing curve 182 (Line)
Info    : [ 90%] Meshing curve 184 (Line)
Info    : [ 90%] Meshing curve 185 (Line)
Info    : [100%] Meshing curve 186 (Line)
Info    : [100%] Meshing curve 187 (Line)
Info    : [100%] Meshing curve 188 (Line)
Info    : [100%] Meshing curve 189 (Line)
Info    : [100%] Meshing curve 190 (Line)
Info    : [100%] Meshing curve 191 (Line)
Info    : [100%] Meshing curve 192 (Line)
Info    : [100%] Meshing curve 193 (Line)
Info    : [100%] Meshing curve 194 (Line)
Info    : [100%] Meshing curve 195 (Line)
Info    : [100%] Meshing curve 196 (Line)
Info    : [100%] Meshing curve 197 (Line)
Info    : [100%] Meshing curve 198 (Line)
Info    : [100%] Meshing curve 199 (Line)
Info    : [100%] Meshing curve 200 (Line)
Info    : [100%] Meshing curve 201 (Line)
Info    : [100%] Meshing curve 202 (Line)
Info    : [100%] Meshing curve 204 (Line)
Info    : [100%] Meshing curve 205 (Line)
Info    : Done meshing 1D (Wall 0.0228174s, CPU 0.028841s)
Info    : Meshing 2D...
Info    : [  0%] Meshing surface 1 (Plane, Frontal-Delaunay)
Info    : [ 20%] Meshing surface 2 (Plane, Frontal-Delaunay)
Info    : [ 40%] Meshing surface 3 (Plane, Frontal-Delaunay)
Info    : [ 50%] Meshing surface 4 (Plane, Frontal-Delaunay)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Info    : [ 70%] Meshing surface 5 (Plane, Frontal-Delaunay)
Info    : [ 90%] Meshing surface 6 (Plane, Frontal-Delaunay)
Info    : Done meshing 2D (Wall 0.366327s, CPU 0.36974s)
Info    : 8232 nodes 17164 elements
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Solving steady state flow with dislocation creep rheology...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration   Residual     Relative Residual
------------------------------------------
0           12652.9      1           
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1           2593.5       0.204972    
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2           354.193      0.027993    
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3           126.582      0.0100041   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4           56.6955      0.00448081  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5           31.9665      0.0025264   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6           20.3208      0.00160601  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7           13.862       0.00109555  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8           9.80868      0.00077521  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9           7.05601      0.000557657 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10          5.15867      0.000407705 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>11          3.82963      0.000302667 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12          2.88071      0.000227671 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>13          2.18946      0.000173039 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14          1.67703      0.000132541 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15          1.29174      0.00010209  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>16          0.998644     7.89258e-05 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>17          0.773531     6.11344e-05 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>18          0.599318     4.73659e-05 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>19          0.463747     3.66513e-05 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>20          0.35788      2.82843e-05 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>21          0.275088     2.1741e-05  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22          0.210376     1.66267e-05 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>23          0.159927     1.26395e-05 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>24          0.120782     9.54576e-06 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>25          0.0906273    7.16254e-06 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>26          0.0676413    5.3459e-06  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>27          0.0503836    3.98197e-06 

Getting diagnostics...
T_(200,-100) = 683.72 deg C
T_slab = 573.07 deg C
T_wedge = 935.15 deg C
V_rms,w = 40.83 mm/yr
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(683.7207139946619, 573.0691845549949, 935.1450176342418, 40.826854844920874)
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Poisson2D.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Poisson Example 2D</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble">Preamble</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#describing-the-geometry">Describing the geometry</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#slab-geometry">Slab geometry</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#subduction-zone-geometry">Subduction zone geometry</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kinematic-slab-model">Kinematic slab model</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Cian Wilson
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    <p class="last-updated">
  Last updated on May 30, 2024.
  <br/>
</p>
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>