
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Subduction Zone Benchmark &#8212; FEniCSx Subduction</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/SubductionBenchmark';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Poisson Example 2D" href="Poisson2D.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="May 31, 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">FEniCSx Subduction</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    FEniCSx Subduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../readme.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Background</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Poisson1D.html">Poisson Example 1D</a></li>
<li class="toctree-l1"><a class="reference internal" href="Poisson2D.html">Poisson Example 2D</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Subduction</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Subduction Zone Benchmark</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/cianwilson/fenicsx_subduction/main?urlpath=lab/tree/./notebooks/SubductionBenchmark.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/cianwilson/fenicsx_subduction" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cianwilson/fenicsx_subduction/edit/main/./notebooks/SubductionBenchmark.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cianwilson/fenicsx_subduction/issues/new?title=Issue%20on%20page%20%2Fnotebooks/SubductionBenchmark.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/SubductionBenchmark.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Subduction Zone Benchmark</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-revised-benchmark">A Revised Benchmark</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble">Preamble</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#describing-the-geometry">Describing the geometry</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#slab-geometry">Slab geometry</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#subduction-zone-geometry">Subduction zone geometry</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kinematic-slab-model">Kinematic slab model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-subductionproblem-class">The <code class="docutils literal notranslate"><span class="pre">SubductionProblem</span></code> class</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-the-initial-setup">Testing the initial setup</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#isoviscous-case-1">Isoviscous (Case 1)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dislocation-creep-viscosity-case-2">Dislocation Creep Viscosity (Case 2)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#themes-and-variations">Themes and variations</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="subduction-zone-benchmark">
<h1>Subduction Zone Benchmark<a class="headerlink" href="#subduction-zone-benchmark" title="Link to this heading">#</a></h1>
<section id="a-revised-benchmark">
<h2>A Revised Benchmark<a class="headerlink" href="#a-revised-benchmark" title="Link to this heading">#</a></h2>
<p>The community subduction zone benchmark <a class="reference external" href="http://dx.doi.org/10.1016/j.pepi.2008.04.015">van Keken et al, 2008</a> provides a set of simplified models well suited to test the accuracy of the solution of the governing equations that are relevant for subduction zones. Unfortunately, the model geometry and assumptions that were chosen at the time are such that they introduce a few artifacts that do not occur, as best as we know, in any subduction zone on Earth. These artifacts include a slab that dips at a constant angle of 45<span class="math notranslate nohighlight">\(^\circ\)</span> to 600 km depth, an overriding plate that excludes continental heat production,  and imposes slab-wedge coupling at 50 km rather than at 75-80 km depth.  The lack of crustal heating and the large width of the model, combined with the assumption of steady state, lead in the cases with temperature-dependent rheology to a very thick top boundary layer. This is caused by the cooling in the lithosphere, which results in a gradual thickening of the overriding lid in regions of the model that are far away from the arc-side boundary condition. While this is less of a problem in time-dependent problems (where time may not be sufficient for significant growth of the boundary layer), it shows up dramatically as a “viscous belly” in steady-state cases when the model domain is large. In time-dependent models it can show up if integration time is very long compared to the typical age of subduction zones.  The models in <a class="reference external" href="http://dx.doi.org/10.1016/j.pepi.2010.02.004">Syracuse et al., 2010</a> avoided this issue by using time integration to
only <span class="math notranslate nohighlight">\(\sim\)</span>20-40 Myr.  The models in <a class="reference external" href="http://dx.doi.org/10.1029/2009GC002570">Wada &amp; Wang, 2009</a> avoided it using steady-state models in a domain that is both narrower and shallower.</p>
<p>To mitigate the artifacts of the previous benchmark <a class="reference external" href="http://dx.doi.org/10.1186/s40645-023-00588-6">Wilson &amp; van Keken, 2023</a> proposed a new benchmark model. Modifications include a more shallowly dipping slab that only extends to a depth of 200 km, the incorporation of radiogenic heating in the overriding crust and a deeper slab-wedge coupling point. The geometry is still highly simplified:
<img alt="Figure 1a of Wilson &amp; van Keken, 2023" src="../_images/benchmarkgeometry.png" />
with a constant slab dip
<span class="math notranslate nohighlight">\(\Delta=\tan^{-1}(1/2)=26.56505^\circ\)</span> with respect to the horizontal.
The maximum depth <span class="math notranslate nohighlight">\(D\)</span>=200 defines <span class="math notranslate nohighlight">\(L\)</span>=400.
The benchmark assumes ocean-continent subduction with heat production in a two-layer crust with crustal density and thermal conductivity (<span class="math notranslate nohighlight">\(\rho_c\)</span> and <span class="math notranslate nohighlight">\(k_c\)</span> respectively) distinct from the mantle (<span class="math notranslate nohighlight">\(\rho_m\)</span> and <span class="math notranslate nohighlight">\(k_m\)</span>) and a backarc boundary condition on temperature.
Upper and lower crustal depths, <span class="math notranslate nohighlight">\(z_1\)</span> and <span class="math notranslate nohighlight">\(z_2\)</span>, are chosen as 15 and 40 respectively.
<span class="math notranslate nohighlight">\(z_\text{io}\)</span> depends on wedge geometry and rheology and is therefore variable between models, though as long as <span class="math notranslate nohighlight">\(z_\text{io}\)</span> is larger than the depth where the actual switch between inflow and outflow occurs nearly identical solutions can be obtained.</p>
<p>We will assume the reference values given in Table 2 of <a class="reference external" href="http://dx.doi.org/10.1186/s40645-023-00588-6">Wilson &amp; van Keken, 2023</a> with case-specific parameters:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>case</p></th>
<th class="head"><p>type</p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(\eta\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(q_s^*\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(A^*\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(z_2\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(z_\text{io}\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(z_\text{trench}\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(x_\text{coast}\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(D\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(L\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(V_s^*\)</span></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p>(W/m<span class="math notranslate nohighlight">\(^2\)</span>)</p></td>
<td><p>(Myr)</p></td>
<td><p></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p>(mm/yr)</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>continental</p></td>
<td><p>1</p></td>
<td><p>0.065</p></td>
<td><p>100</p></td>
<td><p>40</p></td>
<td><p>139</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>200</p></td>
<td><p>400</p></td>
<td><p>100</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>continental</p></td>
<td><p><span class="math notranslate nohighlight">\(\eta_\text{disl}\)</span></p></td>
<td><p>0.065</p></td>
<td><p>100</p></td>
<td><p>40</p></td>
<td><p>154</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>200</p></td>
<td><p>400</p></td>
<td><p>100</p></td>
</tr>
</tbody>
</table>
</div>
<p>We will solve two sets of Stokes equations in the wedge (beneath the crust but above the slab surface) and slab (beneath the slab surface) subdomains respectively, either with constant viscosity (<span class="math notranslate nohighlight">\(\eta\)</span>=1, case 1) or with temperature- and strain-rate-dependent dislocation creep viscosity (case 2). Coupling between the slab velocity and the mantle wedge velocity starts at the partial coupling depth, <span class="math notranslate nohighlight">\(d_c\)</span>=80 km, and ramps up linearly to full coupling at the full coupling depth, <span class="math notranslate nohighlight">\(d_{fc}\)</span>=82.5 km and will be imposed through an internal boundary condition on the slab surface. The heat equation will be solved in the entire domain under the assumption of steady state.</p>
<p>Though this setup is designed for the benchmark cases, we will implement the problem in a manner that can be used for a range of subduction zone geometries, albeit with an inaccurate assumption of a steady state.</p>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h2>
<section id="preamble">
<h3>Preamble<a class="headerlink" href="#preamble" title="Link to this heading">#</a></h3>
<p>Let’s start by adding the path to the modules in the <code class="docutils literal notranslate"><span class="pre">python</span></code> folder to the system path.  Also set the filename for the default parameters in the <code class="docutils literal notranslate"><span class="pre">data</span></code> directory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">))</span>
<span class="n">params_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;default_params.json&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then let’s load all the required modules at the beginning.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geometry</span> <span class="k">as</span> <span class="nn">geo</span>
<span class="kn">import</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">import</span> <span class="nn">dolfinx</span> <span class="k">as</span> <span class="nn">df</span>
<span class="kn">import</span> <span class="nn">dolfinx.fem.petsc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">import</span> <span class="nn">basix.ufl</span> <span class="k">as</span> <span class="nn">bu</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can load the <code class="docutils literal notranslate"><span class="pre">default_params</span></code> dictionary from file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">params_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">default_params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This contains default parameters required to define the geometry.  Keys ending in <code class="docutils literal notranslate"><span class="pre">_sid</span></code> and <code class="docutils literal notranslate"><span class="pre">_rid</span></code> are surface and region IDs respectively that we use to identify boundaries and regions of the mesh (these are unlikely to need to be changed).  <code class="docutils literal notranslate"><span class="pre">*_res_fact</span></code> are resolution factors scaled by a factor to set the resolution at various points in the mesh.  Finally, those ending in <code class="docutils literal notranslate"><span class="pre">_depth</span></code> are depths (in km) of various important points along the slab surface or boundaries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;35}</span><span class="s2"> </span><span class="si">{:&lt;10}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Key&#39;</span><span class="p">,</span><span class="s1">&#39;Value&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">45</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">default_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;35}</span><span class="s2"> </span><span class="si">{:&lt;10}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Key                                 Value     
---------------------------------------------
slab_sid                            1         
slab_side_sid                       2         
wedge_side_sid                      3         
upper_wedge_side_sid                4         
lc_side_sid                         5         
uc_side_sid                         6         
slab_base_sid                       7         
wedge_base_sid                      8         
lc_base_sid                         9         
uc_base_sid                         10        
coast_sid                           11        
top_sid                             12        
fault_sid                           13        
slab_diag_sid                       14        
slab_rid                            1         
wedge_rid                           2         
lc_rid                              3         
uc_rid                              4         
wedge_diag_rid                      5         
slab_det_depth                      100.0     
partial_coupling_depth              80.0      
full_coupling_depth                 82.5      
slab_diag1_depth                    70.0      
slab_diag2_depth                    120.0     
partial_coupling_depth_res_fact     1.0       
full_coupling_depth_res_fact        1.0       
io_depth_res_fact                   4.0       
coast_res_fact                      1.0       
lc_side_res_fact                    2.0       
lc_slab_res_fact                    1.0       
slab_side_base_res_fact             8.0       
uc_side_res_fact                    2.0       
uc_slab_res_fact                    1.0       
wedge_side_top_res_fact             4.0       
wedge_side_base_res_fact            4.0       
slab_diag1_res_fact                 1.0       
slab_diag2_res_fact                 1.0       
</pre></div>
</div>
</div>
</div>
</section>
<section id="describing-the-geometry">
<h3>Describing the geometry<a class="headerlink" href="#describing-the-geometry" title="Link to this heading">#</a></h3>
<p>Even in the simplified benchmark case, the geometry of a subduction zone is more complicated than any of the in built meshes provided to us by <code class="docutils literal notranslate"><span class="pre">dolfinx</span></code>.  In kinematic slab models we need to describe the slab and the surrounding domain around it, including crustal layers and surface features.  We are particularly interested in the dynamics near the mantle wedge corner in the sub-arc region so will likely want to employ variable resolutions, with refined cells in this area.  Luckily, finite elements excel at describing these more complicated, variable resolution geometries using unstructured meshes.  We will start by describing the slab geometry.</p>
<section id="slab-geometry">
<h4>Slab geometry<a class="headerlink" href="#slab-geometry" title="Link to this heading">#</a></h4>
<p>In kinematic slab models the slab is typically described using a small number of points derived from seismic data which are then fitted with a spline to interpolate and extrapolate the geometry to other depths.  We will use a cubic spline provided by the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.CubicSpline.html">scipy</a> module and wrapped for convenience in our own <code class="docutils literal notranslate"><span class="pre">geometry.py</span></code> python module.  We need to provide the points describing the spline, some information about the resolution we desire in the mesh at various points along the spline, and information about some points that we require to be included in the spline.  The most important of these are the partial and full coupling depths (<code class="docutils literal notranslate"><span class="pre">partial_coupling_depth</span></code> and <code class="docutils literal notranslate"><span class="pre">full_coupling_depth</span></code> in <code class="docutils literal notranslate"><span class="pre">default_params</span></code> respectively), which will later be used as the locations where the slab becomes fully coupled to the mantle wedge.  These parameters are key in determining the subduction zone thermal structure.  We also include a point at <code class="docutils literal notranslate"><span class="pre">slab_det_depth</span></code> that we use to extract diagnostic information.</p>
<p>We set up the slab using the function <code class="docutils literal notranslate"><span class="pre">create_slab</span></code> below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_slab</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">resscale</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">,</span> 
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to construct and return a spline object that is used to describe a subducting slab</span>
<span class="sd">    in a kinematic-slab model of a subduction zone.  Optional keyword arguments default to parameters </span>
<span class="sd">    in the global default_params dictionary if not specified.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">      * xs             - list of x points in slab spline</span>
<span class="sd">      * ys             - list of y points in slab spline (must be the same length as xs)</span>
<span class="sd">      * resscale       - resolution scale factor that multiplies all _res_fact parameters</span>
<span class="sd">      * lc_depth       - depth of lower crustal boundary (&quot;Moho&quot;)</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">     distances:</span>
<span class="sd">      * slab_diag1_depth - starting depth of slab diagnostic region</span>
<span class="sd">      * slab_diag2_depth - end depth of slab diagnostic region</span>
<span class="sd">      * partial_coupling_depth - partial coupling depth on slab</span>
<span class="sd">      * full_coupling_depth    - full coupling depth on slab</span>
<span class="sd">      * slab_det_depth         - detector depth on slab</span>

<span class="sd">     resolutions factors (that get multiplied by the resscale to get the resolutions):</span>
<span class="sd">      * slab_diag1_res_fact             - start of slab diagnostic region</span>
<span class="sd">      * slab_diag2_res_fact             - end of slab diagnostic region</span>
<span class="sd">      * partial_coupling_depth_res_fact - partial coupling depth on slab</span>
<span class="sd">      * full_coupling_depth_res_fact    - full coupling depth on slab</span>

<span class="sd">     surface ids:</span>
<span class="sd">      * fault_sid            - fault</span>
<span class="sd">      * slab_sid             - default slab surface id</span>
<span class="sd">      * slab_diag_sid        - diagnostic region of slab</span>

<span class="sd">    Returns:</span>
<span class="sd">      * slab - subduction zone slab spline instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># get input parameters</span>
    <span class="c1"># depths</span>
    <span class="n">slab_diag1_depth</span>       <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag1_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag1_depth&#39;</span><span class="p">])</span>
    <span class="n">slab_diag2_depth</span>       <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag2_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag2_depth&#39;</span><span class="p">])</span>
    <span class="n">partial_coupling_depth</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;partial_coupling_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;partial_coupling_depth&#39;</span><span class="p">])</span>
    <span class="n">full_coupling_depth</span>    <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full_coupling_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;full_coupling_depth&#39;</span><span class="p">])</span>
    <span class="n">slab_det_depth</span>         <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_det_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_det_depth&#39;</span><span class="p">])</span>
    
    <span class="c1"># resolutions</span>
    <span class="n">slab_diag1_res</span>             <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag1_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag1_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">slab_diag2_res</span>             <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag2_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag2_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">partial_coupling_depth_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;partial_coupling_depth_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;partial_coupling_depth_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">full_coupling_depth_res</span>    <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full_coupling_depth_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;full_coupling_depth_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>

    <span class="c1"># surface ids</span>
    <span class="n">fault_sid</span>      <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fault_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;fault_sid&#39;</span><span class="p">])</span>
    <span class="n">slab_sid</span>       <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_sid&#39;</span><span class="p">])</span>
    <span class="n">slab_diag_sid</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag_sid&#39;</span><span class="p">])</span>
       
    <span class="c1"># set up resolutions along the slab depending on depth</span>
    <span class="c1"># high resolution at shallow depths, lower resolution below the &quot;diagnostic&quot;</span>
    <span class="c1"># region required in the benchmark case</span>
    <span class="c1"># FIXME: these are currently hard-coded relative to the resolutions specified at the partial and full coupling</span>
    <span class="c1"># depths for simplicity but could be separate parameters</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">partial_coupling_depth_res</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">slab_diag2_depth</span> <span class="k">else</span> <span class="mi">3</span><span class="o">*</span><span class="n">full_coupling_depth_res</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">]</span>
    
    <span class="c1"># set up the surface ids for the slab depending on depth</span>
    <span class="c1"># above the &quot;Moho&quot; use fault_sid</span>
    <span class="c1"># in the diagnostic region use the slab_diag_sid</span>
    <span class="c1"># everywhere else use the default slab_sid</span>
    <span class="n">sids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">lc_depth</span><span class="p">:</span> 
            <span class="n">sid</span> <span class="o">=</span> <span class="n">fault_sid</span>
        <span class="k">elif</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">slab_diag1_depth</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">slab_sid</span>
        <span class="k">elif</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">slab_diag2_depth</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">slab_diag_sid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">slab_sid</span>
        <span class="n">sids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
    
    <span class="c1"># set up the slab spline object</span>
    <span class="n">slab</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">SlabSpline</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="n">sids</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Slab&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">full_coupling_depth</span> <span class="o">&gt;</span> <span class="n">partial_coupling_depth</span>
    <span class="c1"># adding the coupling depths may or may not be necessary</span>
    <span class="c1"># depending on if they were included in the slab spline data already or not</span>
    <span class="c1"># the slab class should ignore them if they aren&#39;t necessary</span>
    <span class="n">slab</span><span class="o">.</span><span class="n">addpoint</span><span class="p">(</span><span class="n">partial_coupling_depth</span><span class="p">,</span> <span class="s2">&quot;Slab::PartialCouplingDepth&quot;</span><span class="p">,</span> 
                  <span class="n">res</span><span class="o">=</span><span class="n">partial_coupling_depth_res</span><span class="p">,</span> 
                  <span class="n">sid</span><span class="o">=</span><span class="n">slab_diag_sid</span><span class="p">)</span>
    <span class="n">slab</span><span class="o">.</span><span class="n">addpoint</span><span class="p">(</span><span class="n">full_coupling_depth</span><span class="p">,</span> <span class="s2">&quot;Slab::FullCouplingDepth&quot;</span><span class="p">,</span> 
                  <span class="n">res</span><span class="o">=</span><span class="n">full_coupling_depth_res</span><span class="p">,</span> 
                  <span class="n">sid</span><span class="o">=</span><span class="n">slab_diag_sid</span><span class="p">)</span>
    <span class="c1"># add the slab detector point</span>
    <span class="n">slab</span><span class="o">.</span><span class="n">addpoint</span><span class="p">(</span><span class="n">slab_det_depth</span><span class="p">,</span> <span class="s2">&quot;Slab::DetectorPoint&quot;</span><span class="p">,</span> 
                  <span class="n">res</span><span class="o">=</span><span class="n">full_coupling_depth_res</span><span class="p">,</span>
                  <span class="n">sid</span><span class="o">=</span><span class="n">slab_diag_sid</span><span class="p">)</span>

    <span class="c1"># and return it</span>
    <span class="k">return</span> <span class="n">slab</span>
</pre></div>
</div>
</div>
</div>
<p>Describing the slab geometry only takes a few non-default parameters, which are relatively simple in the benchmark geometry.</p>
<p>Although the resolution of our mesh is going to vary across the domain we will use a resolution scale factor <code class="docutils literal notranslate"><span class="pre">resscale</span></code> to scale the resolution globally, while different points in the domain retain the same default relative resolutions.  So a large <code class="docutils literal notranslate"><span class="pre">resscale</span></code> means low resolution and a small <code class="docutils literal notranslate"><span class="pre">resscale</span></code> means high resolution.</p>
<div class="admonition-computational-cost admonition">
<p class="admonition-title">Computational cost</p>
<p>Setting the <code class="docutils literal notranslate"><span class="pre">resscale</span></code> too low will result in a computationally expensive simulation, especially in the non-linear case, that may need to be run locally rather than remotely.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resscale</span> <span class="o">=</span> <span class="mf">5.0</span>
</pre></div>
</div>
</div>
</div>
<p>The benchmark slab geometry is rather simple, just consisting of a straight line with 2:1 horizontal distance to depth ratio, extending to 200km depth.  We can therefore just provide the spline with a series of linearly related points <code class="docutils literal notranslate"><span class="pre">xs</span></code> and <code class="docutils literal notranslate"><span class="pre">ys</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># points in slab (just linear)</span>
<span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">140.0</span><span class="p">,</span> <span class="mf">240.0</span><span class="p">,</span> <span class="mf">400.0</span><span class="p">]</span>
<span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">70.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">120.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">200.0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>To get the surface ids on the slab correct we also have to provide the lower crustal depth <code class="docutils literal notranslate"><span class="pre">lc_depth</span></code>.  As this is a case dependent parameter it is not provided in <code class="docutils literal notranslate"><span class="pre">default_params</span></code>.  For the benchmark cases it is at 40km depth.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lc_depth</span> <span class="o">=</span> <span class="mi">40</span>
</pre></div>
</div>
</div>
</div>
<p>Providing these parameters we can create our slab geometry.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slab</span> <span class="o">=</span> <span class="n">create_slab</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">resscale</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can double check that it looks as expected by plotting the slab, though in the benchmark case this is not very interesting!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interpx</span> <span class="o">=</span> <span class="p">[</span><span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">curve</span> <span class="ow">in</span> <span class="n">slab</span><span class="o">.</span><span class="n">interpcurves</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">slab</span><span class="o">.</span><span class="n">interpcurves</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">]</span>
<span class="n">interpy</span> <span class="o">=</span> <span class="p">[</span><span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">curve</span> <span class="ow">in</span> <span class="n">slab</span><span class="o">.</span><span class="n">interpcurves</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">slab</span><span class="o">.</span><span class="n">interpcurves</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">]</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interpx</span><span class="p">,</span> <span class="n">interpy</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x (km)&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y (km)&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Slab Geometry&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/eb3f4077e477a4715defed3ebeeb3debdcc5ead08fbef46f6874f5ffd5162551.png" src="../_images/eb3f4077e477a4715defed3ebeeb3debdcc5ead08fbef46f6874f5ffd5162551.png" />
</div>
</div>
<p>With the slab geometry in hand we can move onto defining the rest of the geometry.</p>
</section>
<section id="subduction-zone-geometry">
<h4>Subduction zone geometry<a class="headerlink" href="#subduction-zone-geometry" title="Link to this heading">#</a></h4>
<p>To describe the subduction zone geometry we need to build a two-dimensional domain around the slab spline.  In the simplest case this is simply a rectangle around the spline but more generally will include a sloping coastline, a crust and potentially an upper crust if the slab is subducting beneath a continent.  As with the spline we will also include certain important points in the domain and extra boundaries (lines) demarking special diagnostic regions of interest in the model.  Also as with the spline we use a python class implemented in our own <code class="docutils literal notranslate"><span class="pre">geometry.py</span></code> module to do most of the work.</p>
<p>In the following <code class="docutils literal notranslate"><span class="pre">create_sz_geometry</span></code> function we use the <code class="docutils literal notranslate"><span class="pre">slab</span></code> object we instantiated above to provide the bounds and set up a base <code class="docutils literal notranslate"><span class="pre">SubductionGeometry</span></code> object, which will essentially describe the bounding domain with a sloping coastline if <code class="docutils literal notranslate"><span class="pre">coast_distance</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>.  The domain can also be set up to overshoot the lowermost end of the slab spline using the <code class="docutils literal notranslate"><span class="pre">extra_width</span></code> parameter.  Crustal layers will then be added to the domain, controlled by the <code class="docutils literal notranslate"><span class="pre">lc_depth</span></code>, <code class="docutils literal notranslate"><span class="pre">uc_depth</span></code> and <code class="docutils literal notranslate"><span class="pre">sztype</span></code> parameters (with the latter controlling how many layers are added).  The approximate point where the flow into and out of the wedge changes direction is included in the domain as specified by <code class="docutils literal notranslate"><span class="pre">io_depth</span></code>.  Finally, we subdivide the wedge into a “diagnostic” region where certain benchmark values can be easily calculated.  And, once again we use the same <code class="docutils literal notranslate"><span class="pre">resscale</span></code> parameter to scale the global resolution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_sz_geometry</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> <span class="n">resscale</span><span class="p">,</span> <span class="n">sztype</span><span class="p">,</span> <span class="n">io_depth</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">,</span> 
                       <span class="n">coast_distance</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">,</span> <span class="n">uc_depth</span><span class="p">,</span> 
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to construct and return a subduction zone geometry object that is used to generate</span>
<span class="sd">    a mesh of a subduction zone.  Optional keyword arguments default to parameters in the global </span>
<span class="sd">    default_params dictionary if not specified.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">      * slab           - an instance of a slab spline object</span>
<span class="sd">      * resscale       - resolution scale factor that multiplies all _res_fact parameters</span>
<span class="sd">      * sztype         - either &#39;continental&#39; or &#39;oceanic&#39;, which determines if an upper crust is included</span>
<span class="sd">      * io_depth       - prescribed input/output depth on wedge side</span>
<span class="sd">      * extra_width    - extra width at the base of the domain</span>
<span class="sd">      * coast_distance - distance from trench to coast</span>
<span class="sd">      * lc_depth       - depth of lower crustal boundary (&quot;Moho&quot;)</span>
<span class="sd">      * uc_depth       - depth of upper crustal boundary</span>

<span class="sd">    Keyword Arguments:</span>
<span class="sd">     distances:</span>
<span class="sd">      * slab_diag1_depth - starting depth along slab of slab diagnostic region</span>
<span class="sd">      * slab_diag2_depth - end depth along slab of slab diagnostic region</span>

<span class="sd">     resolutions factors (that get multiplied by the resscale to get the resolutions):</span>
<span class="sd">      * io_depth_res_fact        - input/output depth</span>
<span class="sd">      * coast_res_fact           - coastal point on top</span>
<span class="sd">      * lc_slab_res_fact         - lower crust slab intersection</span>
<span class="sd">      * lc_side_res_fact         - lower crust side intersection</span>
<span class="sd">      * uc_slab_res_fact         - upper crust slab intersection</span>
<span class="sd">      * uc_side_res_fact         - upper crust side intersection</span>
<span class="sd">      * slab_diag1_res_fact      - start of slab diagnostic region</span>
<span class="sd">      * slab_diag2_res_fact      - end of slab diagnostic region</span>
<span class="sd">      * wedge_side_top_res_fact  - top of the wedge side</span>
<span class="sd">      * wedge_side_base_res_fact - base of the wedge side</span>
<span class="sd">      * slab_side_base_res_fact  - base of the slab side</span>

<span class="sd">     surface ids:</span>
<span class="sd">      * coast_sid            - coastal slope</span>
<span class="sd">      * top_sid              - top of domain</span>
<span class="sd">      * fault_sid            - fault</span>
<span class="sd">      * lc_side_sid          - side of lower crust</span>
<span class="sd">      * lc_base_sid          - base of lower crust</span>
<span class="sd">      * uc_side_sid          - side of upper crust</span>
<span class="sd">      * uc_base_sid          - base of upper crust</span>
<span class="sd">      * slab_sid             - default slab surface id</span>
<span class="sd">      * slab_diag_sid        - diagnostic region of slab</span>
<span class="sd">      * slab_side_sid        - side of slab</span>
<span class="sd">      * wedge_side_sid       - side of wedge</span>
<span class="sd">      * upper_wedge_side_sid - side of upper wedge</span>
<span class="sd">      * slab_base_sid        - base of slab</span>
<span class="sd">      * wedge_base_sid       - base of wedge</span>

<span class="sd">     region ids:</span>
<span class="sd">      * slab_rid       - slab</span>
<span class="sd">      * wedge_rid      - wedge</span>
<span class="sd">      * lc_rid         - lower crust</span>
<span class="sd">      * uc_rid         - upper crust</span>
<span class="sd">      * wedge_diag_rid - wedge diagnostic region</span>

<span class="sd">    Returns:</span>
<span class="sd">      * geom - subduction zone geometry class instance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get input parameters</span>
    <span class="c1"># depths</span>
    <span class="n">slab_diag1_depth</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag1_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag1_depth&#39;</span><span class="p">])</span>
    <span class="n">slab_diag2_depth</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag2_depth&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag2_depth&#39;</span><span class="p">])</span>
    
    <span class="c1"># resolutions</span>
    <span class="n">io_depth_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;io_depth_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;io_depth_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">coast_res</span>   <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coast_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;coast_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">lc_slab_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lc_slab_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;lc_slab_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">lc_side_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lc_side_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;lc_side_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">uc_slab_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uc_slab_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;uc_slab_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">uc_side_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uc_side_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;uc_side_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">slab_diag1_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag1_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag1_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">slab_diag2_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag2_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag2_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">wedge_side_top_res</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wedge_side_top_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;wedge_side_top_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">wedge_side_base_res</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wedge_side_base_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;wedge_side_base_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>
    <span class="n">slab_side_base_res</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_side_base_res_fact&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_side_base_res_fact&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">resscale</span>

    <span class="c1"># surface ids</span>
    <span class="n">coast_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coast_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;coast_sid&#39;</span><span class="p">])</span>
    <span class="n">top_sid</span>   <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;top_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;top_sid&#39;</span><span class="p">])</span>
    <span class="n">fault_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fault_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;fault_sid&#39;</span><span class="p">])</span>
    <span class="n">lc_side_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lc_side_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;lc_side_sid&#39;</span><span class="p">])</span>
    <span class="n">lc_base_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lc_base_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;lc_base_sid&#39;</span><span class="p">])</span>
    <span class="n">uc_side_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uc_side_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;uc_side_sid&#39;</span><span class="p">])</span>
    <span class="n">uc_base_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uc_base_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;uc_base_sid&#39;</span><span class="p">])</span>
    <span class="n">slab_sid</span>    <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_sid&#39;</span><span class="p">])</span>
    <span class="n">slab_diag_sid</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_diag_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_diag_sid&#39;</span><span class="p">])</span>
    <span class="n">slab_side_sid</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_side_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_side_sid&#39;</span><span class="p">])</span>
    <span class="n">wedge_side_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wedge_side_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;wedge_side_sid&#39;</span><span class="p">])</span>
    <span class="n">slab_base_sid</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_base_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_base_sid&#39;</span><span class="p">])</span>
    <span class="n">wedge_base_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wedge_base_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;wedge_base_sid&#39;</span><span class="p">])</span>
    <span class="n">upper_wedge_side_sid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upper_wedge_side_sid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;upper_wedge_side_sid&#39;</span><span class="p">])</span>
    
    <span class="c1"># region ids</span>
    <span class="n">slab_rid</span>       <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slab_rid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;slab_rid&#39;</span><span class="p">])</span>
    <span class="n">wedge_rid</span>      <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wedge_rid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;wedge_rid&#39;</span><span class="p">])</span>
    <span class="n">lc_rid</span>         <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lc_rid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;lc_rid&#39;</span><span class="p">])</span>
    <span class="n">uc_rid</span>         <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uc_rid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;uc_rid&#39;</span><span class="p">])</span>
    <span class="n">wedge_diag_rid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wedge_diag_rid&#39;</span><span class="p">,</span> <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;wedge_diag_rid&#39;</span><span class="p">])</span>
    
    <span class="k">assert</span> <span class="n">sztype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;continental&#39;</span><span class="p">,</span> <span class="s1">&#39;oceanic&#39;</span><span class="p">]</span>
    

    <span class="c1"># pass the slab object into the SubductionGeometry class to construct the geometry</span>
    <span class="c1"># around it</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">SubductionGeometry</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> 
                                  <span class="n">coast_distance</span><span class="o">=</span><span class="n">coast_distance</span><span class="p">,</span> 
                                  <span class="n">extra_width</span><span class="o">=</span><span class="n">extra_width</span><span class="p">,</span> 
                                  <span class="n">slab_side_sid</span><span class="o">=</span><span class="n">slab_side_sid</span><span class="p">,</span> 
                                  <span class="n">wedge_side_sid</span><span class="o">=</span><span class="n">wedge_side_sid</span><span class="p">,</span> 
                                  <span class="n">slab_base_sid</span><span class="o">=</span><span class="n">slab_base_sid</span><span class="p">,</span> 
                                  <span class="n">wedge_base_sid</span><span class="o">=</span><span class="n">wedge_base_sid</span><span class="p">,</span> 
                                  <span class="n">coast_sid</span><span class="o">=</span><span class="n">coast_sid</span><span class="p">,</span> 
                                  <span class="n">top_sid</span><span class="o">=</span><span class="n">top_sid</span><span class="p">,</span> 
                                  <span class="n">slab_rid</span><span class="o">=</span><span class="n">slab_rid</span><span class="p">,</span> 
                                  <span class="n">wedge_rid</span><span class="o">=</span><span class="n">wedge_rid</span><span class="p">,</span> 
                                  <span class="n">coast_res</span><span class="o">=</span><span class="n">coast_res</span><span class="p">,</span> 
                                  <span class="n">slab_side_base_res</span><span class="o">=</span><span class="n">slab_side_base_res</span><span class="p">,</span> 
                                  <span class="n">wedge_side_top_res</span><span class="o">=</span><span class="n">wedge_side_top_res</span><span class="p">,</span> 
                                  <span class="n">wedge_side_base_res</span><span class="o">=</span><span class="n">wedge_side_base_res</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sztype</span><span class="o">==</span><span class="s1">&#39;oceanic&#39;</span><span class="p">:</span>
        <span class="c1"># add a single crust layer</span>
        <span class="c1"># (using the lc parameters &amp; ignoring the uc ones)</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">addcrustlayer</span><span class="p">(</span><span class="n">lc_depth</span><span class="p">,</span> <span class="s2">&quot;Crust&quot;</span><span class="p">,</span>
                           <span class="n">sid</span><span class="o">=</span><span class="n">lc_base_sid</span><span class="p">,</span> <span class="n">rid</span><span class="o">=</span><span class="n">lc_rid</span><span class="p">,</span>
                           <span class="n">slab_res</span><span class="o">=</span><span class="n">lc_slab_res</span><span class="p">,</span>
                           <span class="n">side_res</span><span class="o">=</span><span class="n">lc_side_res</span><span class="p">,</span>
                           <span class="n">slab_sid</span><span class="o">=</span><span class="n">fault_sid</span><span class="p">,</span>
                           <span class="n">side_sid</span><span class="o">=</span><span class="n">lc_side_sid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># add a lower crust</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">addcrustlayer</span><span class="p">(</span><span class="n">lc_depth</span><span class="p">,</span> <span class="s2">&quot;Crust&quot;</span><span class="p">,</span> 
                           <span class="n">sid</span><span class="o">=</span><span class="n">lc_base_sid</span><span class="p">,</span> <span class="n">rid</span><span class="o">=</span><span class="n">lc_rid</span><span class="p">,</span>
                           <span class="n">slab_res</span><span class="o">=</span><span class="n">lc_slab_res</span><span class="p">,</span>
                           <span class="n">side_res</span><span class="o">=</span><span class="n">lc_side_res</span><span class="p">,</span>
                           <span class="n">slab_sid</span><span class="o">=</span><span class="n">fault_sid</span><span class="p">,</span>
                           <span class="n">side_sid</span><span class="o">=</span><span class="n">lc_side_sid</span><span class="p">)</span>
        
        <span class="c1"># add an upper crust</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">addcrustlayer</span><span class="p">(</span><span class="n">uc_depth</span><span class="p">,</span> <span class="s2">&quot;UpperCrust&quot;</span><span class="p">,</span> 
                           <span class="n">sid</span><span class="o">=</span><span class="n">uc_base_sid</span><span class="p">,</span> <span class="n">rid</span><span class="o">=</span><span class="n">uc_rid</span><span class="p">,</span>
                           <span class="n">slab_res</span><span class="o">=</span><span class="n">uc_slab_res</span><span class="p">,</span>
                           <span class="n">side_res</span><span class="o">=</span><span class="n">uc_side_res</span><span class="p">,</span>
                           <span class="n">slab_sid</span><span class="o">=</span><span class="n">fault_sid</span><span class="p">,</span>
                           <span class="n">side_sid</span><span class="o">=</span><span class="n">uc_side_sid</span><span class="p">)</span>
    
    <span class="c1"># add the pre-defined in-out point on the wedge side</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">addwedgesidepoint</span><span class="p">(</span><span class="n">io_depth</span><span class="p">,</span> <span class="s2">&quot;WedgeSide::InOut&quot;</span><span class="p">,</span> <span class="n">line_name</span><span class="o">=</span><span class="s2">&quot;UpperWedgeSide&quot;</span><span class="p">,</span> 
                           <span class="n">res</span><span class="o">=</span><span class="n">io_depth_res</span><span class="p">,</span> 
                           <span class="n">sid</span><span class="o">=</span><span class="n">upper_wedge_side_sid</span><span class="p">)</span>
    
    <span class="c1"># add wedge dividers for the diagnostics</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">addwedgedivider</span><span class="p">(</span><span class="n">slab_diag1_depth</span><span class="p">,</span> <span class="s2">&quot;ColdCorner&quot;</span><span class="p">,</span> 
                         <span class="n">slab_res</span><span class="o">=</span><span class="n">slab_diag2_res</span><span class="p">,</span> 
                         <span class="n">top_res</span><span class="o">=</span><span class="n">slab_diag2_res</span><span class="p">,</span>
                         <span class="n">rid</span><span class="o">=</span><span class="n">wedge_rid</span><span class="p">,</span> 
                         <span class="n">slab_sid</span><span class="o">=</span><span class="n">slab_sid</span><span class="p">)</span>
    
    <span class="c1"># add wedge dividers for the diagnostics</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">addwedgedivider</span><span class="p">(</span><span class="n">slab_diag2_depth</span><span class="p">,</span> <span class="s2">&quot;WedgeFocused&quot;</span><span class="p">,</span> 
                         <span class="n">slab_res</span><span class="o">=</span><span class="n">slab_diag1_res</span><span class="p">,</span> 
                         <span class="n">top_res</span><span class="o">=</span><span class="n">slab_diag1_res</span><span class="p">,</span>
                         <span class="n">rid</span><span class="o">=</span><span class="n">wedge_diag_rid</span><span class="p">,</span> 
                         <span class="n">slab_sid</span><span class="o">=</span><span class="n">slab_diag_sid</span><span class="p">)</span>

    <span class="c1"># return the geometry object</span>
    <span class="k">return</span> <span class="n">geom</span>
</pre></div>
</div>
</div>
</div>
<p>For the benchmark cases we do not include a coastline or any extra width beyond the slab so <code class="docutils literal notranslate"><span class="pre">coast_distance</span> <span class="pre">=</span> <span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">extra_width</span> <span class="pre">=</span> <span class="pre">0</span></code>.  The subduction zone “type” is continental (<code class="docutils literal notranslate"><span class="pre">sztype</span> <span class="pre">=</span> <span class="pre">&quot;continental&quot;</span></code>), which means we need to set an upper crustal depth, which in the benchmark is 40km, <code class="docutils literal notranslate"><span class="pre">uc_depth</span> <span class="pre">=</span> <span class="pre">40</span></code>.  <code class="docutils literal notranslate"><span class="pre">lc_depth</span></code> was already set when describing the slab.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coast_distance</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">extra_width</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">uc_depth</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">sztype</span> <span class="o">=</span> <span class="s1">&#39;continental&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>The input/output depth varies between the isoviscous (case 1) and nonlinear (case 2) benchmarks. We choose the value from case 1 here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">io_depth_1</span> <span class="o">=</span> <span class="mi">139</span>
</pre></div>
</div>
</div>
</div>
<p>Leaving all other parameters as their default values we can now instantiate a subduction zone geometry object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">geom</span> <span class="o">=</span> <span class="n">create_sz_geometry</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> <span class="n">resscale</span><span class="p">,</span> <span class="n">sztype</span><span class="p">,</span> <span class="n">io_depth_1</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">,</span> 
                          <span class="n">coast_distance</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">,</span> <span class="n">uc_depth</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And examine it to see if it looks correct.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">geom</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label_sids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_rids</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/63c495a3d3e8f1c04d44b053d66104161e4d448e36131681748ed5c5bb40592d.png" src="../_images/63c495a3d3e8f1c04d44b053d66104161e4d448e36131681748ed5c5bb40592d.png" />
</div>
</div>
<p>The finished geometry object can now be used to generate the mesh we will use to solve our numerical problem.  To do this we are using <a class="reference external" href="https://gmsh.info/">GMsh</a> in the background, which can generate a lot of output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mesh</span><span class="p">,</span> <span class="n">cell_tags</span><span class="p">,</span> <span class="n">facet_tags</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">generatemesh</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Info    : Meshing 1D...
Info    : [  0%] Meshing curve 1 (Line)
Info    : [ 10%] Meshing curve 2 (Line)
Info    : [ 10%] Meshing curve 3 (Line)
Info    : [ 10%] Meshing curve 4 (Line)
Info    : [ 10%] Meshing curve 5 (Line)
Info    : [ 10%] Meshing curve 6 (Line)
Info    : [ 10%] Meshing curve 7 (Line)
Info    : [ 10%] Meshing curve 8 (Line)
Info    : [ 10%] Meshing curve 9 (Line)
Info    : [ 10%] Meshing curve 10 (Line)
Info    : [ 20%] Meshing curve 11 (Line)
Info    : [ 20%] Meshing curve 12 (Line)
Info    : [ 20%] Meshing curve 13 (Line)
Info    : [ 20%] Meshing curve 14 (Line)
Info    : [ 20%] Meshing curve 15 (Line)
Info    : [ 20%] Meshing curve 16 (Line)
Info    : [ 20%] Meshing curve 17 (Line)
Info    : [ 20%] Meshing curve 18 (Line)
Info    : [ 20%] Meshing curve 19 (Line)
Info    : [ 30%] Meshing curve 20 (Line)
Info    : [ 30%] Meshing curve 21 (Line)
Info    : [ 30%] Meshing curve 22 (Line)
Info    : [ 30%] Meshing curve 23 (Line)
Info    : [ 30%] Meshing curve 24 (Line)
Info    : [ 30%] Meshing curve 25 (Line)
Info    : [ 30%] Meshing curve 27 (Line)
Info    : [ 30%] Meshing curve 28 (Line)
Info    : [ 30%] Meshing curve 29 (Line)
Info    : [ 40%] Meshing curve 30 (Line)
Info    : [ 40%] Meshing curve 31 (Line)
Info    : [ 40%] Meshing curve 32 (Line)
Info    : [ 40%] Meshing curve 33 (Line)
Info    : [ 40%] Meshing curve 34 (Line)
Info    : [ 40%] Meshing curve 35 (Line)
Info    : [ 40%] Meshing curve 36 (Line)
Info    : [ 40%] Meshing curve 37 (Line)
Info    : [ 40%] Meshing curve 38 (Line)
Info    : [ 50%] Meshing curve 39 (Line)
Info    : [ 50%] Meshing curve 40 (Line)
Info    : [ 50%] Meshing curve 41 (Line)
Info    : [ 50%] Meshing curve 42 (Line)
Info    : [ 50%] Meshing curve 43 (Line)
Info    : [ 50%] Meshing curve 44 (Line)
Info    : [ 50%] Meshing curve 45 (Line)
Info    : [ 50%] Meshing curve 46 (Line)
Info    : [ 50%] Meshing curve 47 (Line)
Info    : [ 60%] Meshing curve 48 (Line)
Info    : [ 60%] Meshing curve 49 (Line)
Info    : [ 60%] Meshing curve 50 (Line)
Info    : [ 60%] Meshing curve 51 (Line)
Info    : [ 60%] Meshing curve 52 (Line)
Info    : [ 60%] Meshing curve 54 (Line)
Info    : [ 60%] Meshing curve 55 (Line)
Info    : [ 60%] Meshing curve 56 (Line)
Info    : [ 60%] Meshing curve 57 (Line)
Info    : [ 70%] Meshing curve 58 (Line)
Info    : [ 70%] Meshing curve 59 (Line)
Info    : [ 70%] Meshing curve 60 (Line)
Info    : [ 70%] Meshing curve 61 (Line)
Info    : [ 70%] Meshing curve 62 (Line)
Info    : [ 70%] Meshing curve 63 (Line)
Info    : [ 70%] Meshing curve 64 (Line)
Info    : [ 70%] Meshing curve 65 (Line)
Info    : [ 70%] Meshing curve 66 (Line)
Info    : [ 80%] Meshing curve 67 (Line)
Info    : [ 80%] Meshing curve 68 (Line)
Info    : [ 80%] Meshing curve 70 (Line)
Info    : [ 80%] Meshing curve 71 (Line)
Info    : [ 80%] Meshing curve 72 (Line)
Info    : [ 80%] Meshing curve 73 (Line)
Info    : [ 80%] Meshing curve 74 (Line)
Info    : [ 80%] Meshing curve 75 (Line)
Info    : [ 80%] Meshing curve 76 (Line)
Info    : [ 90%] Meshing curve 77 (Line)
Info    : [ 90%] Meshing curve 78 (Line)
Info    : [ 90%] Meshing curve 79 (Line)
Info    : [ 90%] Meshing curve 80 (Line)
Info    : [ 90%] Meshing curve 81 (Line)
Info    : [ 90%] Meshing curve 82 (Line)
Info    : [ 90%] Meshing curve 83 (Line)
Info    : [ 90%] Meshing curve 85 (Line)
Info    : [ 90%] Meshing curve 86 (Line)
Info    : [100%] Meshing curve 87 (Line)
Info    : [100%] Meshing curve 88 (Line)
Info    : [100%] Meshing curve 89 (Line)
Info    : [100%] Meshing curve 90 (Line)
Info    : [100%] Meshing curve 91 (Line)
Info    : [100%] Meshing curve 92 (Line)
Info    : [100%] Meshing curve 93 (Line)
Info    : [100%] Meshing curve 95 (Line)
Info    : [100%] Meshing curve 96 (Line)
Info    : Done meshing 1D (Wall 0.0123801s, CPU 0.013691s)
Info    : Meshing 2D...
Info    : [  0%] Meshing surface 1 (Plane, Frontal-Delaunay)
Info    : [ 20%] Meshing surface 2 (Plane, Frontal-Delaunay)
Info    : [ 40%] Meshing surface 3 (Plane, Frontal-Delaunay)
Info    : [ 50%] Meshing surface 4 (Plane, Frontal-Delaunay)
Info    : [ 70%] Meshing surface 5 (Plane, Frontal-Delaunay)
Info    : [ 90%] Meshing surface 6 (Plane, Frontal-Delaunay)
Info    : Done meshing 2D (Wall 0.0390883s, CPU 0.039896s)
Info    : 1474 nodes 3239 elements
</pre></div>
</div>
</div>
</div>
<p>Once the mesh (<code class="docutils literal notranslate"><span class="pre">mesh</span></code>) and mesh tag objects (<code class="docutils literal notranslate"><span class="pre">cell_tags</span></code> and <code class="docutils literal notranslate"><span class="pre">facet_tags</span></code>) are generated we can visualize the resulting unstructured triangular mesh.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utils</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">cell_tags</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/594bcc8639c4364603a4bb076f915931512b3720ce8038ef232cd3b625d90222.png" src="../_images/594bcc8639c4364603a4bb076f915931512b3720ce8038ef232cd3b625d90222.png" />
</div>
</div>
<p>It’s also possible to output the geometry to file using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output_folder</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>
<span class="n">output_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;&lt;file base name&gt;&quot;</span>
<span class="n">geom</span><span class="o">.</span><span class="n">writegeofile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.geo_unrolled&#39;</span><span class="p">)))</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;file</span> <span class="pre">base</span> <span class="pre">name&gt;</span></code> needs to be replaced.</p>
<p>With the geometry (and mesh!) in hand it’s possible to move onto describing the physical problem we want to solve.</p>
</section>
</section>
<section id="kinematic-slab-model">
<h3>Kinematic slab model<a class="headerlink" href="#kinematic-slab-model" title="Link to this heading">#</a></h3>
<p>To describe a kinematic slab subduction zone model we are going to build up a <code class="docutils literal notranslate"><span class="pre">SubductionProblem</span></code> python class that will take in the subduction zone geometry object we just created and use it to set up finite element function spaces and apply appropriate boundary conditions to the resulting finite element Functions.  Once this preliminary setup is taken care of we will describe the mathematical problem we wish to solve and provide finite element forms to the class to solve.  These will depend on the rheology we assume.  Benchmark case 1 uses a simple isoviscous rheology while case 2 uses a dislocation creep viscosity.</p>
<p>To build the python class in an parseable way we will be using some python trickery, rederiving the class in each cell, which isn’t really how this would be done outside of a Jupyter notebook.  We being by declaring the class and its members.  Those initialized to <code class="docutils literal notranslate"><span class="pre">None</span></code> need to be initialized in the class routines that we will describe in the following cells.  Others are initialized to appropriate default values.  Only the first few are intended to be modified and we will write functions to allow us to do this later.</p>
<section id="the-subductionproblem-class">
<h4>The <code class="docutils literal notranslate"><span class="pre">SubductionProblem</span></code> class<a class="headerlink" href="#the-subductionproblem-class" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class describing a kinematic slab subduction zone thermal problem.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># geometry object</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># case specific</span>
    <span class="n">A</span>      <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># age of subducting slab (Myr)</span>
    <span class="n">Vs</span>     <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># slab speed (mm/yr)</span>
    <span class="n">sztype</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># type of sz (&#39;continental&#39; or &#39;oceanic&#39;)</span>
    <span class="n">Ac</span>     <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># age of over-riding plate (Myr) - oceanic only</span>
    <span class="n">As</span>     <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># age of subduction (Myr) - oceanic only</span>
    <span class="n">qs</span>     <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># surface heat flux (W/m^2) - continental only</span>
    
    <span class="c1"># non-dim parameters</span>
    <span class="n">Ts</span>      <span class="o">=</span> <span class="mf">0.0</span>       <span class="c1"># surface temperature (non-dim, also deg C)</span>
    <span class="n">Tm</span>      <span class="o">=</span> <span class="mf">1350.0</span>    <span class="c1"># mantle temperature (non-dim, also deg C)</span>
    <span class="n">kc</span>      <span class="o">=</span> <span class="mf">0.8064516</span> <span class="c1"># crustal thermal conductivity (non-dim)</span>
    <span class="n">km</span>      <span class="o">=</span> <span class="mf">1.0</span>       <span class="c1"># mantle thermal conductivity (non-dim)</span>
    <span class="n">rhoc</span>    <span class="o">=</span> <span class="mf">0.8333333</span> <span class="c1"># crustal density (non-dim)</span>
    <span class="n">rhom</span>    <span class="o">=</span> <span class="mf">1.0</span>       <span class="c1"># mantle density (non-dim)</span>
    <span class="n">cp</span>      <span class="o">=</span> <span class="mf">1.0</span>       <span class="c1"># heat capacity (non-dim)</span>
    <span class="n">H1</span>      <span class="o">=</span> <span class="mf">0.419354</span>  <span class="c1"># upper crustal volumetric heat production (non-dim) </span>
    <span class="n">H2</span>      <span class="o">=</span> <span class="mf">0.087097</span>  <span class="c1"># lower crustal volumetric heat production (non-dim)</span>

    <span class="c1"># dislocation creep parameters</span>
    <span class="n">etamax</span> <span class="o">=</span> <span class="mf">1.0e25</span>    <span class="c1"># maximum viscosity (Pa s)</span>
    <span class="n">nsigma</span> <span class="o">=</span> <span class="mf">3.5</span>       <span class="c1"># stress viscosity power law exponent (non-dim)</span>
    <span class="n">Aeta</span>   <span class="o">=</span> <span class="mf">28968.6</span>   <span class="c1"># pre-exponential viscosity constant (Pa s^(1/nsigma))</span>
    <span class="n">E</span>      <span class="o">=</span> <span class="mf">540.0e3</span>   <span class="c1"># viscosity activation energy (J/mol)</span>
    
    <span class="c1"># finite element degrees</span>
    <span class="n">p_p</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">p_T</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># only allow these options to be set from the update and __init__ functions</span>
    <span class="n">allowed_input_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;Vs&#39;</span><span class="p">,</span> <span class="s1">&#39;sztype&#39;</span><span class="p">,</span> <span class="s1">&#39;Ac&#39;</span><span class="p">,</span> <span class="s1">&#39;As&#39;</span><span class="p">,</span> <span class="s1">&#39;qs&#39;</span><span class="p">,</span> \
                                <span class="s1">&#39;Ts&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm&#39;</span><span class="p">,</span> <span class="s1">&#39;kc&#39;</span><span class="p">,</span> <span class="s1">&#39;km&#39;</span><span class="p">,</span> <span class="s1">&#39;rhoc&#39;</span><span class="p">,</span> <span class="s1">&#39;rhom&#39;</span><span class="p">,</span> <span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span><span class="p">,</span> \
                                <span class="s1">&#39;etamax&#39;</span><span class="p">,</span> <span class="s1">&#39;nsigma&#39;</span><span class="p">,</span> <span class="s1">&#39;Aeta&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> \
                                <span class="s1">&#39;p_p&#39;</span><span class="p">,</span> <span class="s1">&#39;p_T&#39;</span><span class="p">]</span>

    <span class="n">required_parameters</span>     <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;Vs&#39;</span><span class="p">,</span> <span class="s1">&#39;sztype&#39;</span><span class="p">]</span>
    <span class="n">required_if_continental</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;qs&#39;</span><span class="p">]</span>
    <span class="n">required_if_oceanic</span>     <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ac&#39;</span><span class="p">,</span> <span class="s1">&#39;As&#39;</span><span class="p">]</span>

    <span class="c1"># reference values</span>
    <span class="n">k0</span>     <span class="o">=</span> <span class="mf">3.1</span>       <span class="c1"># reference thermal conductivity (W/m/K)</span>
    <span class="n">rho0</span>   <span class="o">=</span> <span class="mf">3300.0</span>    <span class="c1"># reference density (kg/m^3)</span>
    <span class="n">cp0</span>    <span class="o">=</span> <span class="mf">1250.0</span>    <span class="c1"># reference heat capacity (J/kg/K)</span>
    <span class="n">h0</span>     <span class="o">=</span> <span class="mf">1000.0</span>    <span class="c1"># reference length scale (m)</span>
    <span class="n">eta0</span>   <span class="o">=</span> <span class="mf">1.0e21</span>    <span class="c1"># reference viscosity (Pa s)</span>
    <span class="n">T0</span>     <span class="o">=</span> <span class="mf">1.0</span>       <span class="c1"># reference temperature (K)</span>
    <span class="n">R</span>      <span class="o">=</span> <span class="mf">8.3145</span>    <span class="c1"># gas constant (J/mol/K)</span>

    <span class="c1"># derived reference values</span>
    <span class="n">kappa0</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference thermal diffusivity (m^2/s)</span>
    <span class="n">v0</span>     <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference velocity (m/s)</span>
    <span class="n">t0</span>     <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference time-scale (s)</span>
    <span class="n">e0</span>     <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference strain rate (/s)</span>
    <span class="n">p0</span>     <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference pressure (Pa)</span>
    <span class="n">H0</span>     <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference heat source (W/m^3)</span>
    <span class="n">q0</span>     <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># reference heat flux (W/m^2)</span>
    
    <span class="c1"># derived parameters</span>
    <span class="n">A_si</span>   <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># age of subducting slab (s)</span>
    <span class="n">Vs_nd</span>  <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># slab speed (non-dim)</span>
    <span class="n">Ac_si</span>  <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># age of over-riding plate (s) - oceanic only</span>
    <span class="n">As_si</span>  <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># age of subduction (s) - oceanic only</span>
    <span class="n">qs_nd</span>  <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># surface heat flux (non-dim) - continental only</span>

    <span class="c1"># derived from the geometry object</span>
    <span class="n">deltaztrench</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">deltaxcoast</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">deltazuc</span>     <span class="o">=</span> <span class="kc">None</span>
    <span class="n">deltazc</span>      <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># mesh related</span>
    <span class="n">mesh</span>       <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cell_tags</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">facet_tags</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># dimensions and mesh statistics</span>
    <span class="n">gdim</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tdim</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fdim</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">num_cells</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># integral measures</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dS</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># region ids</span>
    <span class="n">wedge_rids</span>       <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_rids</span>        <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crust_rids</span>       <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># wedge submesh</span>
    <span class="n">wedge_submesh</span>    <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_cell_tags</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_facet_tags</span> <span class="o">=</span> <span class="kc">None</span> 
    <span class="n">wedge_cell_map</span>   <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_reverse_cell_map</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># slab submesh</span>
    <span class="n">slab_submesh</span>    <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_cell_tags</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_facet_tags</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_cell_map</span>   <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_reverse_cell_map</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># functionspaces</span>
    <span class="n">Vslab_vp</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Vslab_v</span>   <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Vwedge_vp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Vwedge_v</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">V_T</span>       <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># functions</span>
    <span class="n">slab_vps_i</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_vpw_i</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">T_i</span>         <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># functions that need interpolation</span>
    <span class="n">vs_i</span>      <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ps_i</span>      <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vw_i</span>      <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pw_i</span>      <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_T_i</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_T_i</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># sub (split) functions</span>
    <span class="n">slab_vs_i</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">slab_ps_i</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_vw_i</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_pw_i</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># test functions</span>
    <span class="n">slab_vps_t</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_vw_i</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">T_t</span>        <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># trial functions</span>
    <span class="n">slab_vps_a</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wedge_vpw_a</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">T_a</span>         <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># boundary conditions</span>
    <span class="n">bcs_T</span>   <span class="o">=</span> <span class="kc">None</span> <span class="c1"># temperature</span>
    <span class="n">bcs_vpw</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># wedge velocity/pressure</span>
    <span class="n">bcs_vps</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># slab velocity/pressure</span>
    
</pre></div>
</div>
</div>
</div>
<p>Just as in simpler problems we first need to initialize the mesh.  We do this just as we did above, through the geometry object that we assume is available as a member of the class.</p>
<p>Here describing the geometry is further complicated by the fact that we will want to solve three problems:</p>
<ol class="arabic simple">
<li><p>a thermal problem across the whole domain (the slab, the mantle wedge and the crust)</p></li>
<li><p>a mechanical problem for the flow in the slab (just in the slab portion of the domain, beneath the slab surface)</p></li>
<li><p>a mechanical problem for the corner flow in the mantle wedge (just in the mantle wedge portion of the domain, above the slab surface)</p></li>
</ol>
<p>Note that we do not solve a mechanical problem in the crust, which is assumed rigid (zero velocity) in the benchmark.</p>
<p>To facilitate these three problems we create:</p>
<ul class="simple">
<li><p>a mesh of the whole domain (for the thermal problem)</p></li>
</ul>
<p>and extract from it:</p>
<ul class="simple">
<li><p>a submesh of the slab, and</p></li>
<li><p>a submesh of the mantle wedge.</p></li>
</ul>
<p>We also record various other pieces of information about the mesh, tags demarking different regions and boundaries, and maps to and from the submeshes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setup_meshes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the mesh from the supplied geometry then extract submeshes representing</span>
<span class="sd">        the wedge and slab for the Stokes problems in these regions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check we have a geometry object attached</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># generate the mesh using gmsh</span>
        <span class="c1"># this command also returns cell and facets tags identifying regions and boundaries in the mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">generatemesh</span><span class="p">()</span>

        <span class="c1"># record the dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tdim</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dS</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;dS&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="p">)</span>

        <span class="c1"># get the number of cells</span>
        <span class="n">cell_imap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">index_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tdim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_cells</span> <span class="o">=</span> <span class="n">cell_imap</span><span class="o">.</span><span class="n">size_local</span> <span class="o">+</span> <span class="n">cell_imap</span><span class="o">.</span><span class="n">num_ghosts</span>

        <span class="c1"># record the region ids for the wedge, slab and crust based on the geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_rids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;rid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wedge_dividers</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wedge_rid</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_rids</span>  <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_rid</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crust_rids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;rid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">geom</span><span class="o">.</span><span class="n">crustal_layers</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span>

        <span class="c1"># generate the wedge submesh</span>
        <span class="c1"># this command also returns cell and facet tags mapped from the parent mesh to the submesh</span>
        <span class="c1"># additionally a cell map maps cells in the submesh to the parent mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_submesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_facet_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span> <span class="o">=</span> \
                            <span class="n">utils</span><span class="o">.</span><span class="n">create_submesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_rids</span><span class="p">]),</span> \
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="p">)</span>
        <span class="c1"># create a reverse cell map from the parent mesh to the submesh</span>
        <span class="c1"># (entering -1s in the map where no cell exists in the submesh)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_reverse_cell_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_reverse_cell_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span><span class="p">))</span>

        
        <span class="c1"># generate the slab submesh</span>
        <span class="c1"># this command also returns cell and facet tags mapped from the parent mesh to the submesh</span>
        <span class="c1"># additionally a cell map maps cells in the submesh to the parent mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_submesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_facet_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span>  <span class="o">=</span> \
                            <span class="n">utils</span><span class="o">.</span><span class="n">create_submesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_rids</span><span class="p">]),</span> \
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="p">)</span>
        <span class="c1"># create a reverse cell map from the parent mesh to the submesh</span>
        <span class="c1"># (entering -1s in the map where no cell exists in the submesh)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_reverse_cell_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cells</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_reverse_cell_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>With a mesh in hand we can initialize the functionspaces and dolfinx <code class="docutils literal notranslate"><span class="pre">Function</span></code>s that we will use to solve our problem.</p>
<p>We are going to be solving problems for:</p>
<ul class="simple">
<li><p>velocity in the wedge</p></li>
<li><p>pressure in the wedge</p></li>
<li><p>velocity in the slab</p></li>
<li><p>pressure in the slab</p></li>
<li><p>temperature in the full domain</p></li>
</ul>
<p>and need to select appropriate finite elements for each.  We’re going to use continuous “Lagrange” elements for all but the degree of the polynomials for velocity and pressure cannot be chosen independently but instead need to be selected as an appropriate mixed element pair for numerical stability reasons.  We’re going to use a “Taylor-Hood” element pair, where the velocity degree is one higher than the pressure so only the pressure degree (<code class="docutils literal notranslate"><span class="pre">p_p</span></code>) can be set independently (and defaults to 1 so by default our element pair is known as P2-P1).  The temperature degree (<code class="docutils literal notranslate"><span class="pre">p_T</span></code>) can be set independently but a reasonable default is 2.</p>
<p>With appropriate finite elements selected we can declare functionspace and Functions on the various meshes.  Because our temperature problem will need access to the velocity and pressure from the submeshes, and vice versa, we declare multiple versions of each Function on each sub and parent mesh and will later use them to interpolate the values between the domains.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setup_functionspaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the functionspaces for the problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create finite elements for velocity and pressure</span>
        <span class="c1"># use a P2P1 (Taylor-Hood) element pair where the velocity</span>
        <span class="c1"># degree is one higher than the pressure (so only the pressure</span>
        <span class="c1"># degree can be set)</span>
        <span class="n">v_e</span> <span class="o">=</span> <span class="n">bu</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">basix_cell</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_p</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gdim</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">default_real_type</span><span class="p">)</span>
        <span class="n">p_e</span> <span class="o">=</span> <span class="n">bu</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">basix_cell</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_p</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">default_real_type</span><span class="p">)</span>
        <span class="c1"># combine them into a mixed finite element</span>
        <span class="n">vp_e</span> <span class="o">=</span> <span class="n">bu</span><span class="o">.</span><span class="n">mixed_element</span><span class="p">([</span><span class="n">v_e</span><span class="p">,</span> <span class="n">p_e</span><span class="p">])</span>
        
        <span class="k">def</span> <span class="nf">create_vp_functions</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">name_prefix</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create velocity and pressure functions</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># set up the mixed velocity, pressure functionspace</span>
            <span class="n">V_vp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">vp_e</span><span class="p">)</span>
            <span class="c1"># set up a collapsed velocity functionspace</span>
            <span class="n">V_v</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">V_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">()</span>

            <span class="c1"># set up a mixed velocity, pressure function</span>
            <span class="n">vp_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_vp</span><span class="p">)</span>
            <span class="n">vp_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name_prefix</span><span class="o">+</span><span class="s2">&quot;vp&quot;</span>
            <span class="c1"># split the velocity and pressure subfunctions</span>
            <span class="p">(</span><span class="n">v_i</span><span class="p">,</span> <span class="n">p_i</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp_i</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">v_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name_prefix</span><span class="o">+</span><span class="s2">&quot;v&quot;</span>
            <span class="n">p_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name_prefix</span><span class="o">+</span><span class="s2">&quot;p&quot;</span>
            <span class="c1"># set up the mixed velocity, pressure test function</span>
            <span class="n">vp_t</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V_vp</span><span class="p">)</span>
            <span class="c1"># set up the mixed velocity, pressure trial function</span>
            <span class="n">vp_a</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V_vp</span><span class="p">)</span>

            <span class="c1"># return everything</span>
            <span class="k">return</span> <span class="n">V_vp</span><span class="p">,</span> <span class="n">V_v</span><span class="p">,</span> <span class="n">vp_i</span><span class="p">,</span> <span class="n">v_i</span><span class="p">,</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">vp_t</span><span class="p">,</span> <span class="n">vp_a</span>
        
        <span class="c1"># set up slab functionspace, collapsed velocity sub-functionspace, </span>
        <span class="c1"># combined velocity-pressure Function, split velocity and pressure Functions,</span>
        <span class="c1"># and trial and test functions for</span>
        <span class="c1"># 1. the slab submesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vslab_vp</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">Vslab_v</span><span class="p">,</span>  \
                        <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">slab_vs_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_ps_i</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_a</span> <span class="o">=</span> <span class="n">create_vp_functions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_submesh</span><span class="p">,</span> <span class="s2">&quot;slab_&quot;</span><span class="p">)</span>
        <span class="c1"># 2. the wedge submesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_vp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_v</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vw_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_pw_i</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_a</span> <span class="o">=</span> <span class="n">create_vp_functions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_submesh</span><span class="p">,</span> <span class="s2">&quot;slab_&quot;</span><span class="p">)</span>

        <span class="c1"># set up the mixed velocity, pressure functionspace (not stored)</span>
        <span class="n">V_vp</span>   <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">vp_e</span><span class="p">)</span>
        <span class="n">V_v</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">V_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">()</span>
        <span class="n">V_p</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">V_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">collapse</span><span class="p">()</span>

        <span class="c1"># set up functions defined on the whole mesh</span>
        <span class="c1"># to interpolate the wedge and slab velocities</span>
        <span class="c1"># and pressures to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vs_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vs_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;vs&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ps_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ps_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ps&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vw_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vw_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;vw&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pw_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pw_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;pw&quot;</span>
        
        <span class="c1"># temperature element</span>
        <span class="c1"># the degree of the element can be set independently through p_T</span>
        <span class="n">T_e</span> <span class="o">=</span> <span class="n">bu</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">basix_cell</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">default_real_type</span><span class="p">)</span>
        <span class="c1"># and functionspace on the overall mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_T</span>  <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">T_e</span><span class="p">)</span>

        <span class="c1"># create a dolfinx Function for the temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;T&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_t</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_a</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">)</span>
        
        <span class="c1"># on the slab submesh</span>
        <span class="n">Vslab_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_submesh</span><span class="p">,</span> <span class="n">T_e</span><span class="p">)</span>
        <span class="c1"># and on the wedge submesh</span>
        <span class="n">Vwedge_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_submesh</span><span class="p">,</span> <span class="n">T_e</span><span class="p">)</span>
        <span class="c1"># set up Functions so the solution can be interpolated to these subdomains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_T_i</span>  <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Vslab_T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_T_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;slab_T&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_T_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Vwedge_T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_T_i</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;wedge_T&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Since we’ve just declared multiple Functions on multiple domains, let’s set up some convenience python functions to performed the interpolations:</p>
<ul class="simple">
<li><p>from the global temperature to the temperature declared in the slab and wedge</p></li>
<li><p>from the slab and wedge velocities to global versions of each</p></li>
<li><p>from the slab and wedge pressures to the global versions of each</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">update_T_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the temperature functions defined on the submeshes, given a solution on the full mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_T_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_T_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_v_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the velocity functions defined on the full mesh, given solutions on the sub meshes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vs_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vs_i</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_reverse_cell_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vw_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vw_i</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_reverse_cell_map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_p_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the pressure functions defined on the full mesh, given solutions on the sub meshes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ps_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_ps_i</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_reverse_cell_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pw_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_pw_i</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_reverse_cell_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We now need to set up boundary conditions for our functions.</p>
<p>At the trench inflow boundary we assume a half-space cooling model <span class="math notranslate nohighlight">\(T_\text{trench}(z)\)</span> given by</p>
<div class="amsmath math notranslate nohighlight" id="equation-d7b62147-c61e-4c4f-9d02-2e8f826b9200">
<span class="eqno">(1)<a class="headerlink" href="#equation-d7b62147-c61e-4c4f-9d02-2e8f826b9200" title="Permalink to this equation">#</a></span>\[\begin{equation}
T(x=0, z) = T_\text{trench}(z) = T_s + (T_m - T_s ) {\rm erf} \left( \tfrac{z}{z_d} \right)
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(z\)</span> is depth below the surface, <span class="math notranslate nohighlight">\(T_s\)</span> is the non-dimensional surface temperature, <span class="math notranslate nohighlight">\(T_m\)</span> the non-dimensional mantle temperature, and the non-dimensional scale depth <span class="math notranslate nohighlight">\(z_d\)</span> is proportional to the dimensional age of the incoming lithosphere
<span class="math notranslate nohighlight">\(A^*\)</span> via <span class="math notranslate nohighlight">\(z_d =  2 \tfrac{\sqrt{ \kappa_0 A^*}}{h_0} \)</span>, where <span class="math notranslate nohighlight">\(\kappa_0\)</span> and <span class="math notranslate nohighlight">\(h_0\)</span> are the reference diffusivity and lengthscale respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">T_trench</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return temperature at the trench</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zd</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">A_si</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span>  <span class="c1"># incoming slab scale depth (non-dim)</span>
        <span class="n">deltazsurface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaxcoast</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)),</span> <span class="mf">0.0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ts</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tm</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Ts</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">+</span><span class="n">deltazsurface</span><span class="p">)</span><span class="o">/</span><span class="n">zd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In the ocean-ocean (<code class="docutils literal notranslate"><span class="pre">sztype</span> <span class="pre">==</span> <span class="pre">&quot;oceanic&quot;</span></code>) subduction cases, the wedge inflow boundary condition on temperature down to <span class="math notranslate nohighlight">\(z_\textrm{io}\)</span> (<code class="docutils literal notranslate"><span class="pre">io_depth</span></code>) is</p>
<div class="amsmath math notranslate nohighlight" id="equation-6638276e-468e-432b-aaea-10d9ee613d88">
<span class="eqno">(2)<a class="headerlink" href="#equation-6638276e-468e-432b-aaea-10d9ee613d88" title="Permalink to this equation">#</a></span>\[\begin{equation}
T(x=L, z) = T_\text{backarc,o}(z) ~=~ T_s + (T_m - T_s ) {\rm erf} \left( \tfrac{z}{z_c} \right) 
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(z_c\)</span> is related to the dimensional age of the overriding plate
<span class="math notranslate nohighlight">\(A_c^*\)</span> minus the age of subduction <span class="math notranslate nohighlight">\(A_s^*\)</span> via <span class="math notranslate nohighlight">\(z_c =  2 \tfrac{\sqrt{ \kappa_0 (A_c^*-A^*_s)}}{h_0} \)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">T_backarc_o</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return temperature at the trench</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zc</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa0</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ac_si</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">As_si</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span> <span class="c1"># overriding plate scale depth (non-dim)</span>
        <span class="n">deltazsurface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaxcoast</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)),</span> <span class="mf">0.0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ts</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tm</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Ts</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">+</span><span class="n">deltazsurface</span><span class="p">)</span><span class="o">/</span><span class="n">zc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The benchmark cases are ocean-continent (<code class="docutils literal notranslate"><span class="pre">sztype</span> <span class="pre">==</span> <span class="pre">&quot;continental&quot;</span></code>) where the wedge inflow the boundary condition on temperature is chosen to be a geotherm <span class="math notranslate nohighlight">\(T_\text{backarc}(z)\)</span> consistent with these parameters</p>
<div class="amsmath math notranslate nohighlight" id="equation-03751645-374f-4c6a-a3e8-8992893d41df">
<span class="eqno">(3)<a class="headerlink" href="#equation-03751645-374f-4c6a-a3e8-8992893d41df" title="Permalink to this equation">#</a></span>\[\begin{equation}
T(x=L,z) = T_\text{backarc,c}(z) ~=~
 \left\{ \begin{array}{l&#64;{\quad:\quad}l}
 T_s -\frac{H_1 z^2}{2 k_c}~+~\frac{q_s}{k_c}z  &amp; z ~\in~ [0,z_1] \\
 T_\text{backarc,c}(z=z_1)-\frac{H_2 (z-z_1)^2}{2 k_c} ~+~\frac{q_1}{k_c}(z-z_1) &amp;  z ~\in~ (z_1, z_2] \\
 \min(T_m,T_\text{backarc,c}(z=z_2)+\frac{q_2}{k_m}(z-z_2))&amp; z ~\in~(z_2, z_{io}]
   \end{array}
  \right.
\end{equation}\]</div>
<p>The discrete heat flow values <span class="math notranslate nohighlight">\(q_i\)</span> are the heat flow at the crustal boundaries at depth <span class="math notranslate nohighlight">\(z\)</span>=<span class="math notranslate nohighlight">\(z_i\)</span> (<span class="math notranslate nohighlight">\(z_1\)</span> being the upper crust boundary depth, <code class="docutils literal notranslate"><span class="pre">uc_depth</span></code>, and <span class="math notranslate nohighlight">\(z_2\)</span> being the lower crust boundary depth, <code class="docutils literal notranslate"><span class="pre">lc_depth</span></code>)
that can be easily found as
<span class="math notranslate nohighlight">\(q_1=q_s-H_1 z_1\)</span> and <span class="math notranslate nohighlight">\(q_2=q_1-H_2 (z_2-z_1)\)</span>. <span class="math notranslate nohighlight">\(H_1\)</span> (<code class="docutils literal notranslate"><span class="pre">H1</span></code>), <span class="math notranslate nohighlight">\(H_2\)</span> (<code class="docutils literal notranslate"><span class="pre">H2</span></code>), <span class="math notranslate nohighlight">\(k_c\)</span> (<code class="docutils literal notranslate"><span class="pre">kc</span></code>) and <span class="math notranslate nohighlight">\(k_m\)</span> (<code class="docutils literal notranslate"><span class="pre">km</span></code>) are the non-dimensional heat production in the upper and lower crusts and the non-dimensional thermal conductivities in the crust and mantle respectively.  Note that <span class="math notranslate nohighlight">\(q_s\)</span> above is the non-dimensional surface heat flux that is related to the dimensional class parameter <code class="docutils literal notranslate"><span class="pre">qs</span></code> by dividing <code class="docutils literal notranslate"><span class="pre">qs</span></code> by a reference heat flux value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">T_backarc_c</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return continental backarc temperature</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">deltazsurface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaxcoast</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)),</span> <span class="mf">0.0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">deltazsurface</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazuc</span><span class="p">:</span>
                <span class="c1"># if in the upper crust</span>
                <span class="n">deltaz</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">deltazsurface</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="o">*</span><span class="p">(</span><span class="n">deltaz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qs_nd</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span><span class="o">*</span><span class="n">deltaz</span>
            <span class="k">elif</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">deltazsurface</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazc</span><span class="p">:</span>
                <span class="c1"># if in the lower crust</span>
                <span class="n">deltaz1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazuc</span> <span class="c1">#- deltazsurface[i]</span>
                <span class="n">T1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="o">*</span><span class="p">(</span><span class="n">deltaz1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qs_nd</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span><span class="o">*</span><span class="n">deltaz1</span>
                <span class="n">q1</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="o">*</span><span class="n">deltaz1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs_nd</span>
                <span class="n">deltaz</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">deltazsurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazuc</span><span class="p">)</span>
                <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">T1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H2</span><span class="o">*</span><span class="p">(</span><span class="n">deltaz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span><span class="o">*</span><span class="n">deltaz</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># otherwise, we&#39;re in the mantle</span>
                <span class="n">deltaz1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazuc</span> <span class="c1"># - deltazsurface[i]</span>
                <span class="n">T1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="o">*</span><span class="p">(</span><span class="n">deltaz1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qs_nd</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span><span class="o">*</span><span class="n">deltaz1</span>
                <span class="n">q1</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="o">*</span><span class="n">deltaz1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs_nd</span>
                <span class="n">deltaz2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazc</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazuc</span> <span class="c1">#- deltazsurface[i]</span>
                <span class="n">T2</span> <span class="o">=</span> <span class="n">T1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H2</span><span class="o">*</span><span class="p">(</span><span class="n">deltaz2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">q1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="p">)</span><span class="o">*</span><span class="n">deltaz2</span>
                <span class="n">q2</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H2</span><span class="o">*</span><span class="n">deltaz2</span> <span class="o">+</span> <span class="n">q1</span>
                <span class="n">deltaz</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">deltazsurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltazc</span><span class="p">)</span>
                <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tm</span><span class="p">,</span> <span class="n">T2</span> <span class="o">+</span> <span class="p">(</span><span class="n">q2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">deltaz</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">T</span>
        
</pre></div>
</div>
</div>
</div>
<p>The wedge flow, <span class="math notranslate nohighlight">\(\vec{v}_w\)</span> (<code class="docutils literal notranslate"><span class="pre">wedge_vw_i</span></code>), is driven by the coupling of the slab to the wedge at coupling depth <span class="math notranslate nohighlight">\(z\)</span>=<span class="math notranslate nohighlight">\(d_c\)</span> (<code class="docutils literal notranslate"><span class="pre">partial_coupling_depth</span></code> in the slab spline). Above the coupling depth the boundary condition is zero velocity. Below
the coupling depth the velocity is parallel to the slab and has non-dimensional magnitude <span class="math notranslate nohighlight">\(V_s\)</span> (dimensional <code class="docutils literal notranslate"><span class="pre">Vs</span></code>, non-dimensional <code class="docutils literal notranslate"><span class="pre">Vs_nd</span></code>). A smooth
transition from zero to full speed over a short depth interval
enhances the accuracy of the Stokes solution so here coupling begins at <span class="math notranslate nohighlight">\(z\)</span>=<span class="math notranslate nohighlight">\(d_c\)</span>, ramping up linearly until full coupling is reached at <span class="math notranslate nohighlight">\(z\)</span>=<span class="math notranslate nohighlight">\(d_{fc}\)</span> (<code class="docutils literal notranslate"><span class="pre">full_coupling_depth</span></code> in the slab spline, 2.5km lower than the partial coupling depth by default).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">vw_slabtop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the wedge velocity on the slab surface</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># grab the partial and full coupling depths so we can set up a linear ramp in velocity between them</span>
        <span class="n">pcd</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">findpoint</span><span class="p">(</span><span class="s2">&quot;Slab::PartialCouplingDepth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">y</span>
        <span class="n">fcd</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">findpoint</span><span class="p">(</span><span class="s2">&quot;Slab::FullCouplingDepth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">y</span>
        <span class="n">dcd</span> <span class="o">=</span> <span class="n">fcd</span><span class="o">-</span><span class="n">pcd</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gdim</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">v</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">pcd</span><span class="p">)</span><span class="o">/</span><span class="n">dcd</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Vs_nd</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">unittangentx</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">v</span>
    
</pre></div>
</div>
</div>
</div>
<p>The slab flow, <span class="math notranslate nohighlight">\(\vec{v}_s\)</span>, is driven by the imposition of a Dirichlet boundary condition parallel to the slab with magnitude <span class="math notranslate nohighlight">\(V_s\)</span> along the entire length of the slab surface, resulting in a discontinuity between <span class="math notranslate nohighlight">\(\vec{v}\)</span> and <span class="math notranslate nohighlight">\(\vec{v}_s\)</span> above the coupling depth (which is why we are solving for two separate velocities and pressure).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">vs_slabtop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the slab velocity on the slab surface</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gdim</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">v</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vs_nd</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">unittangentx</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">v</span>
</pre></div>
</div>
</div>
</div>
<p>Having declared python functions for the various boundary conditions we can apply them to our Functions.  This involves identifying the degrees of freedom (DOFs) in our different sub problems that correspond to our boundaries using the <code class="docutils literal notranslate"><span class="pre">facet_tag</span></code>s.  Having done this we can declare our boundary conditions and apply them to our solution Functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setup_boundaryconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the boundary conditions and apply them to the functions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># locate the degrees of freedom (dofs) where various boundary conditions will be applied</span>
        <span class="c1"># on the top of the wedge for the wedge velocity</span>
        <span class="n">wedgetop_dofs_Vwedge_v</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_v</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span><span class="p">,</span>
                                                                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">pid</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">crustal_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]])]))</span>
        <span class="c1"># on the slab surface for the slab velocity</span>
        <span class="n">slab_dofs_Vslab_v</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Vslab_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vslab_v</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span><span class="p">,</span> 
                                                           <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">pids</span><span class="p">)]))</span>
        <span class="c1"># on the slab surface for the wedge velocity</span>
        <span class="n">slab_dofs_Vwedge_v</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_v</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span><span class="p">,</span> 
                                                            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">pids</span><span class="p">)]))</span>
        <span class="c1"># on the top of the domain for the temperature</span>
        <span class="n">top_dofs_V_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span><span class="p">,</span> 
                                                      <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">coast_sid</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">top_sid</span><span class="p">)]))</span>
        <span class="c1"># on the side of the slab side of the domain for the temperature</span>
        <span class="n">slabside_dofs_V_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span><span class="p">,</span> 
                                                           <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">pid</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_side_lines</span><span class="p">])]))</span>
        <span class="c1"># on the side of the wedge side of the domain for the temperature</span>
        <span class="n">wedgeside_dofs_V_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdim</span><span class="p">,</span> 
                                                            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">pid</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wedge_side_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])]))</span>
        
        <span class="c1"># temperature boundary conditions        </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># zero on the top of the domain</span>
        <span class="n">zero_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">zero_c</span><span class="p">,</span> <span class="n">top_dofs_V_T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">))</span>
        <span class="c1"># an incoming slab thermal profile on the lhs of the domain</span>
        <span class="n">T_trench_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">)</span>
        <span class="n">T_trench_f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_trench</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">T_trench_f</span><span class="p">,</span> <span class="n">slabside_dofs_V_T</span><span class="p">))</span>
        <span class="c1"># on the top (above iodepth) of the incoming wedge side of the domain</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sztype</span><span class="o">==</span><span class="s1">&#39;continental&#39;</span><span class="p">:</span>
            <span class="n">T_backarc_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">)</span>
            <span class="n">T_backarc_f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_backarc_c</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">T_backarc_f</span><span class="p">,</span> <span class="n">wedgeside_dofs_V_T</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">T_backarc_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_T</span><span class="p">)</span>
            <span class="n">T_backarc_f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_backarc_o</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">T_backarc_f</span><span class="p">,</span> <span class="n">wedgeside_dofs_V_T</span><span class="p">))</span>
            
        <span class="c1"># wedge velocity (and pressure) boundary conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># zero velocity on the top of the wedge</span>
        <span class="n">zero_vw_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_v</span><span class="p">)</span>
        <span class="n">zero_vw_f</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">zero_vw_f</span><span class="p">,</span> <span class="n">wedgetop_dofs_Vwedge_v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
        <span class="c1"># kinematic slab on the slab surface of the wedge</span>
        <span class="n">vw_slabtop_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_v</span><span class="p">)</span>
        <span class="n">vw_slabtop_f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vw_slabtop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">vw_slabtop_f</span><span class="p">,</span> <span class="n">slab_dofs_Vwedge_v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vwedge_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

        <span class="c1"># slab velocity (and pressure) boundary conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># kinematic slab on the slab surface of the slab</span>
        <span class="n">vs_slabtop_f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vslab_v</span><span class="p">)</span>
        <span class="n">vs_slabtop_f</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs_slabtop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">vs_slabtop_f</span><span class="p">,</span> <span class="n">slab_dofs_Vslab_v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vslab_vp</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

        <span class="c1"># interpolate the temperature boundary conditions as initial conditions/guesses</span>
        <span class="c1"># to the whole domain (not just the boundaries)</span>
        <span class="c1"># on the wedge and crust side of the domain apply the wedge condition</span>
        <span class="n">nonslab_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">crust_rids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_rids</span><span class="p">]</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">domain</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">T_backarc_f</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="n">nonslab_cells</span><span class="p">)</span>
        <span class="c1"># on the slab side of the domain apply the slab condition</span>
        <span class="n">slab_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_rids</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">T_trench_f</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="n">slab_cells</span><span class="p">)</span>
        <span class="c1"># update the interpolated T functions for consistency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_T_functions</span><span class="p">()</span>

        <span class="c1"># just set the boundary conditions on the boundaries for the velocities</span>
        <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">set_bc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">set_bc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vps</span><span class="p">)</span>
        <span class="c1"># and update the interpolated v functions for consistency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_v_functions</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>This concludes the initial setup of our <code class="docutils literal notranslate"><span class="pre">SubductionProblem</span></code> class and is the first point where we can easily inspect what we’ve done and check it looks correct.  First though we need some routines that allow us to set the case-dependent parameters and initialize the class.  We do that by declaring an <code class="docutils literal notranslate"><span class="pre">update</span></code> function (that allows us to update the parameters whenever we wish) and an <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function (that initializes the class when it is declared and simply calls the <code class="docutils literal notranslate"><span class="pre">update</span></code> function for the first time).</p>
<p>The case-specific parameters that we require to be set (don’t have defaults) are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">geom</span></code>   - the geometry object</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">A</span></code>      - the dimensional age of the subducting slab in Myr (<span class="math notranslate nohighlight">\(A^*\)</span>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sztype</span></code> - the type of the subduction zone (<code class="docutils literal notranslate"><span class="pre">&quot;continental&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;oceanic&quot;</span></code>)</p></li>
</ul>
<p>For oceanic cases we also require:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Ac</span></code>     - the dimensional age of the over-riding plate in Myr (<span class="math notranslate nohighlight">\(A^*_c\)</span>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">As</span></code>     - the dimensional age of subduction in Myr (<span class="math notranslate nohighlight">\(A^*_s\)</span>)</p></li>
</ul>
<p>While continental cases require:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">qs</span></code>     - the dimensional surface heat flux in W/m<span class="math notranslate nohighlight">\(^2\)</span> (<span class="math notranslate nohighlight">\(q_s^*\)</span>)</p></li>
</ul>
<p>We also allow these non-dimensional parameters to be set</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Ts</span></code>     - surface temperature (non-dim, also deg C, <span class="math notranslate nohighlight">\(T_s\)</span>, default 0)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Tm</span></code>     - mantle temperature (non-dim, also deg C, <span class="math notranslate nohighlight">\(T_m\)</span>, default 1350)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kc</span></code>     - crustal thermal conductivity (non-dim, <span class="math notranslate nohighlight">\(k_c\)</span>, default 0.8064516)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">km</span></code>     - mantle thermal conductivity (non-dim, <span class="math notranslate nohighlight">\(k_m\)</span>, default 1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rhoc</span></code>   - crustal density (non-dim, <span class="math notranslate nohighlight">\(\rho_c\)</span>, default 0.833333)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rhom</span></code>   - mantle density (non-dim, <span class="math notranslate nohighlight">\(\rho_m\)</span>, default 1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cp</span></code>     - heat capacity (non-dim, <span class="math notranslate nohighlight">\(c_p\)</span>, default 1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">H1</span></code>     - upper crustal volumetric heat production (non-dim, <span class="math notranslate nohighlight">\(H_1\)</span>, default 0.419354)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">H2</span></code>     - lower crustal volumetric heat production (non-dim, <span class="math notranslate nohighlight">\(H_2\)</span>, default 0.087097)</p></li>
</ul>
<p>As well as the dislocation creep parameters that we will need later:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">etamax</span></code> - maximum viscosity (Pa s, <span class="math notranslate nohighlight">\(\eta_\text{max}\)</span>, default <span class="math notranslate nohighlight">\(10^25\)</span>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nsigma</span></code> - stress viscosity power law exponent (non-dim, <span class="math notranslate nohighlight">\(n_\sigma\)</span>, default 3.5)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Aeta</span></code>   - pre-exponential viscosity constant (Pa s<span class="math notranslate nohighlight">\(^\frac{1}{n_\sigma}\)</span>, <span class="math notranslate nohighlight">\(A_\eta\)</span>, default 28968.6 Pa s<span class="math notranslate nohighlight">\(^\frac{1}{n_\sigma}\)</span>))</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">E</span></code>      - viscosity activation energy (J/mol, <span class="math notranslate nohighlight">\(E\)</span>, default 540,000 J/mol)</p></li>
</ul>
<p>Finally, we also allow the finite element degrees to be set:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">p_p</span></code>    - pressure polynomial degree (default 1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">p_T</span></code>    - temperature polynomial degree (default 2)</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">update</span></code> function uses these parameters to set all the other parameters, and to initialize the meshes, functionspaces, Functions and boundary conditions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the subduction problem with the allowed input parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># loop over the keyword arguments and apply any that are allowed as input parameters</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_input_parameters</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="c1"># check required parameters are set</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_parameters</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; must be set but isn&#39;t.  Please supply a value.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">,))</span>

        <span class="c1"># check sztype dependent required parameters are set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sztype</span> <span class="o">==</span> <span class="s2">&quot;continental&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_if_continental</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; must be set if the sztype is continental.  Please supply a value.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">,))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sztype</span> <span class="o">==</span> <span class="s2">&quot;oceanic&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_if_oceanic</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; must be set if the sztype is oceanic.  Please supply a value.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown sztype (</span><span class="si">{}</span><span class="s2">).  Please set a valid sztype (continental or oceanic).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sztype</span><span class="p">))</span>
            
        <span class="c1"># set the geometry and generate the meshes and functionspaces</span>
        <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geom</span> <span class="o">=</span> <span class="n">geom</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_meshes</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_functionspaces</span><span class="p">()</span>

        <span class="c1"># derived reference values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">rho0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">cp0</span>   <span class="c1"># reference thermal diffusivity (m^2/s)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v0</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span>          <span class="c1"># reference velocity (m/s)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t0</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">v0</span>              <span class="c1"># reference time (s)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e0</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span>              <span class="c1"># reference strain rate (/s)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p0</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">eta0</span>            <span class="c1"># reference pressure (Pa)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H0</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">T0</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># reference heat source (W/m^3)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q0</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span>              <span class="c1"># reference heat flux (W/m^2)</span>

        <span class="c1"># derived parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_si</span>      <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Myr_to_s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>   <span class="c1"># age of subducting slab (s)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vs_nd</span>     <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mmpyr_to_mps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vs</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">v0</span> <span class="c1"># slab speed (non-dim)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sztype</span> <span class="o">==</span> <span class="s1">&#39;oceanic&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ac_si</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Myr_to_s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ac</span><span class="p">)</span>  <span class="c1"># age of over-riding plate (s)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">As_si</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Myr_to_s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">As</span><span class="p">)</span>  <span class="c1"># age of subduction (s)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qs_nd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">q0</span>          <span class="c1"># surface heat flux (non-dim)</span>
        
        <span class="c1"># parameters derived from from the geometry</span>
        <span class="c1"># depth of the trench</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">findpoint</span><span class="p">(</span><span class="s1">&#39;Slab::Trench&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">y</span>
        <span class="c1"># coastline distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltaxcoast</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">coast_distance</span>
        <span class="c1"># crust depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltazc</span>      <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">crustal_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sztype</span> <span class="o">==</span> <span class="s2">&quot;continental&quot;</span><span class="p">:</span>
            <span class="c1"># upper crust depth</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deltazuc</span>     <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">crustal_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_boundaryconditions</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a SubductionProblem.</span>

<span class="sd">        Arguments:</span>
<span class="sd">          * geom  - an instance of a subduction zone geometry</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">         required:</span>
<span class="sd">          * A      - age of subducting slab (in Myr) [required]</span>
<span class="sd">          * Vs     - incoming slab speed (in mm/yr) [required]</span>
<span class="sd">          * sztype - type of subduction zone (either &#39;continental&#39; or &#39;oceanic&#39;) [required]</span>
<span class="sd">          * Ac     - age of the over-riding plate (in Myr) [required if sztype is &#39;oceanic&#39;]</span>
<span class="sd">          * As     - age of subduction (in Myr) [required if sztype is &#39;oceanic&#39;]</span>
<span class="sd">          * qs     - surface heat flux (in W/m^2) [required if sztype is &#39;continental&#39;]</span>

<span class="sd">         optional:</span>
<span class="sd">          * Ts   - surface temperature (deg C, corresponds to non-dim)</span>
<span class="sd">          * Tm   - mantle temperature (deg C, corresponds to non-dim)</span>
<span class="sd">          * kc   - crustal thermal conductivity (non-dim)</span>
<span class="sd">          * km   - mantle thermal conductivity (non-dim)</span>
<span class="sd">          * rhoc - crustal density (non-dim)</span>
<span class="sd">          * rhom - mantle density (non-dim)</span>
<span class="sd">          * cp   - isobaric heat capacity (non-dim)</span>
<span class="sd">          * H1   - upper crustal volumetric heat production (non-dim)</span>
<span class="sd">          * H2   - lower crustal volumetric heat production (non-dim)</span>

<span class="sd">         optional (dislocation creep rheology):</span>
<span class="sd">          * etamax - maximum viscosity (Pas) [only relevant for dislocation creep rheologies]</span>
<span class="sd">          * nsigma - stress viscosity power law exponents (non-dim) [only relevant for dislocation creep rheologies]</span>
<span class="sd">          * Aeta   - pre-exponential viscosity constant (Pa s^(1/n)) [only relevant for dislocation creep rheologies]</span>
<span class="sd">          * E      - viscosity activation energy (J/mol) [only relevant for dislocation creep rheologies]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="testing-the-initial-setup">
<h4>Testing the initial setup<a class="headerlink" href="#testing-the-initial-setup" title="Link to this heading">#</a></h4>
<p>The benchmark case uses a 100 Myr old slab subducting at 100 mm/yr.  Since it is a continental case we also have to set a surface heat flux, which is 0.065 W/m<span class="math notranslate nohighlight">\(^2\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A</span>      <span class="o">=</span> <span class="mf">100.0</span>      <span class="c1"># age of subducting slab (Myr)</span>
<span class="n">qs</span>     <span class="o">=</span> <span class="mf">0.065</span>      <span class="c1"># surface heat flux (W/m^2)</span>
<span class="n">Vs</span>     <span class="o">=</span> <span class="mf">100.0</span>      <span class="c1"># slab speed (mm/yr)</span>
<span class="n">sztype</span> <span class="o">=</span> <span class="s1">&#39;continental&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>We can pass these into the class (which calls the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function) and it will generate our meshes (hence we will get a lot of output again), initialize our functionspaces and Functions, and setup the boundary conditions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sz</span> <span class="o">=</span> <span class="n">SubductionProblem</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">Vs</span><span class="o">=</span><span class="n">Vs</span><span class="p">,</span> <span class="n">sztype</span><span class="o">=</span><span class="n">sztype</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning : Gmsh has aleady been initialized
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Info    : Meshing 1D...
Info    : [  0%] Meshing curve 1 (Line)
Info    : [ 10%] Meshing curve 2 (Line)
Info    : [ 10%] Meshing curve 3 (Line)
Info    : [ 10%] Meshing curve 4 (Line)
Info    : [ 10%] Meshing curve 5 (Line)
Info    : [ 10%] Meshing curve 6 (Line)
Info    : [ 10%] Meshing curve 7 (Line)
Info    : [ 10%] Meshing curve 8 (Line)
Info    : [ 10%] Meshing curve 9 (Line)
Info    : [ 10%] Meshing curve 10 (Line)
Info    : [ 20%] Meshing curve 11 (Line)
Info    : [ 20%] Meshing curve 12 (Line)
Info    : [ 20%] Meshing curve 13 (Line)
Info    : [ 20%] Meshing curve 14 (Line)
Info    : [ 20%] Meshing curve 15 (Line)
Info    : [ 20%] Meshing curve 16 (Line)
Info    : [ 20%] Meshing curve 17 (Line)
Info    : [ 20%] Meshing curve 18 (Line)
Info    : [ 20%] Meshing curve 19 (Line)
Info    : [ 30%] Meshing curve 20 (Line)
Info    : [ 30%] Meshing curve 21 (Line)
Info    : [ 30%] Meshing curve 22 (Line)
Info    : [ 30%] Meshing curve 23 (Line)
Info    : [ 30%] Meshing curve 24 (Line)
Info    : [ 30%] Meshing curve 25 (Line)
Info    : [ 30%] Meshing curve 27 (Line)
Info    : [ 30%] Meshing curve 28 (Line)
Info    : [ 30%] Meshing curve 29 (Line)
Info    : [ 40%] Meshing curve 30 (Line)
Info    : [ 40%] Meshing curve 31 (Line)
Info    : [ 40%] Meshing curve 32 (Line)
Info    : [ 40%] Meshing curve 33 (Line)
Info    : [ 40%] Meshing curve 34 (Line)
Info    : [ 40%] Meshing curve 35 (Line)
Info    : [ 40%] Meshing curve 36 (Line)
Info    : [ 40%] Meshing curve 37 (Line)
Info    : [ 40%] Meshing curve 38 (Line)
Info    : [ 50%] Meshing curve 39 (Line)
Info    : [ 50%] Meshing curve 40 (Line)
Info    : [ 50%] Meshing curve 41 (Line)
Info    : [ 50%] Meshing curve 42 (Line)
Info    : [ 50%] Meshing curve 43 (Line)
Info    : [ 50%] Meshing curve 44 (Line)
Info    : [ 50%] Meshing curve 45 (Line)
Info    : [ 50%] Meshing curve 46 (Line)
Info    : [ 50%] Meshing curve 47 (Line)
Info    : [ 60%] Meshing curve 48 (Line)
Info    : [ 60%] Meshing curve 49 (Line)
Info    : [ 60%] Meshing curve 50 (Line)
Info    : [ 60%] Meshing curve 51 (Line)
Info    : [ 60%] Meshing curve 52 (Line)
Info    : [ 60%] Meshing curve 54 (Line)
Info    : [ 60%] Meshing curve 55 (Line)
Info    : [ 60%] Meshing curve 56 (Line)
Info    : [ 60%] Meshing curve 57 (Line)
Info    : [ 70%] Meshing curve 58 (Line)
Info    : [ 70%] Meshing curve 59 (Line)
Info    : [ 70%] Meshing curve 60 (Line)
Info    : [ 70%] Meshing curve 61 (Line)
Info    : [ 70%] Meshing curve 62 (Line)
Info    : [ 70%] Meshing curve 63 (Line)
Info    : [ 70%] Meshing curve 64 (Line)
Info    : [ 70%] Meshing curve 65 (Line)
Info    : [ 70%] Meshing curve 66 (Line)
Info    : [ 80%] Meshing curve 67 (Line)
Info    : [ 80%] Meshing curve 68 (Line)
Info    : [ 80%] Meshing curve 70 (Line)
Info    : [ 80%] Meshing curve 71 (Line)
Info    : [ 80%] Meshing curve 72 (Line)
Info    : [ 80%] Meshing curve 73 (Line)
Info    : [ 80%] Meshing curve 74 (Line)
Info    : [ 80%] Meshing curve 75 (Line)
Info    : [ 80%] Meshing curve 76 (Line)
Info    : [ 90%] Meshing curve 77 (Line)
Info    : [ 90%] Meshing curve 78 (Line)
Info    : [ 90%] Meshing curve 79 (Line)
Info    : [ 90%] Meshing curve 80 (Line)
Info    : [ 90%] Meshing curve 81 (Line)
Info    : [ 90%] Meshing curve 82 (Line)
Info    : [ 90%] Meshing curve 83 (Line)
Info    : [ 90%] Meshing curve 85 (Line)
Info    : [ 90%] Meshing curve 86 (Line)
Info    : [100%] Meshing curve 87 (Line)
Info    : [100%] Meshing curve 88 (Line)
Info    : [100%] Meshing curve 89 (Line)
Info    : [100%] Meshing curve 90 (Line)
Info    : [100%] Meshing curve 91 (Line)
Info    : [100%] Meshing curve 92 (Line)
Info    : [100%] Meshing curve 93 (Line)
Info    : [100%] Meshing curve 95 (Line)
Info    : [100%] Meshing curve 96 (Line)
Info    : Done meshing 1D (Wall 0.0144212s, CPU 0.016893s)
Info    : Meshing 2D...
Info    : [  0%] Meshing surface 1 (Plane, Frontal-Delaunay)
Info    : [ 20%] Meshing surface 2 (Plane, Frontal-Delaunay)
Info    : [ 40%] Meshing surface 3 (Plane, Frontal-Delaunay)
Info    : [ 50%] Meshing surface 4 (Plane, Frontal-Delaunay)
Info    : [ 70%] Meshing surface 5 (Plane, Frontal-Delaunay)
Info    : [ 90%] Meshing surface 6 (Plane, Frontal-Delaunay)
Info    : Done meshing 2D (Wall 0.039777s, CPU 0.040538s)
Info    : 1474 nodes 3239 elements
</pre></div>
</div>
</div>
</div>
<p>We can then plot our temperature and velocity Functions to see if their boundary (and initial in the case of temperature) conditions look correct.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utils</span><span class="o">.</span><span class="n">plot_scalar</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sz</span><span class="o">.</span><span class="n">T0</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_vector</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">vw_i</span><span class="p">,</span> <span class="n">glyph_factor</span><span class="o">=</span><span class="mi">6</span><span class="o">/</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">))</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_vector</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">vs_i</span><span class="p">,</span> <span class="n">glyph_factor</span><span class="o">=</span><span class="mi">6</span><span class="o">/</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1266b414ca0c88955eb40818b1b14b7aedb27e40efaeed109395b43b18e7d2c0.png" src="../_images/1266b414ca0c88955eb40818b1b14b7aedb27e40efaeed109395b43b18e7d2c0.png" />
<img alt="../_images/1d0b8fed2c1f271183da17e65f01c862ea27eee418cad7a93f0f49d4712b1761.png" src="../_images/1d0b8fed2c1f271183da17e65f01c862ea27eee418cad7a93f0f49d4712b1761.png" />
<img alt="../_images/e0fd528df102c69044b6e3b6807774e79b7f9cdd41ee2e6b8521ba99a4516ee1.png" src="../_images/e0fd528df102c69044b6e3b6807774e79b7f9cdd41ee2e6b8521ba99a4516ee1.png" />
</div>
</div>
</section>
<section id="isoviscous-case-1">
<h4>Isoviscous (Case 1)<a class="headerlink" href="#isoviscous-case-1" title="Link to this heading">#</a></h4>
<p>As the setup of our boundary and initial conditions looks correct we now wish to solve partial differential equations describing the thermal structure of a subduction zone in our domain.</p>
<p>For the velocity <span class="math notranslate nohighlight">\(\vec{v}\)</span>, and pressure, <span class="math notranslate nohighlight">\(p\)</span>, we wish to solve the Stokes equations</p>
<div class="amsmath math notranslate nohighlight" id="equation-55861b2c-7e53-4f0c-b2fd-41427b6760c8">
<span class="eqno">(4)<a class="headerlink" href="#equation-55861b2c-7e53-4f0c-b2fd-41427b6760c8" title="Permalink to this equation">#</a></span>\[\begin{equation}
-\nabla \cdot \left(2\eta \frac{\nabla \vec{v} + \nabla \vec{v}^T}{2} \right) + \nabla p = 0
\end{equation}\]</div>
<div class="amsmath math notranslate nohighlight" id="equation-a366aae5-9180-4517-8477-6a96a9691721">
<span class="eqno">(5)<a class="headerlink" href="#equation-a366aae5-9180-4517-8477-6a96a9691721" title="Permalink to this equation">#</a></span>\[\begin{equation}
\nabla \cdot \vec{v} = 0
\end{equation}\]</div>
<p>for an incompressible viscous fluid where <span class="math notranslate nohighlight">\(\vec{v}\)</span> can be the wedge velocity, <span class="math notranslate nohighlight">\(\vec{v}_w\)</span> (<code class="docutils literal notranslate"><span class="pre">wedge_vw_i</span></code>), or the slab velocity <span class="math notranslate nohighlight">\(\vec{v}_s\)</span> (<code class="docutils literal notranslate"><span class="pre">slab_vs_i</span></code>), and similarly <span class="math notranslate nohighlight">\(p\)</span> can be the wedge pressure, <span class="math notranslate nohighlight">\(p_w\)</span> (<code class="docutils literal notranslate"><span class="pre">wedge_pw_i</span></code>), or the slab pressure <span class="math notranslate nohighlight">\(p_s\)</span> (<code class="docutils literal notranslate"><span class="pre">slab_ps_i</span></code>).  <span class="math notranslate nohighlight">\(\eta\)</span> is the non-dimensional viscosity.</p>
<p>Our goal is to discretize this system of equations using finite elements such that we have systems like</p>
<div class="amsmath math notranslate nohighlight" id="equation-d201b3b3-5d76-4d6d-82e3-624a06cad44c">
<span class="eqno">(6)<a class="headerlink" href="#equation-d201b3b3-5d76-4d6d-82e3-624a06cad44c" title="Permalink to this equation">#</a></span>\[\begin{align}
S_s u_s = S_s \left(\begin{array}{c}\vec{v}\\p\end{array}\right) = f_s
\end{align}\]</div>
<p>where <span class="math notranslate nohighlight">\(S_s = S_s(u_{s_t}, u_{s_a})\)</span> is a bilinear form of the combined velocity-pressure test <span class="math notranslate nohighlight">\(u_{s_t}\)</span> and trial <span class="math notranslate nohighlight">\(u_{s_a}\)</span> functions that will be used to assemble a left-hand side matrix and <span class="math notranslate nohighlight">\(f_s = f_s(u_{s_t})\)</span> is a linear form that will be used to describe a right-hand side vector in a matrix-vector equation for the velocity-pressure solution <span class="math notranslate nohighlight">\(u_s = \left(\vec{v}, p\right)^T\)</span>.</p>
<p>To get this form we multiply the Stokes equations through by the test function <span class="math notranslate nohighlight">\(u_t = \left(\vec{v}_{w_t}, p_{w_t}\right)^T\)</span>, integrate by parts, and apply appropriate boundary conditions to the resulting boundary integrals (in this case we can just drop them all).</p>
<p>Doing this in the wedge (using the subscript <span class="math notranslate nohighlight">\(w\)</span>) we get</p>
<div class="amsmath math notranslate nohighlight" id="equation-211caf59-b62b-48d3-a43e-9ce5976b982b">
<span class="eqno">(7)<a class="headerlink" href="#equation-211caf59-b62b-48d3-a43e-9ce5976b982b" title="Permalink to this equation">#</a></span>\[\begin{align}
S_{s_w} =&amp; K_{s_w} + G_{s_w} + D_{s_w} \\
f_{s_w} =&amp; \int_{\text{wedge}} u_{w_t} 0 dx
\end{align}\]</div>
<p>where</p>
<div class="amsmath math notranslate nohighlight" id="equation-27ae51c3-f1dd-4fb3-bdc4-e763affeb6ed">
<span class="eqno">(8)<a class="headerlink" href="#equation-27ae51c3-f1dd-4fb3-bdc4-e763affeb6ed" title="Permalink to this equation">#</a></span>\[\begin{align}
K_{s_w} =&amp;  \int_{\text{wedge}} \left[ \left(\frac{\nabla\vec{v}_{w_t} + \nabla\vec{v}_{w_t}^T}{2}\right):2\eta\left(\frac{\nabla\vec{v}_{w_a} + \nabla\vec{v}_{w_a}^T}{2}\right) \right] dx \\
G_{s_w} =&amp;  -  \int_{\text{wedge}} \nabla \cdot \vec{v}_{w_t} p_{w_a} dx \\
D_{s_w} =&amp; -  \int_{\text{wedge}}  p_{w_t} \nabla \cdot \vec{v}_{w_a} dx
\end{align}\]</div>
<p>and similarly in the slab (using the subscript <span class="math notranslate nohighlight">\(s\)</span>) we get</p>
<div class="amsmath math notranslate nohighlight" id="equation-fbb26706-0a28-4a65-bad2-f655d6ab7fd9">
<span class="eqno">(9)<a class="headerlink" href="#equation-fbb26706-0a28-4a65-bad2-f655d6ab7fd9" title="Permalink to this equation">#</a></span>\[\begin{align}
S_{s_s} =&amp; K_{s_s} + G_{s_s} + D_{s_s} \\
f_{s_s} =&amp; \int_{\text{slab}} u_{s_t} 0 dx
\end{align}\]</div>
<p>where</p>
<div class="amsmath math notranslate nohighlight" id="equation-0bcb80ad-044a-4282-90ac-578f6eb0209d">
<span class="eqno">(10)<a class="headerlink" href="#equation-0bcb80ad-044a-4282-90ac-578f6eb0209d" title="Permalink to this equation">#</a></span>\[\begin{align}
K_{s_s} =&amp;  \int_{\text{slab}} \left[ \left(\frac{\nabla\vec{v}_{s_t} + \nabla\vec{v}_{s_t}^T}{2}\right):2\eta\left(\frac{\nabla\vec{v}_{s_a} + \nabla\vec{v}_{s_a}^T}{2}\right) \right] dx \\
G_{s_s} =&amp;  -  \int_{\text{slab}} \nabla \cdot \vec{v}_{s_t} p_{s_a} dx \\
D_{s_s} =&amp; -  \int_{\text{slab}}  p_{s_t} \nabla \cdot \vec{v}_{s_a} dx
\end{align}\]</div>
<p>We can generalize these forms into the function <code class="docutils literal notranslate"><span class="pre">stokes_forms</span></code> and add it to our <code class="docutils literal notranslate"><span class="pre">SubductionProblem</span></code> class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">stokes_forms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vp_t</span><span class="p">,</span> <span class="n">vp_a</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the forms Ss and fs for the matrix problem Ss*us = fs for the Stokes problems</span>
<span class="sd">        given the test and trial functions and the mesh.</span>

<span class="sd">        Arguments:</span>
<span class="sd">          * vp_t - velocity-pressure test function</span>
<span class="sd">          * vp_a - velocity-pressure trial function</span>
<span class="sd">          * mesh - mesh</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">          * eta  - viscosity (defaults to 1 for isoviscous)</span>

<span class="sd">        Returns:</span>
<span class="sd">          * Ss - lhs bilinear form for the Stokes problem</span>
<span class="sd">          * fs - rhs linear form for the Stokes problem</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">v_t</span><span class="p">,</span> <span class="n">p_t</span><span class="p">)</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">vp_t</span><span class="p">)</span>
        <span class="p">(</span><span class="n">v_a</span><span class="p">,</span> <span class="n">p_a</span><span class="p">)</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">vp_a</span><span class="p">)</span>
        <span class="c1"># the stiffness block</span>
        <span class="n">Ks</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_t</span><span class="p">)),</span> <span class="mi">2</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_a</span><span class="p">)))</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="c1"># gradient of pressure</span>
        <span class="n">Gs</span> <span class="o">=</span> <span class="o">-</span><span class="n">ufl</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">v_t</span><span class="p">)</span><span class="o">*</span><span class="n">p_a</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="c1"># divergence of velcoity</span>
        <span class="n">Ds</span> <span class="o">=</span> <span class="o">-</span><span class="n">p_t</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">v_a</span><span class="p">)</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="c1"># combined matrix form</span>
        <span class="n">Ss</span> <span class="o">=</span> <span class="n">Ks</span> <span class="o">+</span> <span class="n">Gs</span> <span class="o">+</span> <span class="n">Ds</span>
        <span class="c1"># this problem has no rhs so create a dummy form by multiplying by a zero constant</span>
        <span class="n">zero_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">zero_c</span><span class="o">*</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">v_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_t</span><span class="p">)</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="c1"># return the forms</span>
        <span class="k">return</span> <span class="n">Ss</span><span class="p">,</span> <span class="n">fs</span>
</pre></div>
</div>
</div>
</div>
<p>We can write a similar function (<code class="docutils literal notranslate"><span class="pre">temperature_forms_steadystate</span></code>) for the temperature forms given the steady-state temperature advection-diffusion equation</p>
<div class="amsmath math notranslate nohighlight" id="equation-9ce1b544-0510-4877-a410-5e95813b9e28">
<span class="eqno">(11)<a class="headerlink" href="#equation-9ce1b544-0510-4877-a410-5e95813b9e28" title="Permalink to this equation">#</a></span>\[\begin{equation}
\rho c_p \vec{v} \cdot \nabla T = \nabla \cdot \left( k \nabla T \right) + H
\end{equation}\]</div>
<p>which we wish to convert into bilinear, <span class="math notranslate nohighlight">\(S_T = S_T(T_t, T_a)\)</span>, and linear, <span class="math notranslate nohighlight">\(f_T = f_T(T_t)\)</span>, forms, such that:</p>
<div class="amsmath math notranslate nohighlight" id="equation-16d1094c-0e39-4f26-89b8-d6e88dd2a5f3">
<span class="eqno">(12)<a class="headerlink" href="#equation-16d1094c-0e39-4f26-89b8-d6e88dd2a5f3" title="Permalink to this equation">#</a></span>\[\begin{equation}
S_T T = f_T
\end{equation}\]</div>
<p>Due to the variation of the material parameters and the velocity Functions across the domain, <span class="math notranslate nohighlight">\(S_s\)</span> is compiled from several integrals of different subregions of the domain</p>
<div class="amsmath math notranslate nohighlight" id="equation-919f7e6f-1019-440c-b508-9f7a95995606">
<span class="eqno">(13)<a class="headerlink" href="#equation-919f7e6f-1019-440c-b508-9f7a95995606" title="Permalink to this equation">#</a></span>\[\begin{align}
S_T =&amp; \int_{\text{wedge}} \left[ T_t \rho_m \vec{v}_w\cdot\nabla T_a + \nabla T_t \cdot k_m\nabla T_a \right] dx \\
&amp; + \int_{\text{slab}} \left[ T_t \rho_m \vec{v}_s\cdot\nabla T_a + \nabla T_t \cdot k_m\nabla T_a \right] dx \\
&amp; + \int_{\text{crust}} \left[ \nabla T_t \cdot k_c\nabla T_a \right] dx
\end{align}\]</div>
<p>Meanwhile <span class="math notranslate nohighlight">\(f_T\)</span> depends on whether the case has over-riding continental</p>
<div class="amsmath math notranslate nohighlight" id="equation-a2c7a7e8-69f2-4c52-8020-65c7fd4211ca">
<span class="eqno">(14)<a class="headerlink" href="#equation-a2c7a7e8-69f2-4c52-8020-65c7fd4211ca" title="Permalink to this equation">#</a></span>\[\begin{equation}
f_T = \int_{\text{upper crust}} T_t H_1 dx + \int_{\text{lower crust}} T_t H_2 dx
\end{equation}\]</div>
<p>or oceanic</p>
<div class="amsmath math notranslate nohighlight" id="equation-aab68155-e210-4583-9a6d-670740f40fcc">
<span class="eqno">(15)<a class="headerlink" href="#equation-aab68155-e210-4583-9a6d-670740f40fcc" title="Permalink to this equation">#</a></span>\[\begin{equation}
f_T = \int T_t 0 dx
\end{equation}\]</div>
<p>crust.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">temperature_forms_steadystate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the forms ST and fT for the matrix problem ST*T = fT for the steady-state </span>
<span class="sd">        temperature advection-diffusion problem.</span>

<span class="sd">        Returns:</span>
<span class="sd">          * ST - lhs bilinear form for the temperature problem</span>
<span class="sd">          * fT - rhs linear form for the temperature problem</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># integration measures that know about the cell and facet tags</span>

        <span class="c1"># advection diffusion in the slab</span>
        <span class="n">STs</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rhom</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs_i</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_a</span><span class="p">))</span> <span class="o">+</span> \
               <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_a</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">km</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="p">)))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_rids</span><span class="p">)</span>
        <span class="c1"># advection diffusion in the wedge</span>
        <span class="n">STw</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rhom</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cp</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vw_i</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_a</span><span class="p">))</span> <span class="o">+</span> \
               <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_a</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">km</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="p">)))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_rids</span><span class="p">)</span>
        <span class="c1"># just diffusion in the crust</span>
        <span class="n">STc</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_a</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kc</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crust_rids</span><span class="p">)</span>
        <span class="c1"># the complete bilinear form</span>
        <span class="n">ST</span>  <span class="o">=</span> <span class="n">STs</span> <span class="o">+</span> <span class="n">STw</span> <span class="o">+</span> <span class="n">STc</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sztype</span><span class="o">==</span><span class="s1">&#39;continental&#39;</span><span class="p">:</span>
            <span class="c1"># if the sztype is &#39;continental&#39; then put radiogenic heating in the rhs form</span>
            <span class="n">lc_rids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">geom</span><span class="o">.</span><span class="n">crustal_layers</span><span class="p">[</span><span class="s1">&#39;Crust&#39;</span><span class="p">][</span><span class="s1">&#39;rid&#39;</span><span class="p">]])</span>
            <span class="n">uc_rids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">geom</span><span class="o">.</span><span class="n">crustal_layers</span><span class="p">[</span><span class="s1">&#39;UpperCrust&#39;</span><span class="p">][</span><span class="s1">&#39;rid&#39;</span><span class="p">]])</span>
            <span class="n">fT</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">H1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="n">uc_rids</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">H2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="n">lc_rids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if the sztype is &#39;oceanic&#39; then create a zero rhs form</span>
            <span class="n">zero_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
            <span class="n">fT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_t</span><span class="o">*</span><span class="n">zero_c</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
        <span class="c1"># return the forms</span>
        <span class="k">return</span> <span class="n">ST</span><span class="p">,</span> <span class="n">fT</span>
</pre></div>
</div>
</div>
</div>
<p>In the isoviscous case, <span class="math notranslate nohighlight">\(\eta\)</span> = 1 (<code class="docutils literal notranslate"><span class="pre">eta</span> <span class="pre">=</span> <span class="pre">1</span></code>), so only the temperature depends on the velocity (and not vice-versa).  So to solve the full system of equations we only need to solve the two velocity-pressure systems once (in <code class="docutils literal notranslate"><span class="pre">solve_stokes_isoviscous</span></code>) before solving the temperature to get a fully converged solution for all variables (in <code class="docutils literal notranslate"><span class="pre">solve_steadystate_isoviscous</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">solve_stokes_isoviscous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">petsc_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the Stokes problems assuming an isoviscous rheology.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">          * petsc_options - a dictionary of petsc options to pass to the solver (defaults to mumps)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">petsc_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">petsc_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;preonly&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;lu&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_factor_mat_solver_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">}</span>

        <span class="c1"># retrive the Stokes forms for the wedge</span>
        <span class="n">Ssw</span><span class="p">,</span> <span class="n">fsw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_forms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_submesh</span><span class="p">)</span>
        <span class="n">problem_vpw</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">Ssw</span><span class="p">,</span> <span class="n">fsw</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span><span class="p">,</span> 
                                                 <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>
        
        <span class="c1"># retrive the Stokes forms for the slab</span>
        <span class="n">Sss</span><span class="p">,</span> <span class="n">fss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_forms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_submesh</span><span class="p">)</span>
        <span class="n">problem_vps</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">Sss</span><span class="p">,</span> <span class="n">fss</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs_vps</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span><span class="p">,</span>
                                                 <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>

        <span class="c1"># solve the Stokes problems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span> <span class="o">=</span> <span class="n">problem_vpw</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span> <span class="o">=</span> <span class="n">problem_vps</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

        <span class="c1"># interpolate the solutions to the whole mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_v_functions</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">solve_steadystate_isoviscous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">petsc_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the coupled temperature-velocity-pressure problem assuming an isoviscous rheology</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">          * petsc_options - a dictionary of petsc options to pass to the solver (defaults to mumps)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">petsc_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">petsc_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;preonly&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;lu&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_factor_mat_solver_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">}</span>

        <span class="c1"># first solve both Stokes systems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_stokes_isoviscous</span><span class="p">(</span><span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>

        <span class="c1"># retrieve the temperature forms</span>
        <span class="n">ST</span><span class="p">,</span> <span class="n">fT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_forms_steadystate</span><span class="p">()</span>
        <span class="n">problem_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">ST</span><span class="p">,</span> <span class="n">fT</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span>
                                               <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>
        <span class="c1"># and solve the temperature problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span> <span class="o">=</span> <span class="n">problem_T</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

        <span class="c1"># only update the pressure at the end as it is not necessary earlier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_p_functions</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>So now we have a full description of the isoviscous problem for benchmark case 1 but need some diagnostics to test it.</p>
<p>The benchmark focuses on dimensional metrics representing the averaged thermal and velocity structures near the coupling point
where gradients in velocity and temperature are high.</p>
<p>The first metric is
the slab temperature at 100 km depth, <span class="math notranslate nohighlight">\(T_{(200,-100)}^*\)</span></p>
<div class="amsmath math notranslate nohighlight" id="equation-3e24421a-b545-4fe2-aca7-d6b7abd6516d">
<span class="eqno">(16)<a class="headerlink" href="#equation-3e24421a-b545-4fe2-aca7-d6b7abd6516d" title="Permalink to this equation">#</a></span>\[\begin{equation}
    T_{(200,-100)}^* ~=~ T_0 T(x=200,y=-100)
\end{equation}\]</div>
<p>The second metric is the average integrated temperature <span class="math notranslate nohighlight">\(\overline{T}_s^*\)</span> along the slab surface between
depths <span class="math notranslate nohighlight">\(z_{s,1}\)</span>=70 and <span class="math notranslate nohighlight">\(z_{s,2}\)</span>=120, that is</p>
<div class="amsmath math notranslate nohighlight" id="equation-9a8d53ea-0d6b-4927-b26f-4c217bae60c5">
<span class="eqno">(17)<a class="headerlink" href="#equation-9a8d53ea-0d6b-4927-b26f-4c217bae60c5" title="Permalink to this equation">#</a></span>\[\begin{equation}
    \overline{T}_s^* ~=~ T_0 \frac{\int_{s_1}^{s_2} T ds}{\int_{s_1}^{s_2} ds}
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(s\)</span> is distance along the slab top from the trench,
<span class="math notranslate nohighlight">\(s_1\)</span>=<span class="math notranslate nohighlight">\(\sqrt{5z_{s,1}^2}\)</span>=156.5248 and <span class="math notranslate nohighlight">\(s_2\)</span>=<span class="math notranslate nohighlight">\(\sqrt{5z_{s,2}^2}\)</span>=268.32816.</p>
<p>The third metric is
the volume-averaged temperature <span class="math notranslate nohighlight">\(\overline{T}_w^*\)</span> in the mantle wedge corner below the Moho,
<span class="math notranslate nohighlight">\(z\)</span>=<span class="math notranslate nohighlight">\(z_2\)</span> and above where the slab surface, <span class="math notranslate nohighlight">\(z\)</span>=<span class="math notranslate nohighlight">\(z_\text{slab}(x)\)</span>,
is between
<span class="math notranslate nohighlight">\(z_{s,1}\)</span> and <span class="math notranslate nohighlight">\(z_{s,2}\)</span> as defined above</p>
<div class="amsmath math notranslate nohighlight" id="equation-8e0623e6-0bb4-459c-90ef-1757b7b11b43">
<span class="eqno">(18)<a class="headerlink" href="#equation-8e0623e6-0bb4-459c-90ef-1757b7b11b43" title="Permalink to this equation">#</a></span>\[\begin{equation}
    \overline{T}_w^* ~=~ T_0 \frac{\int_{x=140}^{x=240}\int_{z=z_2}^{z=z_\text{slab}(x)} \tilde{T} dz dx}{\int_{x=140}^{x=240}\int_{z=z_2}^{z=z_\text{slab}(x)} dz dx}
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(z_\text{slab}(x)\)</span>=<span class="math notranslate nohighlight">\(x/2\)</span>.</p>
<p>The final metric is the root-mean-squared averaged velocity <span class="math notranslate nohighlight">\(V_{\text{rms},w}^*\)</span> in the same volume as the third metric, that is</p>
<div class="amsmath math notranslate nohighlight" id="equation-ab5f2e33-99e1-4d70-a7d7-52e2e3522da0">
<span class="eqno">(19)<a class="headerlink" href="#equation-ab5f2e33-99e1-4d70-a7d7-52e2e3522da0" title="Permalink to this equation">#</a></span>\[\begin{equation}
    V_{\text{rms},w}^*~=~ v_0 
    \sqrt{ 
     \frac {\int_{x=140}^{x=240}\int_{z=z_2}^{z=z_\text{slab}} \left( \tilde{\vec{v}}\cdot\tilde{\vec{v}} \right) dzdx}
            {\int_{x=140}^{x=240}\int_{z=z_2}^{z=z_\text{slab}(x)} dz dx}
    }.
\end{equation}\]</div>
<p>These are all functional forms that return a single scalar and can be easily represented using UFL, just like we did the equations.  We do that in the function <code class="docutils literal notranslate"><span class="pre">get_diagnostics</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the benchmark diagnostics.</span>

<span class="sd">        Returns:</span>
<span class="sd">          * Tpt       - spot temperature on the slab at 100 km depth</span>
<span class="sd">          * Tslab     - average temperature along the diagnostic region of the slab surface</span>
<span class="sd">          * Twedge    - average temperature in the diagnostic region of the wedge</span>
<span class="sd">          * vrmswedge - average rms velocity in the diagnostic region of the wedge</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># work out location of spot tempeterature on slab and evaluate T</span>
        <span class="n">xpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">intersecty</span><span class="p">(</span><span class="o">-</span><span class="mf">100.0</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="mf">0.0</span><span class="p">])</span>
        <span class="n">Tpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">xpt</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_first_cells</span><span class="p">(</span><span class="n">xpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T_(200,-100) = </span><span class="si">{:.2f}</span><span class="s2"> deg C&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Tpt</span><span class="p">,))</span>

        <span class="c1"># a unit constant to evaluate slab length and wedge area</span>
        <span class="n">one_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>

        <span class="c1"># evaluate average T along diagnostic section of slab</span>
        <span class="n">slab_diag_sids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wedge_dividers</span><span class="p">[</span><span class="s1">&#39;WedgeFocused&#39;</span><span class="p">][</span><span class="s1">&#39;slab_sid&#39;</span><span class="p">]])</span>
        <span class="n">Tslab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T0</span><span class="o">*</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dS</span><span class="p">(</span><span class="n">slab_diag_sids</span><span class="p">)))</span>\
                        <span class="o">/</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">one_c</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dS</span><span class="p">(</span><span class="n">slab_diag_sids</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T_slab = </span><span class="si">{:.2f}</span><span class="s2"> deg C&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Tslab</span><span class="p">,))</span>
        
        <span class="n">wedge_diag_rids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wedge_dividers</span><span class="p">[</span><span class="s1">&#39;WedgeFocused&#39;</span><span class="p">][</span><span class="s1">&#39;rid&#39;</span><span class="p">]])</span>
        <span class="n">wedge_diag_area</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">one_c</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="n">wedge_diag_rids</span><span class="p">)))</span>

        <span class="c1"># evaluate average T in wedge diagnostic region</span>
        <span class="n">Twedge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T0</span><span class="o">*</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="n">wedge_diag_rids</span><span class="p">)))</span>\
                         <span class="o">/</span><span class="n">wedge_diag_area</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T_wedge = </span><span class="si">{:.2f}</span><span class="s2"> deg C&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Twedge</span><span class="p">,))</span>

        <span class="c1"># evaluate average vrms in wedge diagnostic region</span>
        <span class="n">vrmswedge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vw_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vw_i</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="n">wedge_diag_rids</span><span class="p">)))</span>\
                            <span class="o">/</span><span class="n">wedge_diag_area</span><span class="p">)</span><span class="o">*</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;V_rms,w = </span><span class="si">{:.2f}</span><span class="s2"> mm/yr&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vrmswedge</span><span class="p">,))</span>

        <span class="c1"># return results</span>
        <span class="k">return</span> <span class="n">Tpt</span><span class="p">,</span> <span class="n">Tslab</span><span class="p">,</span> <span class="n">Twedge</span><span class="p">,</span> <span class="n">vrmswedge</span>
</pre></div>
</div>
</div>
</div>
<p>Because we have added functions to the class we need to re-instantiate it, which unfortunately means a lot of output again during mesh generation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sz</span> <span class="o">=</span> <span class="n">SubductionProblem</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">Vs</span><span class="o">=</span><span class="n">Vs</span><span class="p">,</span> <span class="n">sztype</span><span class="o">=</span><span class="n">sztype</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning : Gmsh has aleady been initialized
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Info    : Meshing 1D...
Info    : [  0%] Meshing curve 1 (Line)
Info    : [ 10%] Meshing curve 2 (Line)
Info    : [ 10%] Meshing curve 3 (Line)
Info    : [ 10%] Meshing curve 4 (Line)
Info    : [ 10%] Meshing curve 5 (Line)
Info    : [ 10%] Meshing curve 6 (Line)
Info    : [ 10%] Meshing curve 7 (Line)
Info    : [ 10%] Meshing curve 8 (Line)
Info    : [ 10%] Meshing curve 9 (Line)
Info    : [ 10%] Meshing curve 10 (Line)
Info    : [ 20%] Meshing curve 11 (Line)
Info    : [ 20%] Meshing curve 12 (Line)
Info    : [ 20%] Meshing curve 13 (Line)
Info    : [ 20%] Meshing curve 14 (Line)
Info    : [ 20%] Meshing curve 15 (Line)
Info    : [ 20%] Meshing curve 16 (Line)
Info    : [ 20%] Meshing curve 17 (Line)
Info    : [ 20%] Meshing curve 18 (Line)
Info    : [ 20%] Meshing curve 19 (Line)
Info    : [ 30%] Meshing curve 20 (Line)
Info    : [ 30%] Meshing curve 21 (Line)
Info    : [ 30%] Meshing curve 22 (Line)
Info    : [ 30%] Meshing curve 23 (Line)
Info    : [ 30%] Meshing curve 24 (Line)
Info    : [ 30%] Meshing curve 25 (Line)
Info    : [ 30%] Meshing curve 27 (Line)
Info    : [ 30%] Meshing curve 28 (Line)
Info    : [ 30%] Meshing curve 29 (Line)
Info    : [ 40%] Meshing curve 30 (Line)
Info    : [ 40%] Meshing curve 31 (Line)
Info    : [ 40%] Meshing curve 32 (Line)
Info    : [ 40%] Meshing curve 33 (Line)
Info    : [ 40%] Meshing curve 34 (Line)
Info    : [ 40%] Meshing curve 35 (Line)
Info    : [ 40%] Meshing curve 36 (Line)
Info    : [ 40%] Meshing curve 37 (Line)
Info    : [ 40%] Meshing curve 38 (Line)
Info    : [ 50%] Meshing curve 39 (Line)
Info    : [ 50%] Meshing curve 40 (Line)
Info    : [ 50%] Meshing curve 41 (Line)
Info    : [ 50%] Meshing curve 42 (Line)
Info    : [ 50%] Meshing curve 43 (Line)
Info    : [ 50%] Meshing curve 44 (Line)
Info    : [ 50%] Meshing curve 45 (Line)
Info    : [ 50%] Meshing curve 46 (Line)
Info    : [ 50%] Meshing curve 47 (Line)
Info    : [ 60%] Meshing curve 48 (Line)
Info    : [ 60%] Meshing curve 49 (Line)
Info    : [ 60%] Meshing curve 50 (Line)
Info    : [ 60%] Meshing curve 51 (Line)
Info    : [ 60%] Meshing curve 52 (Line)
Info    : [ 60%] Meshing curve 54 (Line)
Info    : [ 60%] Meshing curve 55 (Line)
Info    : [ 60%] Meshing curve 56 (Line)
Info    : [ 60%] Meshing curve 57 (Line)
Info    : [ 70%] Meshing curve 58 (Line)
Info    : [ 70%] Meshing curve 59 (Line)
Info    : [ 70%] Meshing curve 60 (Line)
Info    : [ 70%] Meshing curve 61 (Line)
Info    : [ 70%] Meshing curve 62 (Line)
Info    : [ 70%] Meshing curve 63 (Line)
Info    : [ 70%] Meshing curve 64 (Line)
Info    : [ 70%] Meshing curve 65 (Line)
Info    : [ 70%] Meshing curve 66 (Line)
Info    : [ 80%] Meshing curve 67 (Line)
Info    : [ 80%] Meshing curve 68 (Line)
Info    : [ 80%] Meshing curve 70 (Line)
Info    : [ 80%] Meshing curve 71 (Line)
Info    : [ 80%] Meshing curve 72 (Line)
Info    : [ 80%] Meshing curve 73 (Line)
Info    : [ 80%] Meshing curve 74 (Line)
Info    : [ 80%] Meshing curve 75 (Line)
Info    : [ 80%] Meshing curve 76 (Line)
Info    : [ 90%] Meshing curve 77 (Line)
Info    : [ 90%] Meshing curve 78 (Line)
Info    : [ 90%] Meshing curve 79 (Line)
Info    : [ 90%] Meshing curve 80 (Line)
Info    : [ 90%] Meshing curve 81 (Line)
Info    : [ 90%] Meshing curve 82 (Line)
Info    : [ 90%] Meshing curve 83 (Line)
Info    : [ 90%] Meshing curve 85 (Line)
Info    : [ 90%] Meshing curve 86 (Line)
Info    : [100%] Meshing curve 87 (Line)
Info    : [100%] Meshing curve 88 (Line)
Info    : [100%] Meshing curve 89 (Line)
Info    : [100%] Meshing curve 90 (Line)
Info    : [100%] Meshing curve 91 (Line)
Info    : [100%] Meshing curve 92 (Line)
Info    : [100%] Meshing curve 93 (Line)
Info    : [100%] Meshing curve 95 (Line)
Info    : [100%] Meshing curve 96 (Line)
Info    : Done meshing 1D (Wall 0.0161791s, CPU 0.016843s)
Info    : Meshing 2D...
Info    : [  0%] Meshing surface 1 (Plane, Frontal-Delaunay)
Info    : [ 20%] Meshing surface 2 (Plane, Frontal-Delaunay)
Info    : [ 40%] Meshing surface 3 (Plane, Frontal-Delaunay)
Info    : [ 50%] Meshing surface 4 (Plane, Frontal-Delaunay)
Info    : [ 70%] Meshing surface 5 (Plane, Frontal-Delaunay)
Info    : [ 90%] Meshing surface 6 (Plane, Frontal-Delaunay)
Info    : Done meshing 2D (Wall 0.0457516s, CPU 0.046359s)
Info    : 1474 nodes 3239 elements
</pre></div>
</div>
</div>
</div>
<p>But now we can solve the isoviscous problem.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sz</span><span class="o">.</span><span class="n">solve_steadystate_isoviscous</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>And get the diagnostic output to compare against the benchmark.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diag</span> <span class="o">=</span> <span class="n">sz</span><span class="o">.</span><span class="n">get_diagnostics</span><span class="p">()</span>
<span class="n">T_ndof</span> <span class="o">=</span> <span class="n">sz</span><span class="o">.</span><span class="n">V_T</span><span class="o">.</span><span class="n">dofmap</span><span class="o">.</span><span class="n">index_map</span><span class="o">.</span><span class="n">size_global</span> <span class="o">*</span> <span class="n">sz</span><span class="o">.</span><span class="n">V_T</span><span class="o">.</span><span class="n">dofmap</span><span class="o">.</span><span class="n">index_map_bs</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;12}</span><span class="s1"> </span><span class="si">{:&lt;12}</span><span class="s1"> </span><span class="si">{:&lt;12}</span><span class="s1"> </span><span class="si">{:&lt;12}</span><span class="s1"> </span><span class="si">{:&lt;12}</span><span class="s1"> </span><span class="si">{:&lt;12}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;resscale&#39;</span><span class="p">,</span> <span class="s1">&#39;T_ndof&#39;</span><span class="p">,</span> <span class="s1">&#39;T_{200,-100}&#39;</span><span class="p">,</span> <span class="s1">&#39;Tbar_s&#39;</span><span class="p">,</span> <span class="s1">&#39;Tbar_w&#39;</span><span class="p">,</span> <span class="s1">&#39;Vrmsw&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;12.4g}</span><span class="s1"> </span><span class="si">{:&lt;12d}</span><span class="s1"> </span><span class="si">{:&lt;12.4f}</span><span class="s1"> </span><span class="si">{:&lt;12.4f}</span><span class="s1"> </span><span class="si">{:&lt;12.4f}</span><span class="s1"> </span><span class="si">{:&lt;12.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resscale</span><span class="p">,</span> <span class="n">T_ndof</span><span class="p">,</span> <span class="n">diag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">diag</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">diag</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">diag</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>T_(200,-100) = 517.17 deg C
T_slab = 451.95 deg C
T_wedge = 927.02 deg C
V_rms,w = 34.64 mm/yr

resscale     T_ndof       T_{200,-100} Tbar_s       Tbar_w       Vrmsw       
5            5812         517.1668     451.9452     927.0205     34.6379     
</pre></div>
</div>
</div>
</div>
<p>For comparison here are the values reported for case 1 using <a class="reference external" href="https://terraferma.github.io">TerraFERMA</a> in <a class="reference external" href="http://dx.doi.org/10.1186/s40645-023-00588-6">Wilson &amp; van Keken, 2023</a>:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">resscale</span></code></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(T_{\text{ndof}} \)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(T_{(200,-100)}^*\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(\overline{T}_s^*\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\( \overline{T}_w^* \)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(V_{\text{rms},w}^*\)</span></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2.0</p></td>
<td><p>21403</p></td>
<td><p>517.17</p></td>
<td><p>451.83</p></td>
<td><p>926.62</p></td>
<td><p>34.64</p></td>
</tr>
<tr class="row-odd"><td><p>1.0</p></td>
<td><p>83935</p></td>
<td><p>516.95</p></td>
<td><p>451.71</p></td>
<td><p>926.33</p></td>
<td><p>34.64</p></td>
</tr>
<tr class="row-even"><td><p>0.5</p></td>
<td><p>332307</p></td>
<td><p>516.86</p></td>
<td><p>451.63</p></td>
<td><p>926.15</p></td>
<td><p>34.64</p></td>
</tr>
</tbody>
</table>
</div>
<p>We can also plot the temperature and velocity solutions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utils</span><span class="o">.</span><span class="n">plot_scalar</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sz</span><span class="o">.</span><span class="n">T0</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_vector</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">vw_i</span><span class="p">,</span> <span class="n">glyph_factor</span><span class="o">=</span><span class="mi">6</span><span class="o">/</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">))</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_vector</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">vs_i</span><span class="p">,</span> <span class="n">glyph_factor</span><span class="o">=</span><span class="mi">6</span><span class="o">/</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">mps_to_mmpyr</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">v0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7f6070876bd542ef72ce67d49d738591fab84b5c062d3a8784fee5251cd1be03.png" src="../_images/7f6070876bd542ef72ce67d49d738591fab84b5c062d3a8784fee5251cd1be03.png" />
<img alt="../_images/1fc6df4c30ba325d74a68bc5d4d863a9b0286e7c6de8bcbd4ea7cf88cc1f87bd.png" src="../_images/1fc6df4c30ba325d74a68bc5d4d863a9b0286e7c6de8bcbd4ea7cf88cc1f87bd.png" />
<img alt="../_images/5d0764f917939160fa6885dce3f6f74850c69a0b84871d2ba51898bdac30c8f4.png" src="../_images/5d0764f917939160fa6885dce3f6f74850c69a0b84871d2ba51898bdac30c8f4.png" />
</div>
</div>
<p>The output can also be saved to disk and opened with other visualization software (e.g. <a class="reference external" href="https://www.paraview.org/">Paraview</a> using code like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output_folder</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>
<span class="n">output_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">output_folder</span> <span class="o">/</span> <span class="s2">&quot;&lt;file base name&gt;&quot;</span>
<span class="k">with</span> <span class="n">df</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VTXWriter</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="n">filename</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.bp&quot;</span><span class="p">),</span> <span class="p">[</span><span class="n">sz</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span> <span class="n">sz</span><span class="o">.</span><span class="n">vs_i</span><span class="p">,</span> <span class="n">sz</span><span class="o">.</span><span class="n">vw_i</span><span class="p">])</span> <span class="k">as</span> <span class="n">vtx</span><span class="p">:</span>
    <span class="n">vtx</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;file</span> <span class="pre">base</span> <span class="pre">name&gt;</span></code> needs to be replaced with a suitable filename.</p>
<p>It’s also common to want to interogate the temperature at various points in the domain or along the slab.  Here we provide an example function for doing that that plots the slab temperature along the slab surface and along the slab Moho at 7km depth (into the slab).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_slab_temperatures</span><span class="p">(</span><span class="n">sz</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the slab surface and Moho (7 km slab depth)</span>

<span class="sd">    Arguments:</span>
<span class="sd">      * sz - a solved SubductionProblem instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get some points along the slab</span>
    <span class="n">slabpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span> <span class="k">for</span> <span class="n">curve</span> <span class="ow">in</span> <span class="n">sz</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="o">.</span><span class="n">interpcurves</span><span class="p">])</span>
    <span class="c1"># do the same along a spline deeper in the slab</span>
    <span class="n">slabmoho</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">slab_spline</span><span class="p">)</span>
    <span class="n">slabmoho</span><span class="o">.</span><span class="n">translatenormalandcrop</span><span class="p">(</span><span class="o">-</span><span class="mf">7.0</span><span class="p">)</span>
    <span class="n">slabmohopoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span> <span class="k">for</span> <span class="n">curve</span> <span class="ow">in</span> <span class="n">slabmoho</span><span class="o">.</span><span class="n">interpcurves</span><span class="p">])</span>
    <span class="c1"># set up a figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="c1"># plot the slab temperatures</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">T_i</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">slabpoints</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_first_cells</span><span class="p">(</span><span class="n">slabpoints</span><span class="p">,</span> <span class="n">sz</span><span class="o">.</span><span class="n">mesh</span><span class="p">))[:,</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">slabpoints</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;slab surface&#39;</span><span class="p">)</span>
    <span class="c1"># plot the moho temperatures</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">T_i</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">slabmohopoints</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_first_cells</span><span class="p">(</span><span class="n">slabmohopoints</span><span class="p">,</span> <span class="n">sz</span><span class="o">.</span><span class="n">mesh</span><span class="p">))[:,</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">slabmohopoints</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;slab moho&#39;</span><span class="p">)</span>
    <span class="c1"># labels, title etc.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;T ($^\circ$C)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;z (km)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Slab surface and Moho temperatures&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_slab_temperatures</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9ac32bf40fb60250686f5a78c1cfed9288bde641b4fecb9578fa428d54334e53.png" src="../_images/9ac32bf40fb60250686f5a78c1cfed9288bde641b4fecb9578fa428d54334e53.png" />
</div>
</div>
</section>
<section id="dislocation-creep-viscosity-case-2">
<h4>Dislocation Creep Viscosity (Case 2)<a class="headerlink" href="#dislocation-creep-viscosity-case-2" title="Link to this heading">#</a></h4>
<p>For case 2 the viscosity is a function of temperature and
strain rate following a simplified creep law for dislocation creep in dry olivine from <a class="reference external" href="http://dx.doi.org/10.1126/science.260.5109.771">Karato &amp; Wu, 1993</a></p>
<div class="amsmath math notranslate nohighlight" id="equation-4c8503fc-562a-48ec-80cc-4d14c9765776">
<span class="eqno">(20)<a class="headerlink" href="#equation-4c8503fc-562a-48ec-80cc-4d14c9765776" title="Permalink to this equation">#</a></span>\[\begin{equation}
\eta^*_\text{disl}~=~ A_\eta^* \exp \left( \frac{E^*}{n_\sigma R^*(T^*+T^*_a)} \right) {{\dot{\epsilon}_{II}}}^{*\frac{1-n_\sigma}{n_\sigma}}
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(A_\eta^*\)</span> is a prefactor, <span class="math notranslate nohighlight">\(E^*\)</span> is the activation energy, <span class="math notranslate nohighlight">\(R^*\)</span> is the gas constant, <span class="math notranslate nohighlight">\(n\)</span> is a powerlaw index,
<span class="math notranslate nohighlight">\(T^*_a\)</span>
a linear approximation of an adiabatic temperature
using a gradient of 0.3<span class="math notranslate nohighlight">\(^\circ\)</span>C/km with <span class="math notranslate nohighlight">\(T^*_a\)</span>=0 at the top of the model (beyond the benchmark this may not be at <span class="math notranslate nohighlight">\(z^*\)</span>=0 due to assumptions of ocean bathymetry)
and <span class="math notranslate nohighlight">\(\dot{\epsilon}_{II}^*\)</span> is the second invariant of the
deviatoric strain-rate tensor (also known as the effective deviatoric strain rate)</p>
<div class="amsmath math notranslate nohighlight" id="equation-38862008-e52e-4616-ab86-fd12a3af6e5e">
<span class="eqno">(21)<a class="headerlink" href="#equation-38862008-e52e-4616-ab86-fd12a3af6e5e" title="Permalink to this equation">#</a></span>\[\begin{equation}
\dot{\epsilon}_{II}^*~=~ \sqrt{\frac{1}{2} \frac{\nabla\vec{v}^* + \nabla\vec{v}^{*T}}{2}:\frac{\nabla\vec{v}^* + \nabla\vec{v}^{*T}}{2}}
\end{equation}\]</div>
<p>and depends on whether we are in the wedge, where <span class="math notranslate nohighlight">\(\vec{v}^* = \vec{v}_w^*\)</span> is the dimensional wedge velocity, or in the slab, where <span class="math notranslate nohighlight">\(\vec{v}^* = \vec{v}_s^*\)</span> is the dimensional slab velocity.</p>
<p>Since the dynamical range of the viscosity is large over the temperature contrast across
subduction zones the viscosity is capped at some arbitrary maximum <span class="math notranslate nohighlight">\(\eta^*_\text{max}\)</span> so that in the variable viscosity case</p>
<div class="amsmath math notranslate nohighlight" id="equation-fe175421-f838-4163-a879-f9d537ae7a79">
<span class="eqno">(22)<a class="headerlink" href="#equation-fe175421-f838-4163-a879-f9d537ae7a79" title="Permalink to this equation">#</a></span>\[\begin{equation}
\eta~=~ \left( \frac{\eta_0}{\eta^*_\text{disl}} ~+~ \frac{\eta_0}{\eta^*_\text{max}}\right)^{-1}
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(\eta_0\)</span> is a reference viscosity scale used to non-dimensionalize the viscosity.</p>
<p>We describe this viscosity law in the function <code class="docutils literal notranslate"><span class="pre">etadisl</span></code> and allow it to be examined by projecting its values to a finite element Function in <code class="docutils literal notranslate"><span class="pre">project_dislocationcreep_viscosity</span></code> below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">etadisl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v_i</span><span class="p">,</span> <span class="n">T_i</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dislocation creep viscosity given a velocity and temperature</span>

<span class="sd">        Arguments:</span>
<span class="sd">          * v_i - velocity Function</span>
<span class="sd">          * T_i - temperature Function</span>

<span class="sd">        Returns:</span>
<span class="sd">          * eta - viscosity ufl description</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># get the mesh</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">v_i</span><span class="o">.</span><span class="n">function_space</span><span class="o">.</span><span class="n">mesh</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">SpatialCoordinate</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">zero_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="n">deltaztrench_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="p">))</span>
        <span class="n">deltazsurface</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">operators</span><span class="o">.</span><span class="n">MinValue</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">operators</span><span class="o">.</span><span class="n">MaxValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaztrench</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deltaxcoast</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)),</span> <span class="n">zero_c</span><span class="p">),</span> <span class="n">deltaztrench_c</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">deltazsurface</span><span class="p">)</span>
        
        <span class="c1"># dimensional temperature in Kelvin with an adiabat added</span>
        <span class="n">Tdim</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">nondim_to_K</span><span class="p">(</span><span class="n">T_i</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">z</span>

        <span class="c1"># we declare some of the coefficients as dolfinx Constants to prevent the form compiler from</span>
        <span class="c1"># optimizing them out of the code due to their small (dimensional) values</span>
        <span class="n">E_c</span>          <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">))</span>
        <span class="n">invetamax_c</span>  <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eta0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">etamax</span><span class="p">))</span>
        <span class="n">neII</span>         <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsigma</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nsigma</span>
        <span class="n">invetafact_c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eta0</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e0</span><span class="o">**</span><span class="n">neII</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Aeta</span><span class="p">))</span>
        <span class="n">neII_c</span>       <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="n">neII</span><span class="p">))</span>
    
        <span class="c1"># strain rate</span>
        <span class="n">edot</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_i</span><span class="p">))</span>
        <span class="n">eII</span>  <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">edot</span><span class="p">,</span> <span class="n">edot</span><span class="p">))</span>
        <span class="c1"># inverse dimensionless dislocation creep viscosity</span>
        <span class="n">invetadisl</span> <span class="o">=</span> <span class="n">invetafact_c</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">E_c</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsigma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="n">Tdim</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">eII</span><span class="o">**</span><span class="n">neII_c</span><span class="p">)</span>
        <span class="c1"># inverse dimensionless effective viscosity</span>
        <span class="n">inveta</span> <span class="o">=</span> <span class="n">invetadisl</span> <span class="o">+</span> <span class="n">invetamax_c</span>
        <span class="c1"># &quot;harmonic mean&quot; viscosity (actually twice the harmonic mean)</span>
        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="n">inveta</span>

    <span class="k">def</span> <span class="nf">project_dislocationcreep_viscosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_eta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">petsc_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Project the dislocation creep viscosity to the mesh.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">          * peta          - finite element degree of viscosity Function (defaults to 0)</span>
<span class="sd">          * petsc_options - a dictionary of petsc options to pass to the solver (defaults to mumps)</span>

<span class="sd">        Returns:</span>
<span class="sd">          * eta_i - the viscosity Function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">petsc_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">petsc_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;preonly&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;lu&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_factor_mat_solver_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">}</span>
        <span class="c1"># set up the functionspace</span>
        <span class="n">V_eta</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="n">p_eta</span><span class="p">))</span>
        <span class="c1"># declare the domain wide Function</span>
        <span class="n">eta_i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">V_eta</span><span class="p">)</span>
        <span class="c1"># set it to etamax everywhere (will get overwritten)</span>
        <span class="n">eta_i</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etamax</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">eta0</span>
        
        <span class="k">def</span> <span class="nf">solve_viscosity</span><span class="p">(</span><span class="n">v_i</span><span class="p">,</span> <span class="n">T_i</span><span class="p">,</span> <span class="n">cell_map</span><span class="p">,</span> <span class="n">reverse_cell_map</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Solve for the viscosity in subdomains and interpolate it to the parent Function</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">T_i</span><span class="o">.</span><span class="n">function_space</span><span class="o">.</span><span class="n">mesh</span>
            <span class="n">Vwedge_eta</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="n">p_eta</span><span class="p">))</span>
            <span class="n">eta_a</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">Vwedge_eta</span><span class="p">)</span>
            <span class="n">eta_t</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">Vwedge_eta</span><span class="p">)</span>
            <span class="n">Seta</span> <span class="o">=</span> <span class="n">eta_t</span><span class="o">*</span><span class="n">eta_a</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
            <span class="n">feta</span> <span class="o">=</span> <span class="n">eta_t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">etadisl</span><span class="p">(</span><span class="n">v_i</span><span class="p">,</span> <span class="n">T_i</span><span class="p">)</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
            <span class="n">problem</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">Seta</span><span class="p">,</span> <span class="n">feta</span><span class="p">,</span> <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>
            <span class="n">leta_i</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="n">eta_i</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">leta_i</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="n">cell_map</span><span class="p">,</span> <span class="n">cell_map</span><span class="o">=</span><span class="n">reverse_cell_map</span><span class="p">)</span>

        <span class="c1"># solve in the wedge</span>
        <span class="n">solve_viscosity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vw_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_T_i</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">wedge_cell_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_reverse_cell_map</span><span class="p">)</span>
        <span class="c1"># solve in the slab</span>
        <span class="n">solve_viscosity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vs_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_T_i</span><span class="p">,</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">slab_cell_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_reverse_cell_map</span><span class="p">)</span>

        <span class="c1"># return the viscosity</span>
        <span class="k">return</span> <span class="n">eta_i</span>
    
</pre></div>
</div>
</div>
</div>
<p>Solving for the thermal state of the subduction zone is more complicated when using a dislocation creep viscosity than in the isoviscous rheology case due to the non-linearities introduced by having the viscosity depend on both temperature and velocity (through the strain rate).  These mean that we must iterate between the velocity and temperature solutions until a (hopefully) converged solution is achieved.  Due to the split nature of our submeshes we do this using a so-called Picard or fixed-point iteration.  These iterations are not guaranteed to converge but stand a much better chance with a good initial guess, so we start by solving the isoviscous problem again.</p>
<p>Given this initial guess, we test for convergence by calculating the residual of each subproblem and ensuring that their norm is small either in a relative (to the initial residual, <code class="docutils literal notranslate"><span class="pre">rtol</span></code>) or absolute (<code class="docutils literal notranslate"><span class="pre">atol</span></code>) sense.  To prevent a runaway non-converging computation we place a maximum cap on the number of iterations (<code class="docutils literal notranslate"><span class="pre">maxits</span></code>).  This iteration can take some time, particularly at high resolutions (low <code class="docutils literal notranslate"><span class="pre">resscale</span></code>s).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SubductionProblem</span><span class="p">(</span><span class="n">SubductionProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">solve_steadystate_dislocationcreep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">5.e-6</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">5.e-9</span><span class="p">,</span> <span class="n">maxits</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                                           <span class="n">petsc_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the Stokes problems assuming a dislocation creep rheology.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">          * rtol          - nonlinear iteration relative tolerance</span>
<span class="sd">          * atol          - nonlinear iteration absolute tolerance</span>
<span class="sd">          * maxits        - maximum number of nonlinear iterations</span>
<span class="sd">          * petsc_options - a dictionary of petsc options to pass to the solver (defaults to mumps)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">petsc_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">petsc_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;preonly&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;lu&quot;</span><span class="p">,</span> 
                           <span class="s2">&quot;pc_factor_mat_solver_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;mumps&quot;</span><span class="p">}</span>
            
        <span class="c1"># first solve the isoviscous problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_stokes_isoviscous</span><span class="p">(</span><span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>

        <span class="c1"># retrieve the temperature forms</span>
        <span class="n">ST</span><span class="p">,</span> <span class="n">fT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_forms_steadystate</span><span class="p">()</span>
        <span class="n">problem_T</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">ST</span><span class="p">,</span> <span class="n">fT</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="p">,</span>
                                               <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>
        <span class="c1"># and solve the temperature problem, given the isoviscous Stokes solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span> <span class="o">=</span> <span class="n">problem_T</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_T_functions</span><span class="p">()</span>
        
        <span class="c1"># retrive the non-linear Stokes forms for the wedge</span>
        <span class="n">Ssw</span><span class="p">,</span> <span class="n">fsw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_forms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_a</span><span class="p">,</span> \
                                     <span class="bp">self</span><span class="o">.</span><span class="n">wedge_submesh</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">etadisl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vw_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_T_i</span><span class="p">))</span>
        <span class="n">problem_vpw</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">Ssw</span><span class="p">,</span> <span class="n">fsw</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span><span class="p">,</span> 
                                                 <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>

        <span class="c1"># retrive the non-linear Stokes forms for the slab</span>
        <span class="n">Sss</span><span class="p">,</span> <span class="n">fss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_forms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_a</span><span class="p">,</span> \
                                     <span class="bp">self</span><span class="o">.</span><span class="n">slab_submesh</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">etadisl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vs_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_T_i</span><span class="p">))</span>
        <span class="n">problem_vps</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">Sss</span><span class="p">,</span> <span class="n">fss</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bcs_vps</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span><span class="p">,</span>
                                                 <span class="n">petsc_options</span><span class="o">=</span><span class="n">petsc_options</span><span class="p">)</span>

        <span class="c1"># define the non-linear residual for the wedge velocity-pressure</span>
        <span class="n">rw</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">Ssw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span><span class="p">)</span> <span class="o">-</span> <span class="n">fsw</span>
        <span class="c1"># define the non-linear residual for the slab velocity-pressure</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">Sss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span><span class="p">)</span> <span class="o">-</span> <span class="n">fss</span>
        <span class="c1"># define the non-linear residual for the temperature</span>
        <span class="n">rT</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">ST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span><span class="p">)</span> <span class="o">-</span> <span class="n">fT</span>

        <span class="k">def</span> <span class="nf">calculate_residual</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Return the total residual of the problem</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">rw_vec</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_vector</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">rw</span><span class="p">))</span>
            <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">set_bc</span><span class="p">(</span><span class="n">rw_vec</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vpw</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">rs_vec</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_vector</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span>
            <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">set_bc</span><span class="p">(</span><span class="n">rs_vec</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs_vps</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">rT_vec</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_vector</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">rT</span><span class="p">))</span>
            <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">set_bc</span><span class="p">(</span><span class="n">rT_vec</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcs_T</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rw_vec</span><span class="o">.</span><span class="n">petsc_vec</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
                        <span class="n">rs_vec</span><span class="o">.</span><span class="n">petsc_vec</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> \
                        <span class="n">rT_vec</span><span class="o">.</span><span class="n">petsc_vec</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="c1"># calculate the initial residual</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">calculate_residual</span><span class="p">()</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">rrel</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">r0</span>  <span class="c1"># 1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;11}</span><span class="s2"> </span><span class="si">{:&lt;12}</span><span class="s2"> </span><span class="si">{:&lt;17}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">,</span><span class="s1">&#39;Residual&#39;</span><span class="p">,</span><span class="s1">&#39;Relative Residual&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">42</span><span class="p">)</span>

        <span class="c1"># iterate until the residual converges (hopefully)</span>
        <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;11}</span><span class="s2"> </span><span class="si">{:&lt;12.6g}</span><span class="s2"> </span><span class="si">{:&lt;12.6g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rrel</span><span class="p">,))</span>
        <span class="k">while</span> <span class="n">rrel</span> <span class="o">&gt;</span> <span class="n">rtol</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">atol</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;</span> <span class="n">maxits</span><span class="p">:</span> <span class="k">break</span>
            <span class="c1"># solve for v &amp; p and interpolate it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wedge_vpw_i</span> <span class="o">=</span> <span class="n">problem_vpw</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slab_vps_i</span>  <span class="o">=</span> <span class="n">problem_vps</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_v_functions</span><span class="p">()</span>
            <span class="c1"># solve for T and interpolate it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T_i</span> <span class="o">=</span> <span class="n">problem_T</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_T_functions</span><span class="p">()</span>
            <span class="c1"># calculate a new residual</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">calculate_residual</span><span class="p">()</span>
            <span class="n">rrel</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">r0</span>
            <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;11}</span><span class="s2"> </span><span class="si">{:&lt;12.6g}</span><span class="s2"> </span><span class="si">{:&lt;12.6g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rrel</span><span class="p">,))</span>

        <span class="c1"># check for convergence failures</span>
        <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;</span> <span class="n">maxits</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Nonlinear iteration failed to converge after </span><span class="si">{}</span><span class="s2"> iterations (maxits = </span><span class="si">{}</span><span class="s2">), r = </span><span class="si">{}</span><span class="s2"> (atol = </span><span class="si">{}</span><span class="s2">), rrel = </span><span class="si">{}</span><span class="s2"> (rtol = </span><span class="si">{}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> \
                                                                                                                                                          <span class="n">maxits</span><span class="p">,</span> \
                                                                                                                                                          <span class="n">r</span><span class="p">,</span> \
                                                                                                                                                          <span class="n">rtol</span><span class="p">,</span> \
                                                                                                                                                          <span class="n">rrel</span><span class="p">,</span> \
                                                                                                                                                          <span class="n">rtol</span><span class="p">,))</span>

        <span class="c1"># only update the pressure at the end as it is not necessary earlier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_p_functions</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Our <code class="docutils literal notranslate"><span class="pre">SubductionProblem</span></code> class is now complete and capable of solving either benchmark case 1 or 2.</p>
<p>Case 2 uses a different <code class="docutils literal notranslate"><span class="pre">io_depth</span></code> (<span class="math notranslate nohighlight">\(z_\text{io}\)</span>) (and we have added functionality to the class) so we need to reinitiatize our problem.  Forunately now that is rather simple and we can create a new geometry and a new <code class="docutils literal notranslate"><span class="pre">_case2</span></code> <code class="docutils literal notranslate"><span class="pre">SubductionProblem</span></code> in just a few lines and use them to solve case 2 and retrieve its diagnostics</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">io_depth_2</span> <span class="o">=</span> <span class="mf">154.0</span>
<span class="n">geom_case2</span> <span class="o">=</span> <span class="n">create_sz_geometry</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> <span class="n">resscale</span><span class="p">,</span> <span class="n">sztype</span><span class="p">,</span> <span class="n">io_depth_2</span><span class="p">,</span> <span class="n">extra_width</span><span class="p">,</span> 
                                <span class="n">coast_distance</span><span class="p">,</span> <span class="n">lc_depth</span><span class="p">,</span> <span class="n">uc_depth</span><span class="p">)</span>
<span class="n">sz_case2</span> <span class="o">=</span> <span class="n">SubductionProblem</span><span class="p">(</span><span class="n">geom_case2</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">Vs</span><span class="o">=</span><span class="n">Vs</span><span class="p">,</span> <span class="n">sztype</span><span class="o">=</span><span class="n">sztype</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Solving steady state flow with dislocation creep rheology...&quot;</span><span class="p">)</span>
<span class="n">sz_case2</span><span class="o">.</span><span class="n">solve_steadystate_dislocationcreep</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning : Gmsh has aleady been initialized
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Info    : Meshing 1D...
Info    : [  0%] Meshing curve 1 (Line)
Info    : [ 10%] Meshing curve 2 (Line)
Info    : [ 10%] Meshing curve 3 (Line)
Info    : [ 10%] Meshing curve 4 (Line)
Info    : [ 10%] Meshing curve 5 (Line)
Info    : [ 10%] Meshing curve 6 (Line)
Info    : [ 10%] Meshing curve 7 (Line)
Info    : [ 10%] Meshing curve 8 (Line)
Info    : [ 10%] Meshing curve 9 (Line)
Info    : [ 10%] Meshing curve 10 (Line)
Info    : [ 20%] Meshing curve 11 (Line)
Info    : [ 20%] Meshing curve 12 (Line)
Info    : [ 20%] Meshing curve 13 (Line)
Info    : [ 20%] Meshing curve 14 (Line)
Info    : [ 20%] Meshing curve 15 (Line)
Info    : [ 20%] Meshing curve 16 (Line)
Info    : [ 20%] Meshing curve 17 (Line)
Info    : [ 20%] Meshing curve 18 (Line)
Info    : [ 20%] Meshing curve 19 (Line)
Info    : [ 30%] Meshing curve 20 (Line)
Info    : [ 30%] Meshing curve 21 (Line)
Info    : [ 30%] Meshing curve 22 (Line)
Info    : [ 30%] Meshing curve 23 (Line)
Info    : [ 30%] Meshing curve 24 (Line)
Info    : [ 30%] Meshing curve 25 (Line)
Info    : [ 30%] Meshing curve 27 (Line)
Info    : [ 30%] Meshing curve 28 (Line)
Info    : [ 30%] Meshing curve 29 (Line)
Info    : [ 40%] Meshing curve 30 (Line)
Info    : [ 40%] Meshing curve 31 (Line)
Info    : [ 40%] Meshing curve 32 (Line)
Info    : [ 40%] Meshing curve 33 (Line)
Info    : [ 40%] Meshing curve 34 (Line)
Info    : [ 40%] Meshing curve 35 (Line)
Info    : [ 40%] Meshing curve 36 (Line)
Info    : [ 40%] Meshing curve 37 (Line)
Info    : [ 40%] Meshing curve 38 (Line)
Info    : [ 50%] Meshing curve 39 (Line)
Info    : [ 50%] Meshing curve 40 (Line)
Info    : [ 50%] Meshing curve 41 (Line)
Info    : [ 50%] Meshing curve 42 (Line)
Info    : [ 50%] Meshing curve 43 (Line)
Info    : [ 50%] Meshing curve 44 (Line)
Info    : [ 50%] Meshing curve 45 (Line)
Info    : [ 50%] Meshing curve 46 (Line)
Info    : [ 50%] Meshing curve 47 (Line)
Info    : [ 60%] Meshing curve 48 (Line)
Info    : [ 60%] Meshing curve 49 (Line)
Info    : [ 60%] Meshing curve 50 (Line)
Info    : [ 60%] Meshing curve 51 (Line)
Info    : [ 60%] Meshing curve 52 (Line)
Info    : [ 60%] Meshing curve 54 (Line)
Info    : [ 60%] Meshing curve 55 (Line)
Info    : [ 60%] Meshing curve 56 (Line)
Info    : [ 60%] Meshing curve 57 (Line)
Info    : [ 70%] Meshing curve 58 (Line)
Info    : [ 70%] Meshing curve 59 (Line)
Info    : [ 70%] Meshing curve 60 (Line)
Info    : [ 70%] Meshing curve 61 (Line)
Info    : [ 70%] Meshing curve 62 (Line)
Info    : [ 70%] Meshing curve 63 (Line)
Info    : [ 70%] Meshing curve 64 (Line)
Info    : [ 70%] Meshing curve 65 (Line)
Info    : [ 70%] Meshing curve 66 (Line)
Info    : [ 80%] Meshing curve 67 (Line)
Info    : [ 80%] Meshing curve 68 (Line)
Info    : [ 80%] Meshing curve 70 (Line)
Info    : [ 80%] Meshing curve 71 (Line)
Info    : [ 80%] Meshing curve 72 (Line)
Info    : [ 80%] Meshing curve 73 (Line)
Info    : [ 80%] Meshing curve 74 (Line)
Info    : [ 80%] Meshing curve 75 (Line)
Info    : [ 80%] Meshing curve 76 (Line)
Info    : [ 90%] Meshing curve 77 (Line)
Info    : [ 90%] Meshing curve 78 (Line)
Info    : [ 90%] Meshing curve 79 (Line)
Info    : [ 90%] Meshing curve 80 (Line)
Info    : [ 90%] Meshing curve 81 (Line)
Info    : [ 90%] Meshing curve 82 (Line)
Info    : [ 90%] Meshing curve 83 (Line)
Info    : [ 90%] Meshing curve 85 (Line)
Info    : [ 90%] Meshing curve 86 (Line)
Info    : [100%] Meshing curve 87 (Line)
Info    : [100%] Meshing curve 88 (Line)
Info    : [100%] Meshing curve 89 (Line)
Info    : [100%] Meshing curve 90 (Line)
Info    : [100%] Meshing curve 91 (Line)
Info    : [100%] Meshing curve 92 (Line)
Info    : [100%] Meshing curve 93 (Line)
Info    : [100%] Meshing curve 95 (Line)
Info    : [100%] Meshing curve 96 (Line)
Info    : Done meshing 1D (Wall 0.0138335s, CPU 0.0157s)
Info    : Meshing 2D...
Info    : [  0%] Meshing surface 1 (Plane, Frontal-Delaunay)
Info    : [ 20%] Meshing surface 2 (Plane, Frontal-Delaunay)
Info    : [ 40%] Meshing surface 3 (Plane, Frontal-Delaunay)
Info    : [ 50%] Meshing surface 4 (Plane, Frontal-Delaunay)
Info    : [ 70%] Meshing surface 5 (Plane, Frontal-Delaunay)
Info    : [ 90%] Meshing surface 6 (Plane, Frontal-Delaunay)
Info    : Done meshing 2D (Wall 0.0392668s, CPU 0.040033s)
Info    : 1485 nodes 3261 elements
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Solving steady state flow with dislocation creep rheology...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration   Residual     Relative Residual
------------------------------------------
0           14039.3      1           
1           1161.26      0.0827153   
2           256.735      0.0182869   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3           103.968      0.0074055   
4           48.9798      0.00348877  
5           26.4549      0.00188435  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6           16.1772      0.00115228  
7           10.7653      0.0007668   
8           7.60442      0.000541653 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9           5.59295      0.000398379 
10          4.21471      0.000300209 
11          3.22359      0.000229612 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12          2.4908       0.000177416 
13          1.93954      0.000138151 
14          1.51997      0.000108266 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15          1.19783      8.53198e-05 
16          0.948679     6.75732e-05 
17          0.754764     5.37609e-05 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>18          0.602991     4.29503e-05 
19          0.483598     3.44461e-05 
20          0.389239     2.7725e-05  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>21          0.314337     2.23898e-05 
22          0.254634     1.81372e-05 
23          0.206858     1.47342e-05 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>24          0.168483     1.20008e-05 
25          0.13755      9.79752e-06 
26          0.112533     8.01558e-06 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>27          0.0922379    6.56999e-06 
28          0.0757272    5.39395e-06 
29          0.0622606    4.43474e-06 
</pre></div>
</div>
</div>
</div>
<p>We can now resuse the routine from earlier to extract the diagnostic values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diag_case2</span> <span class="o">=</span> <span class="n">sz_case2</span><span class="o">.</span><span class="n">get_diagnostics</span><span class="p">()</span>
<span class="n">T_ndof_case2</span> <span class="o">=</span> <span class="n">sz_case2</span><span class="o">.</span><span class="n">V_T</span><span class="o">.</span><span class="n">dofmap</span><span class="o">.</span><span class="n">index_map</span><span class="o">.</span><span class="n">size_global</span> <span class="o">*</span> <span class="n">sz</span><span class="o">.</span><span class="n">V_T</span><span class="o">.</span><span class="n">dofmap</span><span class="o">.</span><span class="n">index_map_bs</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;12}</span><span class="s1"> </span><span class="si">{:&lt;12}</span><span class="s1"> </span><span class="si">{:&lt;12}</span><span class="s1"> </span><span class="si">{:&lt;12}</span><span class="s1"> </span><span class="si">{:&lt;12}</span><span class="s1"> </span><span class="si">{:&lt;12}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;resscale&#39;</span><span class="p">,</span> <span class="s1">&#39;T_ndof&#39;</span><span class="p">,</span> <span class="s1">&#39;T_{200,-100}&#39;</span><span class="p">,</span> <span class="s1">&#39;Tbar_s&#39;</span><span class="p">,</span> <span class="s1">&#39;Tbar_w&#39;</span><span class="p">,</span> <span class="s1">&#39;Vrmsw&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;12.4g}</span><span class="s1"> </span><span class="si">{:&lt;12d}</span><span class="s1"> </span><span class="si">{:&lt;12.4f}</span><span class="s1"> </span><span class="si">{:&lt;12.4f}</span><span class="s1"> </span><span class="si">{:&lt;12.4f}</span><span class="s1"> </span><span class="si">{:&lt;12.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resscale</span><span class="p">,</span> <span class="n">T_ndof_case2</span><span class="p">,</span> <span class="n">diag_case2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">diag_case2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">diag_case2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">diag_case2</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>T_(200,-100) = 679.02 deg C
T_slab = 568.56 deg C
T_wedge = 941.66 deg C
V_rms,w = 41.96 mm/yr

resscale     T_ndof       T_{200,-100} Tbar_s       Tbar_w       Vrmsw       
5            5856         679.0166     568.5575     941.6615     41.9561     
</pre></div>
</div>
</div>
</div>
<p>For comparison here are the values reported for case 2 using <a class="reference external" href="https://terraferma.github.io">TerraFERMA</a> in <a class="reference external" href="http://dx.doi.org/10.1186/s40645-023-00588-6">Wilson &amp; van Keken, 2023</a>:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">resscale</span></code></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(T_{\text{ndof}} \)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(T_{(200,-100)}^*\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(\overline{T}_s^*\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\( \overline{T}_w^* \)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(V_{\text{rms},w}^*\)</span></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2.0</p></td>
<td><p>21403</p></td>
<td><p>683.05</p></td>
<td><p>571.58</p></td>
<td><p>936.65</p></td>
<td><p>40.89</p></td>
</tr>
<tr class="row-odd"><td><p>1.0</p></td>
<td><p>83935</p></td>
<td><p>682.87</p></td>
<td><p>572.23</p></td>
<td><p>936.11</p></td>
<td><p>40.78</p></td>
</tr>
<tr class="row-even"><td><p>0.5</p></td>
<td><p>332307</p></td>
<td><p>682.80</p></td>
<td><p>572.05</p></td>
<td><p>937.37</p></td>
<td><p>40.77</p></td>
</tr>
</tbody>
</table>
</div>
<p>And, as before we can plot the temperature and velocities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utils</span><span class="o">.</span><span class="n">plot_scalar</span><span class="p">(</span><span class="n">sz_case2</span><span class="o">.</span><span class="n">T_i</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_vector</span><span class="p">(</span><span class="n">sz_case2</span><span class="o">.</span><span class="n">vw_i</span><span class="p">)</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_vector</span><span class="p">(</span><span class="n">sz_case2</span><span class="o">.</span><span class="n">vs_i</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/da079a69fa4579ae474b741876975dc9fefcd0234cd0e18cc13758f999aca56f.png" src="../_images/da079a69fa4579ae474b741876975dc9fefcd0234cd0e18cc13758f999aca56f.png" />
<img alt="../_images/61f6894482f8fa07d40c411e6f0c123034c83906554965e60c75a43f3fe40590.png" src="../_images/61f6894482f8fa07d40c411e6f0c123034c83906554965e60c75a43f3fe40590.png" />
<img alt="../_images/7bd9d0621d2d9f07af6b00b6e1145123493f3b335f7b59c2a6d7efbf8e10d044.png" src="../_images/7bd9d0621d2d9f07af6b00b6e1145123493f3b335f7b59c2a6d7efbf8e10d044.png" />
</div>
</div>
<p>In addition, we can also now visualize the viscosity (note that we are using a log scale).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eta_i</span> <span class="o">=</span> <span class="n">sz_case2</span><span class="o">.</span><span class="n">project_dislocationcreep_viscosity</span><span class="p">()</span>
<span class="n">utils</span><span class="o">.</span><span class="n">plot_scalar</span><span class="p">(</span><span class="n">eta_i</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sz_case2</span><span class="o">.</span><span class="n">eta0</span><span class="p">,</span> <span class="n">log_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/62e288084be0fa7863b9d76a723cba72c379354fa05f2f7ce5cb6a6d22b6f1df.png" src="../_images/62e288084be0fa7863b9d76a723cba72c379354fa05f2f7ce5cb6a6d22b6f1df.png" />
</div>
</div>
<p>We can also reuse our slab temperature function to see their behavior in case 2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_slab_temperatures</span><span class="p">(</span><span class="n">sz_case2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/14e2b2b982f647232793a6468f10bfe105cb02ae7b7c442275060ff0b767dbf1.png" src="../_images/14e2b2b982f647232793a6468f10bfe105cb02ae7b7c442275060ff0b767dbf1.png" />
</div>
</div>
</section>
</section>
</section>
<section id="themes-and-variations">
<h2>Themes and variations<a class="headerlink" href="#themes-and-variations" title="Link to this heading">#</a></h2>
<p>Some possible things to try next:</p>
<ul class="simple">
<li><p>Try using <code class="docutils literal notranslate"><span class="pre">plot_slab_temperatures</span></code> as a template to extract different temperatures around the domain.  Perhaps a vertical profile under a putative arc location.</p></li>
<li><p>Note that at the default resolution in this notebook case 2 did not do as well as case 1 at matching the benchmark.  Try increasing the resolution to see if it improves the solution (if running on binder then it may not be possible to decrease <code class="docutils literal notranslate"><span class="pre">resscale</span></code> excessively).</p></li>
<li><p>Try varying aspects of the geometry.  What happens at different slab dips or when <code class="docutils literal notranslate"><span class="pre">extra_width</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>?</p></li>
<li><p>Try varying some of the optional parameters, such as the coupling depth.  Note that when varying <code class="docutils literal notranslate"><span class="pre">partial_coupling_depth</span></code>, <code class="docutils literal notranslate"><span class="pre">full_coupling_depth</span></code> should also be varied to ensure it is deeper along the slab.</p></li>
</ul>
<p>Even though this notebook set up the benchmark problem it should be valid for any of the global suite discussed in <a class="reference external" href="http://dx.doi.org/10.1186/s40645-023-00589-5">van Keken &amp; Wilson, 2023</a>, which is itself built on the suite in <a class="reference external" href="http://dx.doi.org/10.1016/j.pepi.2010.02.004">Syracuse et al., 2010</a>, with the exception that here we have assumed a steady state.  All the data from <a class="reference external" href="http://dx.doi.org/10.1186/s40645-023-00589-5">van Keken &amp; Wilson, 2023</a> is available in <code class="docutils literal notranslate"><span class="pre">../data/all_sz.json</span></code> using the same parameter names as implemented here.  So, it should be possible to load that database (like we did with <code class="docutils literal notranslate"><span class="pre">default_params</span></code> above) and run a steady-state version of one of those cases.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Poisson2D.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Poisson Example 2D</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-revised-benchmark">A Revised Benchmark</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble">Preamble</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#describing-the-geometry">Describing the geometry</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#slab-geometry">Slab geometry</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#subduction-zone-geometry">Subduction zone geometry</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kinematic-slab-model">Kinematic slab model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-subductionproblem-class">The <code class="docutils literal notranslate"><span class="pre">SubductionProblem</span></code> class</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-the-initial-setup">Testing the initial setup</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#isoviscous-case-1">Isoviscous (Case 1)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dislocation-creep-viscosity-case-2">Dislocation Creep Viscosity (Case 2)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#themes-and-variations">Themes and variations</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Cian Wilson
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    <p class="last-updated">
  Last updated on May 31, 2024.
  <br/>
</p>
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>