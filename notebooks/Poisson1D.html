
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Poisson Example 1D &#8212; FEniCSx Subduction</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/Poisson1D';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Poisson Example 2D" href="Poisson2D.html" />
    <link rel="prev" title="Overview" href="../readme.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Jun 02, 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">FEniCSx Subduction</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    FEniCSx Subduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../readme.html">Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Background</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Poisson Example 1D</a></li>
<li class="toctree-l1"><a class="reference internal" href="Poisson2D.html">Poisson Example 2D</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Subduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="SubductionBenchmark.html">Subduction Zone Benchmark</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/cianwilson/fenicsx_subduction/main?urlpath=lab/tree/./notebooks/Poisson1D.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/cianwilson/fenicsx_subduction" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cianwilson/fenicsx_subduction/edit/main/./notebooks/Poisson1D.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cianwilson/fenicsx_subduction/issues/new?title=Issue%20on%20page%20%2Fnotebooks/Poisson1D.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/Poisson1D.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Poisson Example 1D</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#description">Description</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble">Preamble</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solution">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing">Testing</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="poisson-example-1d">
<h1>Poisson Example 1D<a class="headerlink" href="#poisson-example-1d" title="Link to this heading">#</a></h1>
<section id="description">
<h2>Description<a class="headerlink" href="#description" title="Link to this heading">#</a></h2>
<p>As an introductory and simplified example we will solve the Poisson equation on a 1D domain of unit length, <span class="math notranslate nohighlight">\(\Omega = [0,1]\)</span>, by seeking the approximate solution of</p>
<div class="amsmath math notranslate nohighlight" id="equation-8a39239a-4351-4ca6-afbd-c82d7fdb43d6">
<span class="eqno">(1)<a class="headerlink" href="#equation-8a39239a-4351-4ca6-afbd-c82d7fdb43d6" title="Permalink to this equation">#</a></span>\[\begin{align}
-\frac{d^2 T}{dx^2} &amp;= h  % &amp;&amp; \text{in }\Omega
\end{align}\]</div>
<p>where we choose for this example <span class="math notranslate nohighlight">\(h=\frac{1}{4}\pi^2 \sin\left(\frac{\pi x}{2} \right)\)</span>.</p>
<p>At the boundaries, <span class="math notranslate nohighlight">\(x\)</span>=0 and <span class="math notranslate nohighlight">\(x\)</span>=1, we apply as boundary conditions \begin{align}
T &amp;= 0 &amp;&amp; \text{at } x=0  \
\frac{dT}{dx} &amp;= 0 &amp;&amp; \text{at } x=1
\end{align}
The first boundary condition is an example of an essential or Dirichlet boundary condition where we specify the
value of the solution. The second boundary condition is an example of a natural or Neumann boundary condition that can be interpreted to mean that the solution is symmetrical around <span class="math notranslate nohighlight">\(x\)</span>=1.</p>
<p>The analytical solution to the Poisson equation in 1D with the given boundary conditions and forcing function is simply</p>
<div class="amsmath math notranslate nohighlight" id="equation-6d27d422-7005-4796-a49f-75fb56efc734">
<span class="eqno">(2)<a class="headerlink" href="#equation-6d27d422-7005-4796-a49f-75fb56efc734" title="Permalink to this equation">#</a></span>\[\begin{equation}
  T = \sin\left(\frac{\pi x}{2}\right)
\end{equation}\]</div>
<p>but we will still solve this numerically as a verification test of our implementation.</p>
<p>Finite element methods are formulated by writing out the weak form of the equation.  In the case of 1D Poisson, we multiply the equation by an arbitrary “test” function, <span class="math notranslate nohighlight">\(T_t\)</span>, and integrate over the domain:</p>
<div class="amsmath math notranslate nohighlight" id="equation-854f6787-4e34-4879-bf8a-617b2b62cd02">
<span class="eqno">(3)<a class="headerlink" href="#equation-854f6787-4e34-4879-bf8a-617b2b62cd02" title="Permalink to this equation">#</a></span>\[\begin{equation}
-\int_0^1 T_t \frac{d^2 T}{dx^2} dx = \int_0^1 h dx
\end{equation}\]</div>
<p>To lower the continuity requirements on the discrete form of <span class="math notranslate nohighlight">\(T\)</span> we can integrate the first term by parts giving us the <strong>weak form</strong> of the equation</p>
<div class="amsmath math notranslate nohighlight" id="equation-1d578add-5efd-4131-b11f-96e3e25c2fa1">
<span class="eqno">(4)<a class="headerlink" href="#equation-1d578add-5efd-4131-b11f-96e3e25c2fa1" title="Permalink to this equation">#</a></span>\[\begin{equation}
\int_0^1 \frac{d T_t}{dx} \frac{d T}{dx} dx - \left[T_t \frac{dT}{dx} \right]_0^1  = \int_0^1 h dx
\end{equation}\]</div>
<p>To discretize the equation, the FEM approximates <span class="math notranslate nohighlight">\(T\)</span> by <span class="math notranslate nohighlight">\(\tilde{T}\)</span>, the solution’s representation in a <strong>function space</strong> on the mesh where</p>
<div class="amsmath math notranslate nohighlight" id="equation-4cf56435-858d-43a6-973c-4b212fca28f2">
<span class="eqno">(5)<a class="headerlink" href="#equation-4cf56435-858d-43a6-973c-4b212fca28f2" title="Permalink to this equation">#</a></span>\[\begin{equation}
\tilde{T}(\vec{x}, t) = \sum_j \phi_j(\vec{x}) T_j(t) 
\end{equation}\]</div>
<p>Here, <span class="math notranslate nohighlight">\(T_j\)</span> are coefficients that as indicated can be time-dependent if the problem is time-dependent (not the case in this example) but do not depend on space. The shape functions <span class="math notranslate nohighlight">\(\phi_j\)</span> are a function of space but generally independent of time. The index <span class="math notranslate nohighlight">\(j\)</span> indicates the number of the shape function on the mesh and is associated with the number of the nodal point or element number it is associated with.
In this tutorial, we will principally discuss so-called  Lagrange shape functions which define <span class="math notranslate nohighlight">\(\phi_j\)</span> as a polynomial over an element with a value of 1 at a single nodal point and a value of 0 at all other points associated with the degrees of freedom such that <span class="math notranslate nohighlight">\(\sum_j\phi_j=1\)</span>.  The shape functions can be of arbitrary order and can have various conditions on their continuity across or in between elements. We will focus principally on linear Lagrange shape functions (denoted by P1) and quadratic Lagrange shape functions (denoted by P2) that are continuous between mesh elements.
<img alt="Lagrange shape functions in 1D" src="../_images/shapefunctions1d.png" /></p>
<p>Our choice of Lagrange shape functions means that <span class="math notranslate nohighlight">\(T_j\)</span> are the actual values of the solution.  With other forms of the shape function (see, e.g., <a class="reference external" href="https://defelement.com/">DefElement</a>)
<span class="math notranslate nohighlight">\(T_j\)</span> are instead interpolation weights that are used to construct the solution values.
The split of temporal and spatial dependence above is typical in geodynamic applications but not required.</p>
<p>The test functions <span class="math notranslate nohighlight">\(T_t\)</span> can be independent of the functions
that span the function space of the trial function,
but in the widely used Galerkin approach the test functions
are restricted to be in the same function space such that</p>
<div class="amsmath math notranslate nohighlight" id="equation-ca4235ee-0ecf-4172-b667-6c92feb601cf">
<span class="eqno">(6)<a class="headerlink" href="#equation-ca4235ee-0ecf-4172-b667-6c92feb601cf" title="Permalink to this equation">#</a></span>\[\begin{equation}
\tilde{T}_t(\vec{x}, t) = \sum_i\phi_i(\vec{x})  T_{ti}(t) 
\end{equation}\]</div>
<p>Since the method is valid for all <span class="math notranslate nohighlight">\(\tilde{T}_t\)</span> we can dispense with the test function values at the DOFs, <span class="math notranslate nohighlight">\(T_{ti}\)</span> and, through substitution of <span class="math notranslate nohighlight">\(T = \tilde{T}\)</span> and <span class="math notranslate nohighlight">\(T_t = \tilde{T}_t\)</span> write the <strong>discrete weak form</strong> as</p>
<div class="amsmath math notranslate nohighlight" id="equation-1bbfad74-616e-4c5d-993f-b917872f2889">
<span class="eqno">(7)<a class="headerlink" href="#equation-1bbfad74-616e-4c5d-993f-b917872f2889" title="Permalink to this equation">#</a></span>\[\begin{equation}
\sum_j\int_0^1 \frac{d \phi_i}{dx} \frac{d \phi_j}{dx} dx T_j - \sum_j\left[\phi_i \frac{d\phi_j}{dx} \right]_0^1 T_j = \int_0^1 h dx, \quad\quad i = 1,\ldots, n
\end{equation}\]</div>
<p>The second term can be dropped because we require <span class="math notranslate nohighlight">\(\frac{d\tilde{T}}{dx} = 0\)</span> at <span class="math notranslate nohighlight">\(x=1\)</span> and the solution at <span class="math notranslate nohighlight">\(x=0\)</span> (<span class="math notranslate nohighlight">\(i=0\)</span>) is known (<span class="math notranslate nohighlight">\(T_0=0\)</span>)</p>
<div class="amsmath math notranslate nohighlight" id="equation-942fe500-a25e-4afb-aeeb-356a19931cdf">
<span class="eqno">(8)<a class="headerlink" href="#equation-942fe500-a25e-4afb-aeeb-356a19931cdf" title="Permalink to this equation">#</a></span>\[\begin{equation}
\sum_j\int_0^1 \frac{d \phi_i}{dx} \frac{d \phi_j}{dx} dx T_j = \int_0^1 h dx, \quad\quad i = 1,\ldots, n
\end{equation}\]</div>
<p>Given a domain with <span class="math notranslate nohighlight">\(n\)</span> DOFs such that <span class="math notranslate nohighlight">\(i,j=1, \ldots, n\)</span>, the discrete weak form can be assembled into a matrix-vector system of the form</p>
<div class="amsmath math notranslate nohighlight" id="equation-a6ecf4b2-3a05-4005-a3c4-3a9886dfbe6f">
<span class="eqno">(9)<a class="headerlink" href="#equation-a6ecf4b2-3a05-4005-a3c4-3a9886dfbe6f" title="Permalink to this equation">#</a></span>\[\begin{equation}
{\bf S} {\bf u} = {\bf f}
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(\bf{S}\)</span> is a <span class="math notranslate nohighlight">\(n \times n\)</span> matrix, <span class="math notranslate nohighlight">\(\bf{f}\)</span> is the right-hand side vector of length <span class="math notranslate nohighlight">\(n\)</span> and <span class="math notranslate nohighlight">\(\bf{u}\)</span> is the solution vector of values at the DOFs</p>
<div class="amsmath math notranslate nohighlight" id="equation-df68bbcf-3b84-4a15-9ec9-f9434290f150">
<span class="eqno">(10)<a class="headerlink" href="#equation-df68bbcf-3b84-4a15-9ec9-f9434290f150" title="Permalink to this equation">#</a></span>\[\begin{align}
{\bf S} &amp;= S_{ij} = \int_0^1 \frac{d\phi_i}{dx} \frac{d\phi_j}{dx} ~dx  \\
{\bf f} &amp;= f_i = \int_0^1 \phi_i  h ~dx \\
{\bf u} &amp;= {\bf T} = T_j
\end{align}\]</div>
<p>where <span class="math notranslate nohighlight">\({\bf T}\)</span> has components <span class="math notranslate nohighlight">\(T_j\)</span> that define the continuous approximate solution</p>
<div class="amsmath math notranslate nohighlight" id="equation-8661abc0-1815-4e92-b11f-005d8e158857">
<span class="eqno">(11)<a class="headerlink" href="#equation-8661abc0-1815-4e92-b11f-005d8e158857" title="Permalink to this equation">#</a></span>\[\begin{equation}
\tilde{T}(x) = \sum_{j=1}^n  \phi_j(x) T_j
\end{equation}\]</div>
<p>and <span class="math notranslate nohighlight">\(T_0 = 0\)</span>.</p>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h2>
<p>Traditionally, finite element methods have been implemented using Fortran or C/C++
based codes that, at the core, build the matrix-vector system by numerical integration, after which this system is solved by linear algebraic solvers. Most FEM codes provide options for time-dependence and the ability to solve nonlinear and nonlinearly coupled systems of PDEs.
Examples of such codes that have been used in geodynamical applications including subduction zone modeling are
<a class="reference external" href="https://doi.org/10.1016/0031-9201(90)90225-M">ConMan</a>, <a class="reference external" href="https://doi.org/10.1111/j.1365-246X.1995.tb05908.x">Sopale</a>,
<a class="reference external" href="https://doi.org/10.1016/j.pepi.2007.06.009">Underworld</a>,
<a class="reference external" href="https://doi.org/10.1029/2008GC002048">CitcomS</a>,
<a class="reference external" href="https://doi.org/10.1029/2007GC001719">MILAMIN</a>,
<a class="reference external" href="https://doi.org/10.1111/j.1365-246X.2012.05609.x">ASPECT</a>,
<a class="reference external" href="https://doi.org/10.1007/s12583-015-0508-0">Sepran</a>,
<a class="reference external" href="https://doi.org/10.1029/2011GC003551">Fluidity</a>,
and <a class="reference external" href="https://doi.org/10.1093/gji/ggs070">Rhea</a>.
A number of these are distributed as open-source
software and many among those are currently maintained through the
<a class="reference internal" href="#geodynamics.org"><span class="xref myst">Computational Infrastructure for Geodynamics</span></a>.
These implementations can be shown to be accurate using intercomparisons
and benchmarks and make use of advances in parallel computing and efficient linear algebra solver techniques. Yet, modifications to the existing code requires deep insight into the structure of the Fortran/C/C++ code which is not trivial for experienced, let alone beginning, users.</p>
<p>In recent years an alternative approach for FEM has become available which elevates the user interface to simply specifying the FEM problem and solution method with the high-level approach.
Python code is used to automatically build a finite element model that can be executed in a variety of environments ranging from <a class="reference internal" href="#jupyter.org"><span class="xref myst">Jupyter notebooks</span></a> and desktop computers to massively parallel high performance computers.
Two prominent examples of this approach are <a class="reference internal" href="#www.firedrakeproject.org"><span class="xref myst">Firedrake</span></a> and <a class="reference internal" href="#www.fenicsproject.org"><span class="xref myst">FEniCS</span></a>. Examples of the use of these two approaches in geodynamical
applications are in <a class="reference external" href="https://doi.org/10.5194/gmd-15-5127-2022">Davies et al., 2022</a> and <a class="reference external" href="https://doi.org/10.1016/j.cageo.2012.05.012">Vynnytska et al., 2013</a>.</p>
<p>This and following examples were presented by <a class="reference external" href="http://dx.doi.org/10.1186/s40645-023-00588-6">Wilson &amp; van Keken, 2023</a> using FEniCS v2019.1.0 and <a class="reference internal" href="#terraferma.github.io"><span class="xref myst">TerraFERMA</span></a>, a GUI-based model building framework that also uses FEniCS v2019.1.0.  These simulations are publicly available in a <a class="reference internal" href="#doi.org/10.5281/zenodo.7843967"><span class="xref myst">zenodo</span></a> archive and can be run using a <a class="reference external" href="https://github.com/users/cianwilson/packages/container/package/vankeken_wilson_peps_2023">docker</a> image.</p>
<p>Here we will focus on reproducing the results of <a class="reference external" href="http://dx.doi.org/10.1186/s40645-023-00588-6">Wilson &amp; van Keken, 2023</a> using the latest version of FEniCS, FEniCSx.
<a class="reference external" href="https://doi.org/10.11588/ans.2015.100.20553">FEniCS</a> is a suite of open-source numerical libraries for the description of finite element problems.  Most importantly it provides a high-level, human-readable language
for the description of equations in python Unified Form Language (<a class="reference external" href="https://doi.org/10.1145/2566630">UFL</a>)
and the FEniCS Form Compiler (<a class="reference external" href="https://doi.org/10.1145/1163641.1163644">FFC</a>)
to write fast code to assemble the resulting discrete matrix-vector system.</p>
<section id="preamble">
<h3>Preamble<a class="headerlink" href="#preamble" title="Link to this heading">#</a></h3>
<p>We start by loading all the modules we will require.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">import</span> <span class="nn">dolfinx</span> <span class="k">as</span> <span class="nn">df</span>
<span class="kn">import</span> <span class="nn">dolfinx.fem.petsc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">))</span>
<span class="kn">import</span> <span class="nn">utils</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="solution">
<h3>Solution<a class="headerlink" href="#solution" title="Link to this heading">#</a></h3>
<p>We then declare a python function <code class="docutils literal notranslate"><span class="pre">solve_poisson_1d</span></code> that contains a complete description of the discrete Poisson equation problem.</p>
<p>This function follows much the same flow as described above:</p>
<ol class="arabic simple">
<li><p>we describe the domain <span class="math notranslate nohighlight">\(\Omega\)</span> and discretize it into <code class="docutils literal notranslate"><span class="pre">ne</span></code> elements or cells to make a <code class="docutils literal notranslate"><span class="pre">mesh</span></code></p></li>
<li><p>we declare the <strong>function space</strong>, <code class="docutils literal notranslate"><span class="pre">V</span></code>, to use Lagrange polynomials of degree <code class="docutils literal notranslate"><span class="pre">p</span></code></p></li>
<li><p>using this function space we declare trial, <code class="docutils literal notranslate"><span class="pre">T_a</span></code>, and test, <code class="docutils literal notranslate"><span class="pre">T_t</span></code>, functions</p></li>
<li><p>we define the Dirichlet boundary condition, <code class="docutils literal notranslate"><span class="pre">bc</span></code> at <span class="math notranslate nohighlight">\(x=0\)</span>, setting the desired value there to be 0</p></li>
<li><p>we define the right hand side forcing function <span class="math notranslate nohighlight">\(h\)</span>, <code class="docutils literal notranslate"><span class="pre">h</span></code></p></li>
<li><p>we describe the <strong>discrete weak forms</strong>, <code class="docutils literal notranslate"><span class="pre">S</span></code> and <code class="docutils literal notranslate"><span class="pre">f</span></code>, that will be used to assemble the matrix <span class="math notranslate nohighlight">\(\mathbf{S}\)</span> and vector <span class="math notranslate nohighlight">\(\mathbf{f}\)</span></p></li>
<li><p>we solve the matrix problem using a linear algebra back-end and return the solution</p></li>
</ol>
<p>For a more detailed description of solving the Poisson equation using FEniCSx, see <a class="reference external" href="https://jsdokken.com/dolfinx-tutorial/chapter1/fundamentals.html">the FEniCSx tutorial</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">solve_poisson_1d</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A python function to solve a one-dimensional Poisson problem</span>
<span class="sd">    on a unit interval domain.</span>
<span class="sd">    Parameters:</span>
<span class="sd">      * ne - number of elements</span>
<span class="sd">      * p  - polynomial order of the solution function space</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Describe the domain (a one-dimensional unit interval)</span>
    <span class="c1"># and also the tessellation of that domain into ne </span>
    <span class="c1"># equally spaced elements</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_unit_interval</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>

    <span class="c1"># Define the solution function space using Lagrange polynomials</span>
    <span class="c1"># of order p</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

    <span class="c1"># Define the trial and test functions on the same function space (V)</span>
    <span class="n">T_a</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">T_t</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

    <span class="c1"># Define the location of the boundary, x=0</span>
    <span class="k">def</span> <span class="nf">boundary</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Specify the value and define a boundary condition (bc)</span>
    <span class="n">boundary_dofs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_geometrical</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">boundary</span><span class="p">)</span>
    <span class="n">gD</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">default_scalar_type</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
    <span class="n">bc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">gD</span><span class="p">,</span> <span class="n">boundary_dofs</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>

    <span class="c1"># Define the right hand side function, h</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">SpatialCoordinate</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>

    <span class="c1"># Define the integral to be assembled into the stiffness matrix</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">T_t</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">T_a</span><span class="p">))</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
    <span class="c1"># Define the integral to be assembled into the forcing vector</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">T_t</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>

    <span class="c1"># Compute the solution (given the boundary condition, bc)</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">LinearProblem</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="p">[</span><span class="n">bc</span><span class="p">],</span> \
                                         <span class="n">petsc_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;preonly&quot;</span><span class="p">,</span> \
                                                        <span class="s2">&quot;pc_type&quot;</span><span class="p">:</span> <span class="s2">&quot;lu&quot;</span><span class="p">})</span>
    <span class="n">T_i</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

    <span class="c1"># Return the solution</span>
    <span class="k">return</span> <span class="n">T_i</span>
</pre></div>
</div>
</div>
</div>
<p>We can then use <code class="docutils literal notranslate"><span class="pre">solve_poisson_1d</span></code> to solve on, for example, 4 elements with (the default) P1 elements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ne</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">T_P1</span> <span class="o">=</span> <span class="n">solve_poisson_1d</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Comparing the numerical, <span class="math notranslate nohighlight">\(\tilde{T}\)</span>, and analytical, <span class="math notranslate nohighlight">\(T\)</span>, solutions we can see that even at this small number of elements we do a good job at reproducing the correct answer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">201</span><span class="p">)</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">T_P1_x</span> <span class="o">=</span> <span class="n">T_P1</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_first_cells</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">T_P1</span><span class="o">.</span><span class="n">function_space</span><span class="o">.</span><span class="n">mesh</span><span class="p">))[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">T_P1_x</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">tilde</span><span class="si">{T}</span><span class="s1">$ (P1)&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[::</span><span class="mi">50</span><span class="p">],</span> <span class="n">T_P1_x</span><span class="p">[::</span><span class="mi">50</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;--g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$T$&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$T$&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Numerical (P1) and exact solutions&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/bb3a73e7924f774bd67422c2fc6c041384db9ad20c7336e00506d78a7ae4b199.png" src="../_images/bb3a73e7924f774bd67422c2fc6c041384db9ad20c7336e00506d78a7ae4b199.png" />
</div>
</div>
<p>We can also try with a higher order element and see how it improves the solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T_P2</span> <span class="o">=</span> <span class="n">solve_poisson_1d</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The higher polynomial degree qualitatively appears to have a dramatic improvement in the solution accuracy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">201</span><span class="p">)</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">T_P2_x</span> <span class="o">=</span> <span class="n">T_P2</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_first_cells</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">T_P2</span><span class="o">.</span><span class="n">function_space</span><span class="o">.</span><span class="n">mesh</span><span class="p">))[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">T_P2_x</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">tilde</span><span class="si">{T}</span><span class="s1">$ (P2)&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[::</span><span class="mi">25</span><span class="p">],</span> <span class="n">T_P2_x</span><span class="p">[::</span><span class="mi">25</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;--g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$T$&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$T$&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Numerical (P2) and exact solutions&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f1c1770ee10f9bc029771ed9d7f89347858e99927bb1d94da01932e4ed96177e.png" src="../_images/f1c1770ee10f9bc029771ed9d7f89347858e99927bb1d94da01932e4ed96177e.png" />
</div>
</div>
</section>
<section id="testing">
<h3>Testing<a class="headerlink" href="#testing" title="Link to this heading">#</a></h3>
<p>We can quantify the error in cases where the analytical solution is known by taking the L2 norm of the difference between the numerical and exact solutions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">evaluate_error</span><span class="p">(</span><span class="n">T_i</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A python function to evaluate the l2 norm of the error in </span>
<span class="sd">    the one dimensional Poisson problem given a known analytical</span>
<span class="sd">    solution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define the exact solution</span>
    <span class="n">x</span>  <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">SpatialCoordinate</span><span class="p">(</span><span class="n">T_i</span><span class="o">.</span><span class="n">function_space</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">Te</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># Define the error between the exact solution and the given</span>
    <span class="c1"># approximate solution</span>
    <span class="n">l2err</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">((</span><span class="n">T_i</span> <span class="o">-</span> <span class="n">Te</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">T_i</span> <span class="o">-</span> <span class="n">Te</span><span class="p">)</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dx</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
    
    <span class="c1"># Return the l2 norm of the error</span>
    <span class="k">return</span> <span class="n">l2err</span>
</pre></div>
</div>
</div>
</div>
<p>Repeating the numerical experiments with increasing <code class="docutils literal notranslate"><span class="pre">ne</span></code> allows us to test the <strong>convergence</strong> of our approximate finite element solution to the known analytical solution.  A key feature of any discretization technique is that with an increasing number of degrees of freedom (DOFs) these solutions should converge, i.e. the error in our approximation should decrease.  As an error metric we will use the <span class="math notranslate nohighlight">\(L^2\)</span> norm of the difference between the
approximate, <span class="math notranslate nohighlight">\(\tilde{T}\)</span>, and analytical, <span class="math notranslate nohighlight">\(T\)</span>, solutions</p>
<div class="amsmath math notranslate nohighlight" id="equation-7410de92-3e21-4157-b68e-dc8970e0b23a">
<span class="eqno">(12)<a class="headerlink" href="#equation-7410de92-3e21-4157-b68e-dc8970e0b23a" title="Permalink to this equation">#</a></span>\[\begin{equation}
e_{L^2} = \sqrt{\int_\Omega \left(\tilde{T} - T\right)^2 dx}
\end{equation}\]</div>
<p>The rate at which this decreases is known as the order of convergence. Numerical analysis predicts a certain order depending on the type of the polynomials used as finite element shape functions and other constraints related to the well-posedness of the problem. For piecewise linear shape functions we expect second-order convergence, that is that the error decreases as <span class="math notranslate nohighlight">\(h^{-2}\)</span> where <span class="math notranslate nohighlight">\(h\)</span> is the nodal point spacing. With piecewise quadratic elements we expect to see third-order convergence.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open a figure for plotting</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="c1"># Make an output folder</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>
<span class="n">output_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># List of polynomial orders to try</span>
<span class="n">ps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="c1"># List of resolutions to try</span>
<span class="n">nelements</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">320</span><span class="p">]</span>
<span class="c1"># Keep track of whether we get the expected order of convergence</span>
<span class="n">test_passes</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># Loop over the polynomial orders</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">:</span>
    <span class="c1"># Accumulate the errors</span>
    <span class="n">errors_l2_a</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over the resolutions</span>
    <span class="k">for</span> <span class="n">ne</span> <span class="ow">in</span> <span class="n">nelements</span><span class="p">:</span>
        <span class="c1"># Solve the 1D Poisson problem</span>
        <span class="n">T_i</span> <span class="o">=</span> <span class="n">solve_poisson_1d</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="c1"># Evaluate the error in the approximate solution</span>
        <span class="n">l2error</span> <span class="o">=</span> <span class="n">evaluate_error</span><span class="p">(</span><span class="n">T_i</span><span class="p">)</span>
        <span class="c1"># Print to screen and save</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ne = &#39;</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="s1">&#39;, l2error = &#39;</span><span class="p">,</span> <span class="n">l2error</span><span class="p">)</span>
        <span class="n">errors_l2_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l2error</span><span class="p">)</span>

    <span class="c1"># Work out the order of convergence at this p</span>
    <span class="n">hs</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nelements</span><span class="p">)</span><span class="o">/</span><span class="n">p</span>
    
    <span class="c1"># Write the errors to disk</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_folder</span> <span class="o">/</span> <span class="s1">&#39;1d_poisson_convergence_p</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">nelements</span><span class="p">,</span> <span class="n">hs</span><span class="p">,</span> <span class="n">errors_l2_a</span><span class="p">],</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> 
                   <span class="n">header</span><span class="o">=</span><span class="s1">&#39;nelements, hs, l2errs&#39;</span><span class="p">)</span>
    
    <span class="c1"># Fit a line to the convergence data</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">errors_l2_a</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***********  order of accuracy p=</span><span class="si">{}</span><span class="s2">, order=</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    
    <span class="c1"># log-log plot of the error  </span>
    <span class="n">pl</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">hs</span><span class="p">,</span><span class="n">errors_l2_a</span><span class="p">,</span><span class="s1">&#39;o-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;p=</span><span class="si">{}</span><span class="s1">, order=</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    
    <span class="c1"># Test if the order of convergence is as expected</span>
    <span class="n">test_passes</span> <span class="o">=</span> <span class="n">test_passes</span> <span class="ow">and</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">+</span><span class="mf">0.9</span>

<span class="c1"># Tidy up the plot</span>
<span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;||e||_2&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Convergence&#39;</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_folder</span> <span class="o">/</span> <span class="s1">&#39;1d_poisson_convergence.pdf&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***********  convergence figure in output/poisson_convergence.pdf&quot;</span><span class="p">)</span>
<span class="c1"># Check if we passed the test</span>
<span class="k">assert</span><span class="p">(</span><span class="n">test_passes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ne =  10 , l2error =  0.0015918430698274603
ne =  20 , l2error =  0.0003981215373662135
ne =  40 , l2error =  9.95404347873047e-05
ne =  80 , l2error =  2.488573694825128e-05
ne =  160 , l2error =  6.221473700843889e-06
ne =  320 , l2error =  1.555370621288354e-06
***********  order of accuracy p=1, order=2.00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ne =  10 , l2error =  1.5754217848735496e-05
ne =  20 , l2error =  1.9698108556933277e-06
ne =  40 , l2error =  2.4624303785777827e-07
ne =  80 , l2error =  3.0780902343243206e-08
ne =  160 , l2error =  3.84762965731367e-09
ne =  320 , l2error =  4.813312843575689e-10
***********  order of accuracy p=2, order=3.00
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>***********  convergence figure in output/poisson_convergence.pdf
</pre></div>
</div>
<img alt="../_images/084cbbb965c8000c56db9334d56ed60822e0bce4086d4b633671d54fefae0f23.png" src="../_images/084cbbb965c8000c56db9334d56ed60822e0bce4086d4b633671d54fefae0f23.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../readme.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Overview</p>
      </div>
    </a>
    <a class="right-next"
       href="Poisson2D.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Poisson Example 2D</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#description">Description</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble">Preamble</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solution">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing">Testing</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Cian Wilson
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    <p class="last-updated">
  Last updated on Jun 02, 2024.
  <br/>
</p>
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>